/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2016 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","jquery.sap.global","sap/ui/fl/registry/ChangeRegistryItem","sap/ui/fl/registry/ChangeTypeMetadata","sap/ui/fl/registry/Settings","sap/ui/fl/changeHandler/HideControl","sap/ui/fl/changeHandler/MoveElements","sap/ui/fl/changeHandler/PropertyChange","sap/ui/fl/changeHandler/PropertyBindingChange","sap/ui/fl/changeHandler/UnhideControl","sap/ui/fl/changeHandler/StashControl","sap/ui/fl/changeHandler/UnstashControl"],function(U,q,C,a,S,H,M,P,b,c,d,e){"use strict";var f=function(){this._registeredItems={};this.initSettings();this.initDefaultActiveHandlers();};f._instance=undefined;f.prototype._oDefaultActiveChangeHandlers={};f.prototype._oDefaultChangeHandlers={"hideControl":H,"moveElements":M,"propertyChange":P,"propertyBindingChange":b,"unhideControl":c,"stashControl":d,"unstashControl":e};f.prototype.initDefaultHandler=function(s,o){var g={changeType:s,changeHandler:o};var h=this._createChangeRegistryItemForSimpleChange("defaultActiveForAllControls",g);this._oDefaultActiveChangeHandlers[s]=h;};f.prototype.initDefaultActiveHandlers=function(){this.initDefaultHandler("propertyChange",P);this.initDefaultHandler("propertyBindingChange",b);};f.getInstance=function(){if(!f._instance){f._instance=new f();}return f._instance;};f.prototype.hasRegisteredChangeHandlersForControl=function(s){var g=Object.keys(this._registeredItems);return g.indexOf(s)!==-1;};f.prototype.hasChangeHandlerForControlAndChange=function(s,g){if(!this.hasRegisteredChangeHandlersForControl(s)){return false;}var r=this._registeredItems[s];var h=Object.keys(r);return h.indexOf(g)!==-1;};f.prototype.registerControlsForChanges=function(m){var t=this;q.each(m,function(s,g){if(Array.isArray(g)){var o={};g.forEach(function(h){o[h.changeType]=h.changeHandler;});t._registerChangeHandlersForControl(s,o);}else{t._registerChangeHandlersForControl(s,g);}});};f.prototype._registerChangeHandlersForControl=function(s,o){var t=this;q.each(o,function(g,h){var i=t._getChangeHandler(g,h);var j={"changeType":g,"changeHandler":i};t.registerControlForSimpleChange(s,j);});};f.prototype._getChangeHandler=function(s,g){if(g==="default"){return this._oDefaultChangeHandlers[s];}else{return g;}};f.prototype.registerControlForSimpleChange=function(s,o){var g;if(!s){return;}if(!o||!o.changeType||!o.changeHandler){return;}g=this._createChangeRegistryItemForSimpleChange(s,o);if(g){this.addRegistryItem(g);}};f.prototype._createChangeRegistryItemForSimpleChange=function(s,o){var p,g,h;p={name:o.changeType,changeHandler:o.changeHandler};g=new a(p);p={changeTypeMetadata:g,controlType:s};h=new C(p);return h;};f.prototype.addRegistryItem=function(r){var s,g;if(!r){return;}s=r.getChangeTypeName();g=r.getControlType();this._registeredItems[g]=this._registeredItems[g]||{};this._registeredItems[g][s]=r;};f.prototype.removeRegistryItem=function(p){if(!p.changeTypeName&&!p.controlType){U.log.error("sap.ui.fl.registry.ChangeRegistry: ChangeType and/or ControlType required");return;}if(p.controlType&&p.changeTypeName){if(this._registeredItems[p.controlType]){if(Object.keys(this._registeredItems[p.controlType]).length===1){delete this._registeredItems[p.controlType];}else{delete this._registeredItems[p.controlType][p.changeTypeName];}}}else if(p.controlType){if(this._registeredItems[p.controlType]){delete this._registeredItems[p.controlType];}}else if(p.changeTypeName){for(var g in this._registeredItems){var h=this._registeredItems[g];delete h[p.changeTypeName];}}};f.prototype.getRegistryItems=function(p){var t=this;if(!p){U.log.error("sap.ui.fl.registry.ChangeRegistry: no parameters passed for getRegistryItems");}var s=p.changeTypeName;var g=p.controlType;if(!s&&!g){U.log.error("sap.ui.fl.registry.ChangeRegistry: Change Type Name and/or Control Type required");}var r=null;if(g&&s){var o=this._getOrLoadChangeHandler(g,s);if(o){r={};r[g]={};r[g][s]=o;}}else if(g){if(this._registeredItems[g]){r={};r[g]={};var h=Object.keys(this._registeredItems[g]);h.forEach(function(s){r[g][s]=t._getOrLoadChangeHandler(g,s);});}}else if(s){r={};for(g in this._registeredItems){if(this._registeredItems[g][s]){r[g]={};r[g][s]=t._getOrLoadChangeHandler(g,s);}}}this._filterChangeTypes(r,p.layer);return r;};f.prototype._getOrLoadChangeHandler=function(s,g){var o=this._registeredItems[s];if(o){var h=o[g];if(h){var i=h.getChangeTypeMetadata();var j=i.getChangeHandler();if(typeof j==="string"){q.sap.require(j);j=sap.ui.require(j);i._changeHandler=j;}return h;}}var D=this._oDefaultActiveChangeHandlers[g];if(D){return D;}return null;};f.prototype.initSettings=function(s){this._oSettings=S.getInstanceOrUndef(s);if(!this._oSettings){this._oSettings=new S({});}};f.prototype._filterChangeTypes=function(r,l){if(this._oSettings&&l&&r){var t=this;q.each(r,function(s,o){q.each(o,function(g,R){var i=t._oSettings.isChangeTypeEnabled(g,l);if(!i){U.log.warning("Change type "+g+" not enabled for layer "+l);delete o[g];}});});}};f.prototype.getDragInfo=function(s){var g=this._registeredItems[s];if(g){return g.getDragInfo();}return null;};return f;},true);
