/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/fl/Utils','sap/ui/dt/OverlayUtil','sap/ui/comp/odata/FieldSelectorModelConverter','sap/ui/fl/registry/Settings','sap/ui/comp/smartform/GroupElement','sap/ui/comp/smartform/Group','sap/ui/comp/smartfield/SmartField','sap/uxap/ObjectPageSection','sap/uxap/ObjectPageLayout','sap/ui/core/StashedControlSupport','sap/m/MessageBox','sap/ui/comp/odata/MetadataAnalyser','sap/ui/rta/model/ElementPreprocessor'],function(q,F,O,a,S,G,b,c,d,e,f,M,g,E){"use strict";var U={};U.RESOLVED_PROMISE=Promise.resolve(true);U._sFocusableOverlayClass=".sapUiDtOverlaySelectable";U.isExtensibilityEnabledInSystem=function(C){var s=F.getComponentClassName(C);if(!s||s==""){return Promise.resolve(false);}return S.getInstance(s).then(function(o){if(o.isModelS){return o.isModelS();}return false;});};function _(A,p){return A&&A.changeType&&A.aggregation===p.getAggregationName();}function h(D){if(D.getAggregations){for(var i in D.getAggregations()){if(D.getAggregation(i).actions){return true;}}}return false;}U.isEditable=function(o,m){var D=o.getDesignTimeMetadata();var i=o.getElementInstance();var C=i.getMetadata().getName();var p=o.getPublicParentAggregationOverlay();var P;if(!p){return false;}else{P=p.getDesignTimeMetadata();}var j=false;var s=false;var r;var R;var k;var l;var n=o.getPublicParentElementOverlay().getDesignTimeMetadata();if(n.getData().aggregations){var t=n.getAggregationAction("createContainer",i)[0];var A=n.getAggregationAction("addODataProperty",i)[0];if(_(t,p)||_(A,p)){j=true;}}if(!j&&D.getData().actions){r=D.getAction("rename",i);if(r&&r.changeType){j=true;}else{R=D.getAction("remove",i);if(R&&R.changeType){j=true;}else{k=D.getAction("reveal",i);if(k&&k.changeType){j=true;}else{l=D.getAction("settings",i);if(l){j=true;}}}}}if(!j&&P.getData().actions){r=P.getAction("rename",i);if(r&&r.changeType){j=true;}else if(P.getAction("move",m||i)){j=true;}else{R=P.getAction("remove",i);if(R&&R.changeType){j=true;}else{k=P.getAction("reveal",i);if(k&&k.changeType){j=true;}}}}if(!j){j=h(D);}if(!j){q.sap.require("sap.ui.rta.plugin.additionalElements.AdditionalElementsPlugin");j=sap.ui.rta.plugin.additionalElements.AdditionalElementsPlugin.hasRevealActionsOnChildren(o);}if(!j&&F.isVendorLayer()){j=["sap.ui.comp.smartfilterbar.SmartFilterBar","sap.ui.comp.smarttable.SmartTable","sap.uxap.ObjectPageHeader","sap.uxap.ObjectPageHeaderActionButton","sap.ui.table.Column"].indexOf(C)>-1;}if(j){var u;if(o.isInHiddenTree()){u=P.getData().getStableElements;}else{u=D.getData().getStableElements;}if(u){var v=u(i);var w=v?v.some(function(x){var y=x.id||x;if(!F.checkControlId(y,x.appComponent)){return true;}}):true;s=!w;}else{s=F.checkControlId(i);}}return j&&s;};U.hasParentStableId=function(o){var B=o.getPublicParentElementOverlay();var i=B?B.getElementInstance():null;return i&&F.checkControlId(i);};U.isServiceUpToDate=function(C){return this.isExtensibilityEnabledInSystem(C).then(function(i){if(i){q.sap.require("sap.ui.fl.fieldExt.Access");var m=C.getModel();if(m){var s=sap.ui.fl.fieldExt.Access.isServiceOutdated(m.sServiceUrl);if(s){sap.ui.fl.fieldExt.Access.setServiceValid(m.sServiceUrl);sap.ui.getCore().getEventBus().publish("sap.ui.core.UnrecoverableClientStateCorruption","RequestReload",{});return Promise.reject();}}}});};U.isCustomFieldAvailable=function(C){var t=this;return this.isExtensibilityEnabledInSystem(C).then(function(s){if(!s){return false;}else if(!C.getModel()){return false;}else{var j=C.getModel().sServiceUrl;var k=t.getBoundEntityType(C);try{q.sap.require("sap.ui.fl.fieldExt.Access");var J=sap.ui.fl.fieldExt.Access.getBusinessContexts(j,k);return Promise.resolve(J).then(function(r){if(r){if(r.BusinessContexts){if(r.BusinessContexts.length>0){r.EntityType=k;return r;}}}else{return false;}}).catch(function(o){if(o){if(q.isArray(o.errorMessages)){for(var i=0;i<o.errorMessages.length;i++){q.sap.log.error(o.errorMessages[i].text);}}}return false;});}catch(o){q.sap.log.error("exception occured in sap.ui.fl.fieldExt.Access.getBusinessContexts",o);return false;}}});};U.openRemoveConfirmationDialog=function(o,t){var T=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var s;return new Promise(function(r,i){s=T.getText("CTX_REMOVE_TITLE");var j={messageText:t,titleText:s,icon:"sap-icon://question-mark",removeText:T.getText("BTN_FREP_REMOVE"),cancelText:T.getText("BTN_FREP_CANCEL")};var m=new sap.ui.model.json.JSONModel();m.setData(j);var k;var C=function(){if(k){k.close();k.destroy();k=null;}};var l={removeField:function(){C();r(true);},closeDialog:function(){C();r(false);}};if(!k){k=sap.ui.xmlfragment("sap.ui.rta.view.RemoveElementDialog",l);k.setModel(m);}k.open();});};U.isMandatorySmartField=function(o){return(o instanceof c)&&o.getMandatory();};U.isOverlaySelectable=function(o){return o.isSelectable()&&o.$().is(":visible");};U.getPropertyValue=function(o,p){var m=o.getMetadata().getPropertyLikeSetting(p);var P=m._sGetter;return o[P]();};U.getOverlayInstanceForDom=function(D){var i=q(D).attr("id");if(i){return sap.ui.getCore().byId(i);}};U.getFocusedOverlay=function(){if(document.activeElement){var o=sap.ui.getCore().byId(document.activeElement.id);if(o instanceof sap.ui.dt.ElementOverlay){return o;}}};U.getFirstFocusableChildOverlay=function(o){var i=O.getFirstChildOverlay(o);while(i&&!this.isOverlaySelectable(i)){i=O.getNextSiblingOverlay(i);}return i;};U.getNextFocusableSiblingOverlay=function(o){var n=O.getNextSiblingOverlay(o);while(n&&!this.isOverlaySelectable(n)){n=O.getNextSiblingOverlay(n);}return n;};U.getPreviousFocusableSiblingOverlay=function(o){var p=O.getPreviousSiblingOverlay(o);while(p&&!this.isOverlaySelectable(p)){p=O.getPreviousSiblingOverlay(p);}return p;};U.getClosestTypeForControl=function(C,t){if(C&&C.getMetadata().getName()!==t){return this.getClosestTypeForControl(C.getParent(),t);}return C;};U._checkIsSupportedControl=function(C,s){for(var i=0;i<s.length;i++){if(C.getMetadata().getName()===s[i]){return true;}}};U.hasGroupElementUnBoundFields=function(o){var i=o.getFields();if(i.length===0){return true;}for(var j=0;j<i.length;j++){var k=i[j];if(!k.getDomRef()){continue;}if(!this._isElementBound(k)){return true;}}return false;};U._isElementBound=function(o){var B=o.mBindingInfos;if(Object.keys(B).length===0){return false;}else{for(var p in B){var P=B[p].parts;for(var i=0;i<P.length;i++){if(P[i].model){var m=o.getModel(P[i].model).getMetadata().getName();if(m==="sap.ui.model.odata.ODataModel"||m==="sap.ui.model.odata.v2.ODataModel"){return true;}}else{var m=o.getModel().getMetadata().getName();if(m==="sap.ui.model.odata.ODataModel"||m==="sap.ui.model.odata.v2.ODataModel"){return true;}}}}}};U.getObjectPageSections=function(o){var i;var s=[];var j=[];if(o.getMetadata().getName()==="sap.uxap.ObjectPageSection"){i=o.getParent();}else if(o.getMetadata().getName()==="sap.uxap.ObjectPageLayout"){i=o;}s=i.getAggregation("sections");j=f.getStashedControls(i.getId());s=s.concat(j);return s;};U.hasObjectPageLayoutInvisibleSections=function(o){var s=U.getObjectPageSections(o);if(s.length===0){return false;}for(var i=0;i<s.length;i++){if((s[i].getVisible&&s[i].getVisible()===false)||(s[i].getStashed&&s[i].getStashed()===true)){return true;}}return false;};U.getIndex=function(p,C,A,i){var I;if(i&&typeof i==="function"){I=i.call(null,p,C);}else{var m=p.getMetadata();var o=m.getAggregation(A);var s=o._sGetter;var j=p[s]();if(C){I=j.indexOf(C)+1;}else{I=j.length;}}return I;};U.determineTargetIndex=function(s,o,C,i){var j=o.getMetadata().getClass();var t=(s instanceof j)?C.length-i:C.indexOf(s)+1;return t;};U.findSupportedBlock=function(C,s){if(this._checkIsSupportedControl(C,s)){return C;}else{C=C.getParent();while(C){if(this._checkIsSupportedControl(C,s)){return C;}C=C.getParent();}}};U.createFieldLabelId=function(C,s,B){var i=C.getId()+"_"+s+"_"+B;i=i.replace("/","_");return i;};U.getLabelForElement=function(o,i){if(i){return i(o);}else{var s=o.getText&&o.getText();if(!s){s=o.getLabelText&&o.getLabelText();}if(!s){s=o.getLabel&&o.getLabel();if(s&&s.getText){s=s.getText();}}if(!s){s=o.getTitle&&o.getTitle();}if(!s){s=o.getId&&o.getId();}return(typeof s)==="string"?s:undefined;}};U.getPathFromBindingInfo=function(i,B){var p=B[i]?B[i]:undefined;if(p){if((p.parts instanceof Array)&&p.parts.length>0){p=p.parts[0]?p.parts[0]:undefined;}p=((typeof p.path)==="string")?p.path:p;}if((typeof p)==="string"){p=p;}else{p=undefined;}return p;};U.getBoundEntityType=function(o,m){var i=m?m:o.getModel();var B=o.getBindingContext();var j=i.oMetadata._getEntityTypeByPath(B.getPath());return j.name;};U.openNewWindow=function(u){window.open(u,"_blank");};U.fetchODataPropertiesFor=function(m){var t=this;if(!m){return new Promise(function(r,i){i();});}var o=m.getMetaModel();return o.loaded().then(function(){t._oMetadataAnalyzer=new g(m);var i=new E(t._oMetadataAnalyzer);var j=t._oMetadataAnalyzer.getAllEntityTypeNames();var A={};j.forEach(function(s){A[s]=t._oMetadataAnalyzer.getFieldsByEntityTypeName(s);});Object.keys(A).forEach(function(s){A[s]=i._updateAndFilterFields(A[s]);});return A;},function(r){q.sap.log.error("MetadataModel could not be loaded",r);});};U.getElementBindingPaths=function(o){var p={};if(o.mBindingInfos){for(var i in o.mBindingInfos){var P=o.mBindingInfos[i].parts[0].path?o.mBindingInfos[i].parts[0].path:"";P=P.split("/")[P.split("/").length-1];p[P]={valueProperty:i};}}return p;};U.findFieldBindingPathInFieldsArray=function(p,H){var P=Object.keys(p);var D=Object.keys(H);var s="";P.forEach(function(i){if(D.indexOf(i)>=0){s=D[D.indexOf(i)];}});return s;};U.createNewAddFieldsCommand=function(s,o,i,j,l,v,k){q.sap.require("sap.ui.rta.command.CommandFactory");var A=sap.ui.rta.command.CommandFactory.getCommandFor(o,"add",{newControlId:U.createNewSmartFormGroupElementId(s,k),index:i,jsTypes:j,labels:l,fieldValues:k,valuePropertys:v});return A;};U.createNewSmartFormGroupElementId=function(p,P){var s="";var t=P.slice();var j=t.sort();for(var i=0;i<j.length;i++){var k=j[i].replace("/","_");s=s+"__"+k;}return p.getId()+s;};return U;},true);
