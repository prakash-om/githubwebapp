/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/m/MessageBox','sap/ui/core/Control','sap/ui/layout/form/Form','sap/ui/layout/form/ResponsiveLayout','sap/ui/fl/Utils','sap/ui/fl/registry/Settings','sap/m/Label','sap/m/Title','sap/m/Button','sap/m/ButtonType','sap/m/Panel','sap/m/OverflowToolbar','sap/m/ToolbarSpacer','sap/m/ToolbarSeparator'],function(q,l,a,C,F,R,U,b,c,T,B,d,P,O,e,f){"use strict";var g=C.extend("sap.ui.comp.smartform.SmartForm",{metadata:{library:"sap.ui.comp",designTime:true,properties:{title:{type:"string",group:"Misc",defaultValue:null},useHorizontalLayout:{type:"boolean",group:"Misc",defaultValue:null},horizontalLayoutGroupElementMinWidth:{type:"int",group:"Misc",defaultValue:null},checkButton:{type:"boolean",group:"Misc",defaultValue:false},entityType:{type:"string",group:"Misc",defaultValue:null},expandable:{type:"boolean",group:"Misc",defaultValue:false},expanded:{type:"boolean",group:"Misc",defaultValue:null},editTogglable:{type:"boolean",group:"Misc",defaultValue:false},editable:{type:"boolean",group:"Misc",defaultValue:false},ignoredFields:{type:"string",group:"Misc",defaultValue:null},flexEnabled:{type:"boolean",group:"Misc",defaultValue:true}},defaultAggregation:"groups",aggregations:{groups:{type:"sap.ui.comp.smartform.Group",multiple:true,singularName:"group"},content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},layout:{type:"sap.ui.comp.smartform.Layout",multiple:false},semanticObjectController:{type:"sap.ui.comp.navpopover.SemanticObjectController",multiple:false},customToolbar:{type:"sap.m.Toolbar",multiple:false},toolbar:{type:"sap.m.Toolbar",multiple:false,visibility:"hidden"}},events:{editToggled:{},checked:{}}},renderer:function(r,o){var t=o._getCustomToolbar()||o._oToolbar;r.write("<div");r.writeControlData(o);r.addClass("sapUiCompSmartForm");r.writeClasses();r.write(">");if(o.mProperties["expandable"]){r.renderControl(o._oPanel);}else{if(t){r.renderControl(t);}r.renderControl(o._oForm);}r.write("</div>");}});g.prototype.init=function(){this._bisLayoutCreated=false;this._oForm=null;this._oPanel=null;this._oTitle=new T(this.getId()+"-title-sfmain").addStyleClass("title");this._bUpdateToolbar=true;this._sResizeListenerId="";this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");};g.prototype._resizeHandlerRegId="";g.prototype.onBeforeRendering=function(){this._updateToolbar();this._createLayout();this._updatePanel();if(this.getUseHorizontalLayout()&&this.getLayout()&&this.getLayout().getGridDataSpan()){this._propagateGridDataSpan();this._registerResizeHandler();}};g.prototype.addGroup=function(G){this.addAggregation("groups",G,true);};g.prototype.addAggregation=function(A,o){if(A==="groups"){this._insertGroup(o);}else{C.prototype.addAggregation.apply(this,arguments);}};g.prototype.getGroups=function(){var G=this.getAggregation('groups');return((G===null)?[]:G);};g.prototype.getAggregation=function(A){var r=null;if(A==="groups"){r=this._oForm?this._oForm.getFormContainers():[];}else{r=C.prototype.getAggregation.apply(this,arguments);}return r;};g.prototype._getLayout=function(){var L=this.getLayout();var o=null;var G=this.getGroups();if(L){o=new sap.ui.layout.form.ResponsiveGridLayout({"labelSpanXL":L.mProperties["labelSpanXL"]?L.mProperties["labelSpanXL"]:-1,"labelSpanL":L.mProperties["labelSpanL"]?L.mProperties["labelSpanL"]:4,"labelSpanM":L.mProperties["labelSpanM"]?L.mProperties["labelSpanM"]:4,"labelSpanS":L.mProperties["labelSpanS"]?L.mProperties["labelSpanS"]:12,"emptySpanXL":L.mProperties["emptySpanXL"]?L.mProperties["emptySpanXL"]:-1,"emptySpanL":L.mProperties["emptySpanL"]?L.mProperties["emptySpanL"]:0,"emptySpanM":L.mProperties["emptySpanM"]?L.mProperties["emptySpanM"]:0,"columnsXL":L.mProperties["columnsXL"]?L.mProperties["columnsXL"]:-1,"columnsL":L.mProperties["columnsL"]?L.mProperties["columnsL"]:3,"columnsM":L.mProperties["columnsM"]?L.mProperties["columnsM"]:2,"singleContainerFullSize":L.mProperties["singleGroupFullSize"],"breakpointXL":L.mProperties["breakpointXL"]?L.mProperties["breakpointXL"]:1440,"breakpointL":L.mProperties["breakpointL"]?L.mProperties["breakpointL"]:1024,"breakpointM":L.mProperties["breakpointL"]?L.mProperties["breakpointL"]:600});}else{o=new sap.ui.layout.form.ResponsiveGridLayout({"labelSpanL":4,"labelSpanM":4,"emptySpanL":0,"emptySpanM":0,"columnsL":3,"columnsM":2,"breakpointL":1024,"breakpointM":600});}if(G&&G.length>0&&G.length<o.getColumnsL()&&o.mProperties["singleContainerFullSize"]){o.setColumnsL(G.length);}return o;};g.prototype._createToolbar=function(){if(this._oToolbar){var o=this._oToolbar.removeContent(this._oToolbar.getId()+"-button-sfmain-editToggle");if(o){o.destroy();this._oEditToggleButton=null;}o=this._oToolbar.removeContent(this.getId()+"-"+this._oToolbar.getId()+"-button-sfmain-check");if(o){o.destroy();}o=this._oToolbar.removeContent(this.getId()+"-"+this._oToolbar.getId()+"-AdaptationButton");if(o){o.destroy();}this._oToolbar.removeContent(this.getId()+"-title-sfmain");this._oToolbar.destroy();}this._oToolbar=new O(this.getId()+"-toolbar-sfmain",{"height":"3rem","design":sap.m.ToolbarDesign.Transparent});this.setAggregation("toolbar",this._oToolbar);};g.prototype._updateToolbar=function(){var o=this._getCustomToolbar();if(this._bUpdateToolbar){if(o){this._cleanToolbar();this._addHeaderToToolbar();this._addSeparatorToToolbar();this._addEditTogglableToToolbar();this._addCheckToToolbar();this._addChangeModeToToolbar();this._removeSeparatorFromToolbar();}else{this._createToolbar();this._addHeaderToToolbar();this._addEditTogglableToToolbar();this._addCheckToToolbar();this._addChangeModeToToolbar();if(this._oToolbar.getContent().length===1&&!this.getExpandable()){this._oToolbar.destroy();this._oToolbar=null;this.setAggregation("toolbar",null);}}this._bUpdateToolbar=false;}};g.prototype._getToolbar=function(){var o=this._getCustomToolbar();return o||this._oToolbar;};g.prototype._updatePanel=function(){var t=this._getToolbar();if(this.mProperties["expandable"]){this._oPanel.setExpanded(this.mProperties["expanded"]);this._oPanel.setHeaderToolbar(t);}};g.prototype._cleanToolbar=function(){var o=this._getCustomToolbar();var h=o.removeContent(o.getId()+"-button-sfmain-editToggle");if(h){h.destroy();this._oEditToggleButton=null;}h=o.removeContent(this.getId()+"-"+o.getId()+"-button-sfmain-check");if(h){h.destroy();}h=o.removeContent(this.getId()+"-"+o.getId()+"-AdaptationButton");if(h){h.destroy();}o.removeContent(this.getId()+"-title-sfmain");};g.prototype._addHeaderToToolbar=function(){var o=this._getCustomToolbar();var t=o||this._oToolbar;var h=[];var i=0;var j=null;if(this.getTitle()||this.mBindingInfos['title']){t.insertContent(this._oTitle,0);}if(this._oToolbar){t.insertContent(new e(),1);}else{h=t.getContent();for(i;i<h.length;i++){if(h[i].getMetadata().getName()==="sap.m.ToolbarSpacer"){j=h[i];}}if(!j){t.addContent(new e());}}};g.prototype._addEditTogglableToToolbar=function(){var o=this._getCustomToolbar();var t=o||this._oToolbar;var h=this;var i=this.getEditable()?"sap-icon://display":"sap-icon://edit";var s=this._oRb.getText(this.getEditable()?"FORM_TOOLTIP_DISPLAY":"FORM_TOOLTIP_EDIT");if(this.getEditTogglable()){if(!this._oEditToggleButton){this._oEditToggleButton=new B(t.getId()+"-button-sfmain-editToggle",{type:d.Default,icon:i,tooltip:s,press:function(){h._toggleEditMode();}});}t.addContent(this._oEditToggleButton);}};g.prototype._propagateGridDataSpan=function(){var G,s="",L=this.getLayout(),v;if(L){s=L.getGridDataSpan();}G=this.getGroups();G.forEach(function(o){var E=o.getGroupElements();E.forEach(function(h){var L=h.getFields()[0].getLayoutData();if(L){if(L instanceof sap.m.FlexItemData){v=new sap.ui.core.VariantLayoutData({multipleLayoutData:[L,new sap.ui.layout.GridData({span:s})]});h.getFields()[0].setLayoutData(v);}else if(L instanceof sap.ui.layout.GridData){L.setSpan(s);}else if(L instanceof sap.ui.core.VariantLayoutData){L.getMultipleLayoutData().forEach(function(L){if(L instanceof sap.ui.layout.GridData){L.setSpan(s);}});}}else{L=new sap.ui.layout.GridData({span:s});h.getFields()[0].setLayoutData(L);}if(h.getFields()[0]instanceof sap.m.VBox){var S=h.getFields()[0].getItems()[1];if(S&&S.setControlContext){S.setControlContext(sap.ui.comp.smartfield.ControlContextType.SmartFormGrid);}}});});};g.prototype.propagateGridDataSpan=function(){this._propagateGridDataSpan();return this;};g.prototype._registerResizeHandler=function(){if(this._resizeHandlerRegId){return;}var t=this;var r=function(){var G=t.getGroups();G.forEach(function(o){o._updateLineBreaks();});};this._resizeHandlerRegId=sap.ui.core.ResizeHandler.register(this._oForm,r);};g.prototype._getCurrentSpan=function(){var s=this.getLayout().getGridDataSpan();var i=0;var r=[];if(this.getDomRef()&&this._oForm){if(this.getDomRef().clientWidth>this._oForm.getLayout().getBreakpointL()){var L=/L([1-9]|1[0-2])/i;r=L.exec(s);i=r[1];}else if(this.getDomRef().clientWidth>this._oForm.getLayout().getBreakpointM()){var M=/M([1-9]|1[0-2])/i;r=M.exec(s);i=r[1];}else{var S=/S([1-9]|1[0-2])/i;r=S.exec(s);i=r[1];}}return i;};g.prototype._toggleEditMode=function(){var E=this.getEditable();this.setEditable(!E);};g.prototype._addChangeModeToToolbar=function(){if(!b.isFlexChangeMode()){return Promise.resolve();}var i=!!this._getContainingDialog(this);if(i||b.isFlexibilityAdaptationButtonAllowed()){return this._getAddChangeModelToToolbarPromise();}};g.prototype._getAddChangeModelToToolbarPromise=function(){var t=this;var i=this.getFlexEnabled();if(i){var s=U.getComponentClassName(this);var p={appDescriptor:U.getAppDescriptor(this),siteId:U.getSiteId(this)};return b.getInstance(s,p).then(function(S){if(S.isKeyUser()&&U.checkControlId(t)){t._setToolbarAndAddContent();}});}else{return Promise.resolve();}};g.prototype._setToolbarAndAddContent=function(){var o=this._getCustomToolbar();var t=o||this._oToolbar;if(!t||t.bIsDestroyed){this._createToolbar();this._oToolbar.addStyleClass("titleBar");this._addHeaderToToolbar();t=this._oToolbar;this.invalidate();}t.addContent(new B(this.getId()+"-"+t.getId()+"-AdaptationButton",{type:d.Default,icon:"sap-icon://wrench",tooltip:this._oRb.getText("FORM_TOOLTIP_SETTINGS"),press:this._handleAdaptationButtonPress.bind(this)}));};g.prototype._handleAdaptationButtonPress=function(E){var A=E.getSource();A.setEnabled(false);q.sap.require("sap.ui.rta.RuntimeAuthoring");var r=new sap.ui.rta.RuntimeAuthoring({rootControl:this._getContainingDialog(this)});r.attachStop(function(A){A.setEnabled(true);}.bind(this,A));r.start();};g.prototype._getContainingDialog=function(o){if(!o){return undefined;}if(o.getMetadata&&o.getMetadata().getName()==="sap.m.Dialog"){return o;}return this._getContainingDialog(o.getParent());};g.prototype._addCheckToToolbar=function(){if(!this.getEditable()){return;}var o=this._getCustomToolbar();var t=o||this._oToolbar;var h=this;if(this.getCheckButton()){t.addContent(new B(this.getId()+"-"+t.getId()+"-button-sfmain-check",{type:d.Default,text:this._oRb.getText("SMART_FORM_CHECK"),press:function(){var E=[];E=h.check();h.fireChecked({erroneousFields:E});}}));}};g.prototype.check=function(h){if(h===undefined){h=true;}var E=this._checkClientError(h);return E;};g.prototype._checkClientError=function(h){if(h===undefined){h=true;}var i=this.getSmartFields(h);var E=[];var G=null;i.forEach(function(o){if(o.checkClientError()){if(h&&o.getVisible){if(!o.getVisible()){return;}}G=o.getParent();while(G.getParent){G=G.getParent();if(G instanceof sap.ui.comp.smartform.Group){if(!G.getExpanded()){G.setExpanded(true);}break;}}E.push(o.getId());}});return E;};g.prototype._addSeparatorToToolbar=function(){var o=this._getCustomToolbar();var t=o||this._oToolbar;t.addContent(new f());};g.prototype._removeSeparatorFromToolbar=function(){var o=this._getCustomToolbar();var t=o||this._oToolbar;var h=t.getContent();var L=null;var r=[];var i=0;L=h[h.length-1];if(L.getMetadata().getName()==="sap.m.ToolbarSeparator"){t.removeContent(L);}L=null;for(i;i<h.length;i++){if(h[i].getMetadata().getName()==="sap.m.ToolbarSeparator"&&L.getMetadata().getName()!="sap.m.Button"){r.push(h[i]);}L=h[i];}for(i=0;i<r.length;i++){t.removeContent(r[i]);}};g.prototype._displayError=function(E){var s,h;h=this._oRb.getText("FORM_CLIENT_CHECK_ERROR_TITLE");s=this._oRb.getText("FORM_CLIENT_CHECK_ERROR");a.show(s,{icon:a.Icon.ERROR,title:h,styleClass:(this.$()&&this.$().closest(".sapUiSizeCompact").length)?"sapUiSizeCompact":""});};g.prototype.setEditable=function(E){var t;var o=this.getEditable();if(o===E){return this;}if(!E&&this.hasListeners("editToggled")){var h=[];h=this.check(true);if(h&&h.length>0){this._displayError(h);return this;}}this.setProperty("editable",E);if(this._oForm){this._oForm.setEditable(E);}this.fireEditToggled({editable:E});if(this._oEditToggleButton){this._oEditToggleButton.setIcon(E?"sap-icon://display":"sap-icon://edit");t=this._oRb.getText(E?"FORM_TOOLTIP_DISPLAY":"FORM_TOOLTIP_EDIT");this._oEditToggleButton.setTooltip(t);}var G=this.getGroups();G.forEach(function(i){i.setEditMode(E);});this._bUpdateToolbar=true;return this;};g.prototype.setEditTogglable=function(t){this.setProperty("editTogglable",t);this._bUpdateToolbar=true;return this;};g.prototype.setTitle=function(t){C.prototype.setProperty.apply(this,["title",t]);this._oTitle.setText(t);return this;};g.prototype.setUseHorizontalLayout=function(u){var o=this.getProperty("useHorizontalLayout");if(o!==u){this.setProperty("useHorizontalLayout",u);if(u){this.addStyleClass("sapUiCompSmartFormHorizontalLayout");}else{this.removeStyleClass("sapUiCompSmartFormHorizontalLayout");}var G=this.getGroups();if(G){G.forEach(function(h){h.setUseHorizontalLayout(u);});}this._bisLayoutCreated=false;}return this;};g.prototype.setHorizontalLayoutGroupElementMinWidth=function(n){this.setProperty("horizontalLayoutGroupElementMinWidth",n);var G=this.getGroups();if(G){G.forEach(function(o){o.setHorizontalLayoutGroupElementMinWidth(n);});}return this;};g.prototype.getVisibleProperties=function(){var p=[];var G=this.getGroups();if(G){G.forEach(function(o){var h=o.getGroupElements();if(h){h.forEach(function(i){var j=i.getFields();if(j){j.forEach(function(k){if(k.getVisible()){var s=k.getBindingPath("value");if(s){p.push(s);}}});}});}});}return p;};g.prototype.setCustomToolbar=function(o){if(o){o.data('bIsSmartFormCustomToolbar',true);}this.setAggregation("customToolbar",o);if(o){this._bUpdateToolbar=true;}return this;};g.prototype.getCustomToolbar=function(){var o=this._getCustomToolbar();return o;};g.prototype._getCustomToolbar=function(){var o=this.getAggregation("customToolbar");if(!o&&this._oPanel){o=this._oPanel.getHeaderToolbar();if(o&&!o.data('bIsSmartFormCustomToolbar')){o=null;}}return o;};g.prototype.insertGroup=function(G,i){this.insertAggregation("groups",G,i);return this;};g.prototype.insertAggregation=function(A,o,i){if(A==="groups"){this._insertGroup(o,i);}else{C.prototype.insertAggregation.apply(this,arguments);}};g.prototype.removeGroup=function(G){this.removeAggregation("groups",G);return this;};g.prototype.removeAggregation=function(A,o){if(A==="groups"){return this._oForm.removeFormContainer(o);}else{return C.prototype.removeAggregation.apply(this,arguments);}};g.prototype.removeAllAggregation=function(A){if(A==="groups"){return this.removeAllGroups();}else{return C.prototype.removeAllAggregation.apply(this,arguments);}};g.prototype.destroyGroups=function(){this.destroyAggregation("groups");return this;};g.prototype.destroyAggregation=function(A){if(A==="groups"){this._oForm.destroyFormContainers();}else{C.prototype.destroyAggregation.apply(this,arguments);}};g.prototype._createForm=function(){if(!this._oForm){this._oForm=new F({"editable":this.getEditable()});if(this.mProperties["expandable"]){if(!this._oPanel){this._oPanel=new P({"expanded":this.mProperties["expanded"],"expandable":true,"headerText":this.getTitle()});this.setAggregation("content",this._oPanel);this._oPanel.attachExpand(function(E){this.setProperty("expanded",E.getParameters()["expand"],false);}.bind(this));}this._oPanel.addContent(this._oForm);}else{this.setAggregation("content",this._oForm);}}};g.prototype._createLayout=function(){var L=null;this._createForm();if(!this._bisLayoutCreated&&this._oForm){L=this._oForm.getLayout();if(L){L.destroy();}if(this.mProperties["useHorizontalLayout"]){if(this.getLayout()&&this.getLayout().getGridDataSpan()){L=new sap.ui.layout.form.ResponsiveGridLayout({columnsL:1,columnsM:1});if(this.getLayout().getBreakpointM()>0){L.setBreakpointM(this.getLayout().getBreakpointM());}if(this.getLayout().getBreakpointL()>0){L.setBreakpointM(this.getLayout().getBreakpointL());}}else{L=new sap.ui.layout.form.ResponsiveLayout();}}else{L=this._getLayout();}this._oForm.setLayout(L);this._bisLayoutCreated=true;}};g.prototype._addCustomData=function(G){var h=null;if(G){h=this.getCustomData();if(h&&h.length>0){h.forEach(function(o){G.addCustomData(o.clone());});}}};g.prototype._delegateEditMode=function(G){if(G){G.setEditMode(this.mProperties["editable"]);}};g.prototype._insertGroup=function(G,i){this._createForm();if(i===undefined||i===null){i=this._oForm.getFormContainers().length;}else if(i===-1){i=0;}G.setHorizontalLayoutGroupElementMinWidth(this.getHorizontalLayoutGroupElementMinWidth());G.setUseHorizontalLayout(this.getUseHorizontalLayout());this._addCustomData(G);this._delegateEditMode(G);this._oForm.insertFormContainer(G,i);};g.prototype.removeAllGroups=function(){if(this._oForm){return this._oForm.removeAllFormContainers();}};g.prototype.updateAggregation=function(A){C.prototype.updateAggregation.apply(this,arguments);if(A==="groups"){this._updateClonedElements(this);}};g.prototype.getSmartFields=function(h){var G=[];var i=[];var E=[];var j=[];var s=[];if(h===undefined){h=true;}G=this.getGroups();G.forEach(function(o){if(!h||(h&&o.getVisible())){i=o.getGroupElements();i.forEach(function(k){j=[];E=k.getElements();j=k._extractFields(E,true);j=j.filter(function(m){return m instanceof sap.ui.comp.smartfield.SmartField;});s=s.concat(j);});}});return s;};g.prototype.setFocusOnEditableControl=function(){var h=[];this.getGroups().forEach(function(G){G.getGroupElements().forEach(function(o){h=h.concat(o.getElements());});});while(h.some(function(o){return o instanceof sap.m.FlexBox;})){for(var i=0;i<h.length;i++){if(h[i]instanceof sap.m.FlexBox){Array.prototype.splice.apply(h,[i,1].concat(h[i].getItems()));}}}h.some(function(o){if(o.getEditable&&o.getEditable()&&o.focus){if(o instanceof sap.ui.comp.smartfield.SmartField){o.attachEventOnce("innerControlsCreated",function(E){q.sap.delayedCall(0,E.oSource._oControl[E.oSource._oControl.current],"focus");});}else{o.focus();}return true;}});};g.prototype.clone=function(I,L){var o=C.prototype.clone.apply(this,arguments);var A=this.getMetadata().getAggregations();var s;var h;for(s in A){h=this.getAggregation(s);if(this.getMetadata().hasAggregation(s)&&!this.isBound(s)&&((o.getAggregation(s)===null)||o.getAggregation(s).length===0)){if(h instanceof sap.ui.base.ManagedObject){o.addAggregation(s,h.clone(I,L));}else if(q.isArray(h)){for(var i=0;i<h.length;i++){o.addAggregation(s,h[i].clone(I,L));}if(s==="groups"){this._updateClonedElements(o);}}else if(h!=null){o.setAggregation(s,h.clone(I,L));}}}return o;};g.prototype._updateClonedElements=function(s){var o=null,L=null;var G=[];var E=[];var h=[];var i=s.getGroups();i.forEach(function(j){G=j.getGroupElements();G.forEach(function(k){o=k._getFieldRelevantForLabel();L=k._getLabel();if(o&&L){L.setLabelFor(o);}E=k.getElements();h=[];h=k._extractFields(E,true);h.forEach(function(o){if(o.getEditable){if(!o.getEditable()){o.data("editable",false);}}if(o.attachVisibleChanged){o.attachVisibleChanged(function(m){k._updateFormElementVisibility();});}if(o.attachContextEditableChanged){o.attachContextEditableChanged(function(m){k._updateFormElementEditable(m);});}if(o.attachInnerControlsCreated){o.attachInnerControlsCreated(function(m){k._updateFormElementLabel(m);});}});});});};g.prototype.exit=function(){if(this._oForm){this._oForm.destroy();}if(this._oPanel){this._oPanel.destroy();}if(this._oTitle){this._oTitle.destroy();}if(this._oToolbar){this._oToolbar.destroy();}if(this._oEditToggleButton){this._oEditToggleButton.destroy();}this._oForm=null;this._oPanel=null;this._oTitle=null;this._bUpdateToolbar=true;this._sResizeListenerId="";this._oRb=null;this._oToolbar=null;this._oEditToggleButton=null;if(this._resizeHandlerRegId){sap.ui.core.ResizeHandler.deregister(this._resizeHandlerRegId);this._resizeHandlerRegId="";}};return g;},true);
