/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','./BaseController','sap/m/library','sap/ui/comp/library','./ChartWrapper','./Util'],function(q,B,M,C,c,U){"use strict";var D=B.extend("sap.ui.comp.personalization.DimeasureController",{constructor:function(i,s){B.apply(this,arguments);this.setType(sap.m.P13nPanelType.dimeasure);},metadata:{events:{afterDimeasureModelDataChange:{}}}});D.prototype.setTable=function(t){B.prototype.setTable.apply(this,arguments);if(!(t instanceof c)){throw"The provided object is incorrect. 'oTable' has to be an instance of sap.ui.comp.personalization.ChartWrapper. ";}var o=t.getChartObject();o.detachDrilledDown(this._onDrilledDown,this);o.attachDrilledDown(this._onDrilledDown,this);o.detachDrilledUp(this._onDrilledUp,this);o.attachDrilledUp(this._onDrilledUp,this);var a=this;var s=q.proxy(o.setChartType,o);var S=function(b){s(b);var m=a.getModel("$sapuicomppersonalizationBaseController");var d=m.getData();if(b&&b!==d.persistentData.dimeasure.chartTypeKey){a.fireBeforePotentialTableChange();d.persistentData.dimeasure.chartTypeKey=b;a.fireAfterPotentialTableChange();a.fireAfterDimeasureModelDataChange();}};if(o.setChartType.toString()===S.toString()){return;}o.setChartType=S;};D.prototype._onDrilledDown=function(e){this._updateModel(e.getSource());};D.prototype._onDrilledUp=function(e){this._updateModel(e.getSource());};D.prototype._updateModel=function(o){var m=this.getModel("$sapuicomppersonalizationBaseController");var d=m.getData();var a=this.getColumnMap();this.fireBeforePotentialTableChange();d.persistentData.dimeasure.dimeasureItems=[];o.getVisibleDimensions().forEach(function(s){var b=a[s];d.persistentData.dimeasure.dimeasureItems.push({columnKey:s,index:d.persistentData.dimeasure.dimeasureItems.length,visible:true,role:b.getRole()});});o.getVisibleMeasures().forEach(function(s){var b=a[s];d.persistentData.dimeasure.dimeasureItems.push({columnKey:s,index:d.persistentData.dimeasure.dimeasureItems.length,visible:true,role:b.getRole()});});m.refresh();this.fireAfterPotentialTableChange();this.fireAfterDimeasureModelDataChange();};D.prototype.createPersistentStructure=function(i){var p=B.prototype.createPersistentStructure.apply(this,arguments);p.dimeasure.chartTypeKey="";return p;};D.prototype.onAfterSubmit=function(p){if(!p||!p.dimeasure){return;}var d=this.getModel("$sapuicomppersonalizationBaseController").getData();d.persistentData.dimeasure.dimeasureItems=[];p.dimeasure.dimMeasureItems.forEach(function(o){d.persistentData.dimeasure.dimeasureItems.push({columnKey:o.getColumnKey(),index:o.getIndex(),visible:o.getVisible(),role:o.getRole()});});d.persistentData.dimeasure.chartTypeKey=p.dimeasure.chartTypeKey;this.getModel("$sapuicomppersonalizationBaseController").refresh();B.prototype.onAfterSubmit.apply(this,arguments);};D.prototype.syncJsonModel2Table=function(j){var t=this.getTable();var o=t.getChartObject();var d=[];var m=[];var u=function(e,s,S,g){var f=U.copy(e);f.sort(function(a,b){if(a.index<b.index){return-1;}else if(a.index>b.index){return 1;}else{return 0;}});var h=[];f.forEach(function(a){if(a.visible===true){h.push(a.columnKey);var b=g(a.columnKey);if(b){b.setRole(a.role);}}});if(JSON.stringify(h)!==JSON.stringify(s)){S(h);}};this.fireBeforePotentialTableChange();U.splitDimeasures(j.dimeasure.dimeasureItems,this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.dimeasure.items,d,m);var v=o.getVisibleDimensions();u(d,v,q.proxy(o.setVisibleDimensions,o),q.proxy(o.getDimensionByName,o));var V=o.getVisibleMeasures();u(m,V,q.proxy(o.setVisibleMeasures,o),q.proxy(o.getMeasureByName,o));o.setChartType(j.dimeasure.chartTypeKey);this.fireAfterPotentialTableChange();};D.prototype._getTable2Json=function(){var j=this.createPersistentStructure();var t=this.getTable();if(!t){return j;}var o=t.getChartObject();var v=o.getVisibleDimensions();var V=o.getVisibleMeasures();var a=this.getColumnMap(true);j.dimeasure.chartTypeKey=o.getChartType();v.forEach(function(d){var b=a[d];if(!b){return;}if(b.getAggregationRole()!==sap.ui.comp.personalization.AggregationRole.Dimension&&b.getAggregationRole()!==sap.ui.comp.personalization.AggregationRole.Measure){return;}j.dimeasure.dimeasureItems.push({columnKey:d,index:j.dimeasure.dimeasureItems.length,visible:true,role:b.getRole()});});V.forEach(function(m){var b=a[m];if(!b){return;}if(b.getAggregationRole()!==sap.ui.comp.personalization.AggregationRole.Dimension&&b.getAggregationRole()!==sap.ui.comp.personalization.AggregationRole.Measure){return;}j.dimeasure.dimeasureItems.push({columnKey:m,index:j.dimeasure.dimeasureItems.length,visible:true,role:b.getRole()});},this);return j;};D.prototype._getTable2JsonRestore=function(){return this._getTable2Json();};D.prototype.syncTable2TransientModel=function(){var i=[];var t=this.getTable();if(!t){return;}var o=this.getColumnMap(true);for(var s in o){var a=o[s];if(a.getAggregationRole()===sap.ui.comp.personalization.AggregationRole.NotDimeasure){continue;}i.push({columnKey:s,text:a.getLabel(),tooltip:a.getTooltip(),aggregationRole:a.getAggregationRole()});}var I=this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.dimeasure.items;if(q(i).not(I).length!==0||q(I).not(i).length!==0){this.getModel("$sapuicomppersonalizationBaseController").getData().transientData.dimeasure.items=i;}};D.prototype.getPanel=function(p){sap.ui.getCore().loadLibrary("sap.m");q.sap.require("sap/m/P13nDimMeasurePanel");q.sap.require("sap/m/P13nItem");q.sap.require("sap/m/P13nDimMeasureItem");var t=this;var a=[];if(p&&p.availableChartTypes){a=p.availableChartTypes;}var P=new sap.m.P13nDimMeasurePanel({availableChartTypes:a,chartTypeKey:"{$sapmP13nPanel>/persistentData/dimeasure/chartTypeKey}",items:{path:'$sapmP13nPanel>/transientData/dimeasure/items',template:new sap.m.P13nItem({columnKey:'{$sapmP13nPanel>columnKey}',text:'{$sapmP13nPanel>text}',tooltip:'{$sapmP13nPanel>tooltip}',aggregationRole:'{$sapmP13nPanel>aggregationRole}'})},dimMeasureItems:{path:"$sapmP13nPanel>/persistentData/dimeasure/dimeasureItems",template:new sap.m.P13nDimMeasureItem({columnKey:"{$sapmP13nPanel>columnKey}",index:"{$sapmP13nPanel>index}",visible:"{$sapmP13nPanel>visible}",role:"{$sapmP13nPanel>role}"})},beforeNavigationTo:t.setModelFunction()});return P;};D.prototype._isDimMeasureItemEqual=function(d,o){if(!d&&!o){return true;}if(d&&!o){if(d.index===-1&&d.visible===false){return true;}return false;}if(o&&!d){if(o.index===-1&&o.visible===false){return true;}return false;}for(var p in d){if(o[p]===undefined||d[p]!==o[p]){return false;}}return true;};D.prototype._isSemanticEqual=function(p,P){if(p.dimeasure.chartTypeKey!==P.dimeasure.chartTypeKey){return false;}var s=function(a,b){if(a.visible===true&&(b.visible===false||b.visible===undefined)){return-1;}else if((a.visible===false||a.visible===undefined)&&b.visible===true){return 1;}else if(a.visible===true&&b.visible===true){if(a.index<b.index){return-1;}else if(a.index>b.index){return 1;}else{return 0;}}else if((a.visible===false||a.visible===undefined)&&(b.visible===false||b.visible===undefined)){if(a.columnKey<b.columnKey){return-1;}else if(a.columnKey>b.columnKey){return 1;}else{return 0;}}};var d=U.copy(p.dimeasure.dimeasureItems).sort(s);var e=U.copy(P.dimeasure.dimeasureItems).sort(s);var i=true;d.some(function(o,I){if(!this._isDimMeasureItemEqual(o,e[I])){i=false;return true;}},this);return i;};D.prototype.getChangeType=function(p,P){if(!P||!P.dimeasure||!P.dimeasure.dimeasureItems){return sap.ui.comp.personalization.ChangeType.Unchanged;}return this._isSemanticEqual(p,P)?sap.ui.comp.personalization.ChangeType.Unchanged:sap.ui.comp.personalization.ChangeType.TableChanged;};D.prototype.getChangeData=function(p,P){if(!p||!p.dimeasure||!p.dimeasure.dimeasureItems){return this.createPersistentStructure();}if(!P||!P.dimeasure||!P.dimeasure.dimeasureItems){return{chartTypeKey:p.dimeasure.chartTypeKey,dimeasure:U.copy(p.dimeasure)};}if(!this._isSemanticEqual(p,P)){return{chartTypeKey:p.dimeasure.chartTypeKey,dimeasure:U.copy(p.dimeasure)};}return null;};D.prototype.getUnionData=function(d,o){if(!o||!o.dimeasure||!o.dimeasure.dimeasureItems){return{chartTypeKey:d.dimeasure.chartTypeKey,dimeasure:U.copy(d.dimeasure)};}return{dimeasure:{chartTypeKey:o.dimeasure.chartTypeKey?o.dimeasure.chartTypeKey:d.dimeasure.chartTypeKey,dimeasureItems:U.copy(o.dimeasure.dimeasureItems)}};};D.prototype.determineNeededColumnKeys=function(p){var n=[];if(!p||!p.dimeasure||!p.dimeasure.dimeasureItems){return{dimeasure:[]};}p.dimeasure.dimeasureItems.forEach(function(m){n.push(m.columnKey);});return{dimeasure:n};};D.prototype.exit=function(){B.prototype.exit.apply(this,arguments);var t=this.getTable();if(t){var o=t.getChartObject();if(o){o.detachDrilledDown(this._onDrilledDown,this);o.detachDrilledUp(this._onDrilledUp,this);}}};return D;},true);
