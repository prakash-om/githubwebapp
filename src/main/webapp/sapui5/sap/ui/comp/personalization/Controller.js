/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/ManagedObject','./ColumnsController','./FilterController','./GroupController','./SortController','./DimeasureController','./Util','sap/ui/comp/library','./ChartWrapper','./ColumnHelper','sap/ui/core/MessageType'],function(q,M,C,F,G,S,D,U,a,b,c,d){"use strict";var e=M.extend("sap.ui.comp.personalization.Controller",{constructor:function(i,s){M.apply(this,arguments);},metadata:{publicMethods:["setPersonalizationData"],properties:{setting:{type:"object",defaultValue:{}},resetToInitialTableState:{type:"boolean",defaultValue:true},columnKeys:{type:"string[]",defaultValue:[]}},associations:{table:{type:"object",multiple:false}},events:{beforePotentialTableChange:{},afterPotentialTableChange:{},afterP13nModelDataChange:{parameters:{changeReason:{type:"sap.ui.comp.personalization.ResetType"},persistentData:{type:"object"},changeData:{type:"object"},changeType:{type:"sap.ui.comp.personalization.ChangeType"},changeTypeVariant:{type:"sap.ui.comp.personalization.ChangeType"},changeTypeRestore:{type:"sap.ui.comp.personalization.ChangeType"}}},requestColumns:{parameters:{columnKeys:{type:"string"}}}},library:"sap.ui.comp"}});e.prototype.setTable=function(t){if(this._bInitCalled){throw"The table instance should be passed only into constructor.";}this.setAssociation("table",t);return this;};e.prototype.setSetting=function(s){if(this._bInitCalled){throw"The setting instance should be passed only into constructor.";}s=this.validateProperty("setting",s);this.setProperty("setting",s,true);return this;};e.prototype.setColumnKeys=function(f){if(this._bInitCalled){throw"The columnKeys array should be passed only into constructor.";}f=this.validateProperty("columnKeys",f);this.setProperty("columnKeys",f,true);return this;};e.prototype.setResetToInitialTableState=function(r){if(this._bInitCalled){throw"The resetToInitialTableState property should be passed only into constructor.";}r=this.validateProperty("resetToInitialTableState",r);this.setProperty("resetToInitialTableState",r,true);return this;};e.prototype._mergeSettingCurrentBy=function(s){this._oSettingCurrent=this.getTable()instanceof b?U.copy(this._oSettingOriginalChart):U.copy(this._oSettingOriginalTable);for(var t in s){if(s[t].visible===false){delete this._oSettingCurrent[t];continue;}if(this._oSettingCurrent[t]&&this._oSettingCurrent[t].visible===true){this._oSettingCurrent[t].controller=s[t].controller?s[t].controller:this._oSettingCurrent[t].controller;this._oSettingCurrent[t].payload=s[t].payload?s[t].payload:undefined;this._oSettingCurrent[t].ignoreColumnKeys=s[t].ignoreColumnKeys?s[t].ignoreColumnKeys:[];this._oSettingCurrent[t].triggerModelChangeOnColumnInvisible=s[t].triggerModelChangeOnColumnInvisible?s[t].triggerModelChangeOnColumnInvisible:undefined;}else{this._oSettingCurrent[t]={visible:s[t].visible,controller:s[t].controller?s[t].controller:undefined,payload:s[t].payload?s[t].payload:undefined,ignoreColumnKeys:s[t].ignoreColumnKeys?s[t].ignoreColumnKeys:[],triggerModelChangeOnColumnInvisible:s[t].triggerModelChangeOnColumnInvisible?s[t].triggerModelChangeOnColumnInvisible:undefined};}}this._removeUnsupportedNamespaces();};e.prototype._mixSetting=function(s,o){if(!o){return s;}for(var t in o){if(o[t].visible&&s[t]&&s[t].visible){o[t].controller=s[t].controller;o[t].payload=o[t].payload?o[t].payload:s[t].payload;}}return o;};e.prototype.getTable=function(){var t=this.getAssociation("table");if(typeof t==="string"){t=sap.ui.getCore().byId(t);}return t;};e.prototype.getModel=function(){return this._oModel;};e.prototype.addColumns=function(o){this._oColumnHelper.addColumnMap(o);};e.prototype.applySettings=function(s){M.prototype.applySettings.apply(this,arguments);this._initialize();};e.prototype._initialize=function(){var t=this.getTable();if(!t){throw"The table instance should be passed into constructor.";}var f=t.getColumns();if(!U.isConsistent(f)){throw"The table instance provided contain some columns for which a columnKey is provided, some for which a columnKey is not provided. This is not allowed ! ";}this._mergeSettingCurrentBy(this.getSetting());this._oColumnHelper.addColumnsToMap(f);var g=this.getProperty("columnKeys");if(!g.length){g=this._oColumnHelper.getColumnKeysOfMap();}this.setColumnKeys(g);this._checkIgnoredColumnKeys(t,this._oColumnHelper.getVisibleColumnKeys());this._masterSync(e.SyncReason.Initialize,null);this._bInitCalled=true;};e.prototype.init=function(){var t=this;this._oDialog=null;this._oPayload=null;this._oPersistentDataRestore=null;this._oPersistentDataCurrentVariant=null;this._oPersistentDataAlreadyKnown=null;this._oPersistentDataBeforeOpen=null;this._oModel=null;this._aColumnKeysOfDateType=[];this._aColumnKeysOfBooleanType=[];this._aColumnKeysOfTimeType=[];this._bIsDirty=false;this._bInitCalled=false;this._bSuspend=false;this._oColumnHelper=new c({callbackOnSetVisible:q.proxy(this._onSetVisible,this),callbackOnSetSummed:q.proxy(this._onSetSummed,this)});this._oSettingOriginalTable={columns:{controller:new C({columnHelper:this._oColumnHelper,afterColumnsModelDataChange:function(E){t._fireChangeEvent();},beforePotentialTableChange:function(E){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(E){t.fireAfterPotentialTableChange();}}),visible:true},sort:{controller:new S({columnHelper:this._oColumnHelper,afterSortModelDataChange:function(E){t._fireChangeEvent();},beforePotentialTableChange:function(E){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(E){t.fireAfterPotentialTableChange();}}),visible:true},filter:{controller:new F({columnHelper:this._oColumnHelper,afterFilterModelDataChange:function(E){t._fireChangeEvent();},beforePotentialTableChange:function(E){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(E){t.fireAfterPotentialTableChange();}}),visible:true},group:{controller:new G({columnHelper:this._oColumnHelper,afterGroupModelDataChange:function(E){t._fireChangeEvent();},beforePotentialTableChange:function(E){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(E){t.fireAfterPotentialTableChange();}}),visible:true}};this._oSettingOriginalChart={dimeasure:{controller:new D({columnHelper:this._oColumnHelper,afterDimeasureModelDataChange:function(E){t._fireChangeEvent();},beforePotentialTableChange:function(E){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(E){t.fireAfterPotentialTableChange();}}),visible:true},sort:{controller:new S({columnHelper:this._oColumnHelper,afterSortModelDataChange:function(E){t._fireChangeEvent();},beforePotentialTableChange:function(E){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(E){t.fireAfterPotentialTableChange();}}),visible:true},filter:{controller:new F({columnHelper:this._oColumnHelper,afterFilterModelDataChange:function(E){t._fireChangeEvent();},beforePotentialTableChange:function(E){t.fireBeforePotentialTableChange();},afterPotentialTableChange:function(E){t.fireAfterPotentialTableChange();}}),visible:true}};};e.prototype.openDialog=function(s){this._suspendTable();var m=this._determineMissingColumns(this.getColumnKeys());if(m.length){this.fireRequestColumns({columnKeys:m});this._masterSync(e.SyncReason.NewModelData,this._getPersistentDataCopy());}this._masterSync(e.SyncReason.NewTableBinding,null);this._oDialog=new sap.m.P13nDialog({stretch:sap.ui.Device.system.phone,showReset:true,showResetEnabled:this._bIsDirty,initialVisiblePanelType:this._oInitialVisiblePanelType,validationExecutor:q.proxy(this._handleDialogValidate,this)});this._oDialog.toggleStyleClass("sapUiSizeCompact",!!q(this.getTable().getDomRef()).closest(".sapUiSizeCompact").length);var o=this._mixSetting(this._oSettingCurrent,s);var p=this._callControllers(o,"getPanel");for(var t in o){if(p[t]){this._oDialog.addPanel(p[t]);}}this._oPersistentDataBeforeOpen=this._getPersistentDataCopy();this._oDialog.attachOk(this._handleDialogOk,this);this._oDialog.attachCancel(this._handleDialogCancel,this);this._oDialog.attachReset(this._handleDialogReset,this);this._oDialog.attachAfterClose(this._handleDialogAfterClose,this);this._oDialog.open();};e.prototype._determineNeededColumnKeys=function(p){var n=this._callControllers(this._oSettingCurrent,"determineNeededColumnKeys",p);return U.getUnionOfColumnKeys(n);};sap.ui.comp.personalization.Controller.prototype._determineMissingColumns=function(n){if(!n.length){return[];}var m=[];var t=this._oColumnHelper.getColumnKeysOfMap();n.forEach(function(s){if(t.indexOf(s)<0){m.push(s);}});return m;};sap.ui.comp.personalization.Controller.prototype._getSettingOfPanels=function(){if(!this._oDialog||!this._oDialog.getPanels()){return{};}var s={};this._oDialog.getPanels().forEach(function(p){var t=p.getType();s[t]={controller:this._oSettingCurrent[t].controller,visible:this._oSettingCurrent[t].visible};},this);return s;};e.prototype._getPersistentDataCopy=function(){var p={};if(this.getModel()&&this.getModel().getData().persistentData){p=U.copy(this.getModel().getData().persistentData);}return p;};e.prototype.setPersonalizationData=function(n){this._suspendTable();if(!this._sanityCheck(n)){return;}var m=this._determineMissingColumns(this._determineNeededColumnKeys(n));if(m.length){this.fireRequestColumns({columnKeys:m});}this._masterSync(e.SyncReason.NewModelDataVariant,n);if(this.getTable()&&this.getTable().setFixedColumnCount){this.getTable().setFixedColumnCount(0);}this._resumeTable(true);this._fireChangeEvent();};e.prototype.resetPersonalization=function(r){this._suspendTable();var R=this.getResetToInitialTableState();if(r===sap.ui.comp.personalization.ResetType.ResetFull||r===sap.ui.comp.personalization.ResetType.ResetPartial){R=(r===sap.ui.comp.personalization.ResetType.ResetFull);}if(R){this._masterSync(e.SyncReason.ResetModelData,null);this._fireChangeEvent(sap.ui.comp.personalization.ResetType.ResetFull);}else{this._masterSync(e.SyncReason.ResetModelDataVariant,null);this._fireChangeEvent(sap.ui.comp.personalization.ResetType.ResetPartial);}this._resumeTable(true);};e.prototype._handleDialogReset=function(E){this._suspendTable();if(this.getResetToInitialTableState()){this._masterSync(e.SyncReason.ResetModelData,null);}else{this._masterSync(e.SyncReason.ResetModelDataVariant,null);}var r=this._getSettingOfPanels();this._callControllers(r,"onAfterReset",E.getParameter("payload"));this._resumeTable(true);};e.prototype._handleDialogCancel=function(E){this._oDialog.detachCancel(this._handleDialogCancel,this);this._oDialog.close();};e.prototype._handleDialogOk=function(E){this._oDialog.detachOk(this._handleDialogOk,this);this._oPayload={trigger:"ok",payload:E.getParameter("payload")};this._oDialog.close();};e.prototype._handleDialogValidate=function(p){var r=[];var s=this._getSettingOfPanels();var P=this._callControllers(s,"getUnionData",U.copy(this._oPersistentDataRestore),this._getPersistentDataCopy());var R=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");if(this.getTable()instanceof sap.ui.table.AnalyticalTable&&s.group&&s.columns){var o=this._oColumnHelper.getColumnMap();for(var f in o){var g=o[f];if(g.getInResult()){continue;}var h=s.columns.controller.isColumnSelected(p.columns,P.columns,f);var i=s.group.controller.isGroupSelected(p.group,P.group,f);if(i&&!h){r.push({columnKey:f,panelTypes:[sap.m.P13nPanelType.group,sap.m.P13nPanelType.columns],messageType:d.Warning,messageText:R.getText("PERSODIALOG_MSG_GROUPING_NOT_POSSIBLE_DESCRIPTION")});}}}return r;};e.prototype._getInitialVisiblePanelType=function(){for(var t in this._oSettingCurrent){return t;}};e.prototype._handleDialogAfterClose=function(){var t=this;var _=this._oPayload;this._oInitialVisiblePanelType=this._oDialog.getVisiblePanel()?this._oDialog.getVisiblePanel().getType():this._getInitialVisiblePanelType();if(_&&_.trigger==="ok"){setTimeout(function(){var s=t._getSettingOfPanels();if(t._oDialog){t._oDialog.destroy();t._oDialog=null;}t._callControllers(s,"onAfterSubmit",t._oPayload.payload);t._oPayload=null;t._fireChangeEvent();t._oPersistentDataBeforeOpen=null;t._resumeTable(true);},0);}else{setTimeout(function(){if(t._oDialog){t._oDialog.destroy();t._oDialog=null;}t._masterSync(e.SyncReason.NewModelData,t._oPersistentDataBeforeOpen);t._oPersistentDataBeforeOpen=null;t._resumeTable(false);},0);}};e.prototype._suspendTable=function(){var t=this.getTable();if(t&&t instanceof sap.ui.table.Table){this._bSuspend=true;}};e.prototype._resumeTable=function(i){i=(i===undefined)?true:i;var t=this.getTable();if(this._bSuspend){if(t){if(i){t.invalidate();}}this._bSuspend=false;}};e.prototype._masterSync=function(u,n){var t=null,j=null;switch(u){case e.SyncReason.NewTableBinding:this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");break;case e.SyncReason.Initialize:this.initializeModel();this._callControllers(this._oSettingCurrent,"setTable",this.getTable());this._setSizeLimit(this.getTable());this._callControllers(this._oSettingCurrent,"setIgnoreColumnKeys");this._callControllers(this._oSettingCurrent,"setTriggerModelChangeOnColumnInvisible");this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");this._callControllers(this._oSettingCurrent,"createTableRestoreJson",this.getColumnKeys());this._callControllers(this._oSettingCurrent,"syncTable2PersistentModel");j=this._callControllers(this._oSettingCurrent,"getTableRestoreJson");this._oPersistentDataRestore=U.copy(j);this._oPersistentDataCurrentVariant={};this._aColumnKeysOfDateType=[];this._aColumnKeysOfTimeType=[];this._aColumnKeysOfBooleanType=[];this._oPersistentDataAlreadyKnown=U.copy(this._oPersistentDataRestore);for(t in this._oPersistentDataRestore){if(!this._oSettingCurrent[t]){delete this._oPersistentDataRestore[t];}}for(t in this._oPersistentDataAlreadyKnown){if(!this._oSettingCurrent[t]){delete this._oPersistentDataAlreadyKnown[t];}}for(t in this._oPersistentDataCurrentVariant){if(!this._oSettingCurrent[t]){delete this._oPersistentDataCurrentVariant[t];}}break;case e.SyncReason.NewModelDataVariant:if(n===null){n={};}var p=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),U.copy(n));this.initializeModel(p);this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");this._callControllers(this._oSettingCurrent,"syncJsonModel2Table",p);this._callControllers(this._oSettingCurrent,"reducePersistentModel");this._oPersistentDataCurrentVariant=U.copy(n);break;case e.SyncReason.NewModelData:if(n===null){n={};}var p=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),U.copy(n));this.initializeModel(p);this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");this._callControllers(this._oSettingCurrent,"syncJsonModel2Table",p);this._callControllers(this._oSettingCurrent,"reducePersistentModel");break;case e.SyncReason.ResetModelData:var P=this._projectRestoreData2PersistentModel4Panels(this._oPersistentDataRestore);this.initializeModel(P);this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");this._callControllers(this._oSettingCurrent,"syncJsonModel2Table",U.copy(P));this._callControllers(this._oSettingCurrent,"reducePersistentModel");break;case e.SyncReason.ResetModelDataVariant:var P=this._projectRestoreData2PersistentModel4Panels(this._oPersistentDataCurrentVariant);var o=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),U.copy(P));this.initializeModel(o);this._callControllers(this._oSettingCurrent,"syncTable2TransientModel");this._callControllers(this._oSettingCurrent,"syncJsonModel2Table",o);this._callControllers(this._oSettingCurrent,"reducePersistentModel");break;default:}this.getModel().refresh();};e.prototype.initializeModel=function(n){if(!this.getModel()){this._oModel=new sap.ui.model.json.JSONModel();this._oModel.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);}var N=null;if(n){N=U.copy(n);}var o=N||((this.getModel().getData()&&this.getModel().getData().persistentData)?this.getModel().getData().persistentData:{});for(var t in o){if(!this._oSettingCurrent[t]){delete o[t];}}this.getModel().setData({transientData:{},persistentData:o});this._callControllers(this._oSettingCurrent,"initializeModel",this.getModel());};e.prototype._fireChangeEvent=function(r){var o={};var p=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),this._getPersistentDataCopy());var P=U.copy(this._oPersistentDataAlreadyKnown);o.changeType=this._callControllers(this._oSettingCurrent,"getChangeType",p,P);if(this.getResetToInitialTableState()){var f=U.copy(this._oPersistentDataRestore);o.changeTypeRestore=this._callControllers(this._oSettingCurrent,"getChangeType",p,f);this._bIsDirty=U.hasChangedType(o.changeTypeRestore);}else{var g=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataRestore),U.copy(this._oPersistentDataCurrentVariant));o.changeTypeVariant=this._callControllers(this._oSettingCurrent,"getChangeType",p,g);o.changeTypeRestore=o.changeTypeVariant;this._bIsDirty=U.hasChangedType(o.changeTypeRestore);}if(!U.hasChangedType(o.changeType)){return;}this._aColumnKeysOfDateType=this._oColumnHelper.getColumnKeysOfType("date");this._aColumnKeysOfTimeType=this._oColumnHelper.getColumnKeysOfType("time");this._aColumnKeysOfBooleanType=this._oColumnHelper.getColumnKeysOfType("boolean");if(r===sap.ui.comp.personalization.ResetType.ResetFull||r===sap.ui.comp.personalization.ResetType.ResetPartial){o.changeReason=r;}var h=this._callControllers(this._oSettingCurrent,"getChangeData",p,P);o.changeData=U.removeEmptyProperty(U.copy(h));U.recoverPersonalisationDateData(o.changeData,this._aColumnKeysOfDateType);U.recoverPersonalisationTimeData(o.changeData,this._aColumnKeysOfTimeType);U.recoverPersonalisationBooleanData(o.changeData,this._aColumnKeysOfBooleanType);var i=U.copy(this._oPersistentDataRestore);var j=this._callControllers(this._oSettingCurrent,"getChangeData",p,i);o.persistentData=U.removeEmptyProperty(j);U.recoverPersonalisationDateData(o.persistentData,this._aColumnKeysOfDateType);U.recoverPersonalisationTimeData(o.persistentData,this._aColumnKeysOfTimeType);U.recoverPersonalisationBooleanData(o.persistentData,this._aColumnKeysOfBooleanType);this.fireAfterP13nModelDataChange(o);this._oPersistentDataAlreadyKnown=this._callControllers(this._oSettingCurrent,"getUnionData",U.copy(this._oPersistentDataAlreadyKnown),h);};e.prototype._projectRestoreData2PersistentModel4Panels=function(p){if(!this._oDialog||q.isEmptyObject(p)){return p;}var P=this._getPersistentDataCopy();var f=this._oDialog.getPanels();f.forEach(function(o){if(p[o.getType()]){P[o.getType()]=U.copy(p[o.getType()]);}else{delete P[o.getType()];}});return P;};e.prototype._checkIgnoredColumnKeys=function(t,v){if(t instanceof b){return;}var i=U.getUnionOfAttribute(this._oSettingCurrent,"ignoreColumnKeys");i.some(function(s){if(v.indexOf(s)>-1){throw"The provided 'ignoreColumnKeys' are inconsistent. No columns specified as ignored is allowed to be visible.";}});};e.prototype._onSetVisible=function(v,s){if(v){var i=U.getUnionOfAttribute(this._oSettingCurrent,"ignoreColumnKeys");if(i.indexOf(s)>-1){throw"The provided 'ignoreColumnKeys' are inconsistent. No column specified as ignored is allowed to be visible. "+this;}}};e.prototype._onSetSummed=function(i,o){this._oSettingCurrent.columns.controller._onColumnTotal({column:o,isSummed:i});};e.prototype._removeUnsupportedNamespaces=function(){var t=this.getTable();if(t&&t instanceof sap.ui.table.Table&&!(t instanceof sap.ui.table.AnalyticalTable)){delete this._oSettingCurrent.group;}};e.prototype._getArgumentsByType=function(A,t){var r=[],o=null;if(A&&A.length&&t){A.forEach(function(f){if(f&&f[t]&&typeof f[t]!=="function"){o={};o[t]=f[t];r.push(o);}else{r.push(f);}});}return r;};e.prototype._callControllers=function(s,m){var t=null,o=null,f=null,A=null;var r={},g=Array.prototype.slice.call(arguments,2);for(t in s){o=f=A=null;o=s[t];f=o.controller;if(!f||!o.visible||!f[m]){continue;}A=this._getArgumentsByType(g,t);if(m==="getPanel"){A.push(o.payload);}else if(m==="setIgnoreColumnKeys"){A.push(o.ignoreColumnKeys);}else if(m==="setTriggerModelChangeOnColumnInvisible"){A.push(o.triggerModelChangeOnColumnInvisible);}var R=f[m].apply(f,A);if(R!==null&&R!==undefined&&R[t]!==undefined){r[t]=R[t];}else{r[t]=R;}}return r;};e.prototype._setSizeLimit=function(t){this.getModel().setSizeLimit(this.getTable().getColumns().length+1000);};e.prototype._sanityCheck=function(n){return true;};e.prototype.exit=function(){var t;this._resumeTable(false);if(this._oDialog){this._oDialog.destroy();this._oDialog=null;}this._callControllers(this._oSettingCurrent,"destroy");for(t in this._oSettingCurrent){this._oSettingCurrent[t]=null;}this._oSettingCurrent=null;for(t in this._oSettingOriginalTable){this._oSettingOriginalTable[t]=null;}this._oSettingOriginalTable=null;this._oSettingCurrent=null;for(t in this._oSettingOriginalChart){this._oSettingOriginalChart[t]=null;}this._oSettingOriginalChart=null;if(this.getModel()){this.getModel().destroy();this._oModel=null;}this._oPersistentDataRestore=null;this._oPersistentDataCurrentVariant=null;this._oPersistentDataAlreadyKnown=null;this._oPersistentDataBeforeOpen=null;this._oPayload=null;this._oColumnHelper=null;};e.SyncReason={NewTable:0,NewSetting:1,NewModelData:6,NewModelDataVariant:2,ResetModelData:3,ResetModelDataVariant:4,NewTableBinding:5};return e;},true);
