/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','./PersonalizableInfo','sap/ui/comp/variants/VariantItem','sap/ui/comp/variants/VariantManagement','sap/ui/fl/Change','sap/ui/fl/Persistence','sap/ui/fl/Utils'],function(q,l,P,V,a,C,b,F){"use strict";var S=a.extend("sap.ui.comp.smartvariants.SmartVariantManagement",{metadata:{library:"sap.ui.comp",designTime:true,properties:{persistencyKey:{type:"string",group:"Misc",defaultValue:null}},aggregations:{personalizableControls:{type:"sap.ui.comp.smartvariants.PersonalizableInfo",multiple:true,singularName:"personalizableControl"}},events:{initialise:{},afterSave:{}}},renderer:function(r,c){a.getMetadata().getRenderer().render(r,c);}});S.prototype.init=function(){a.prototype.init.apply(this);this._bIsInitialized=false;this._oStandardVariant=null;this._oControlPersistence=null;this._oControlPromise=null;this._oPersoControl=null;this._sAppStandardVariantKey=null;this._oAppStdContent=null;this._aPersonalizableControls=[];if(this.setLifecycleSupport){this.setLifecycleSupport(true);}this._setBackwardCompatibility(false);this.setSupportExecuteOnSelectOnSandardVariant(true);};S.prototype._createControlWrapper=function(c){var o=null;var d=sap.ui.getCore().byId(c.getControl());if(d){o={control:d,type:c.getType(),dataSource:c.getDataSource(),keyName:c.getKeyName(),loaded:q.Deferred()};}return o;};S.prototype._getControlWrapper=function(c){var d=this._getAllPersonalizableControls();if(d&&d.length){for(var i=0;i<d.length;i++){if(d[i].control===c){return d[i];}}}return null;};S.prototype.addPersonalizableControl=function(c){var o,d=null,s=c.getControl();d=sap.ui.getCore().byId(s);if(!d){q.sap.log.error("couldn't obtain the control with the id="+s);return;}this.addAggregation("personalizableControls",c,true);o=this._createControlWrapper(c);if(o){this._aPersonalizableControls.push(o);}if(this.isPageVariant()){return;}this._setPersControler(d);};S.prototype._setPersControler=function(c){if(!this._oPersoControl&&F.getComponentClassName(c)){this._oPersoControl=c;this._addPersistenceController(c);}};S.prototype.setPersistencyKey=function(k){this.setProperty("persistencyKey",k);this._setPersControler(this);};S.prototype._addPersistenceController=function(c){if(c){this._oControlPersistence=new b(c,"persistencyKey");this._handleGetChanges(c);}};S.prototype.isPageVariant=function(){if(this.getPersistencyKey()){return true;}return false;};S.prototype._handleGetChanges=function(c){var t=this;if(c&&this._oControlPersistence){this._oControlPromise={};this._oControlPromise=new Promise(function(r,d){t._oControlPersistence.getChanges().then(function(v){r(v);},function(e){d(e);});});}};S.prototype.getVariantContent=function(c,k){var p,o=this._getChangeContent(k);if(o&&this.isPageVariant()){p=this._getControlPersKey(c);if(p){o=this._retrieveContent(o,p);}}return o;};S.prototype._getChangeContent=function(k){var c=null;if(k===this.STANDARDVARIANTKEY){c=this.getStandardVariant();}else{c=this._getChange(k);if(c){c=c.getContent();if(c){c=q.extend(true,{},c);}}}return c;};S.prototype._getChange=function(i){var c=null;if(this._oControlPersistence){c=this._oControlPersistence.getChange(i);}return c;};S.prototype._getAllPersonalizableControls=function(){return this._aPersonalizableControls;};S.prototype._createVariantEntries=function(v){var n=null;var s,u,c=null;var o,d;var e=[];this.removeAllItems();if(v){for(n in v){if(n){o=v[n];if(o.isVariant()){u=this._getUser(o);d=new V({key:o.getId(),text:o.getText("variantName"),global:!o.isUserDependent(),executeOnSelection:this._getExecuteOnSelection(o),lifecycleTransportId:o.getRequest(),lifecyclePackage:o.getPackage(),namespace:o.getNamespace(),readOnly:o.isReadOnly(),labelReadOnly:o.isLabelReadOnly(),author:u});if(this._hasStoredStandardVariant(o)){c=o.getId();}this.addVariantItem(d);e.push(o.getId());}}}}if(this._oPersoControl){s=this._getDefaultVariantKey();if(s){this.setInitialSelectionKey(s);}var f=this._isApplicationVariant(this._oPersoControl);if(f){this.setIndustrySolutionMode(f);f=F.isVendorLayer();this._setVendorLayer(f);}if(this.getIndustrySolutionMode()){if(c){this._sAppStandardVariantKey=c;this.setStandardVariantKey(c);}}if(this._oControlPersistence&&this._oControlPersistence.isVariantDownport()){this._enableManualVariantKey(true);}}return e;};S.prototype.getVariantsInfo=function(c){if(!c){q.sap.log.error("'getVariantsInfo' failed. Expecting callBack not passed.");return;}var n=null;var v;var d=[];var t=this;try{if(this._oControlPersistence){this._oControlPersistence.getChanges().then(function(m){if(m){for(n in m){if(n){v=m[n];if(v.isVariant()){d.push({key:v.getId(),text:v.getText("variantName")});}}}}c(d);},function(f){var E="'getChanges' failed:";if(f&&f[0]&&f[0].messages&&f[0].messages[0]){E+=(' '+f[0].messages[0]);}t._setErrorValueState(t.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),E);c(d);});}}catch(e){this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),"'getChanges' throws an exception");}};S.prototype.getCurrentVariantId=function(){var k="";var i=this._getSelectedItem();if(i){k=i.getKey();if(k===this.STANDARDVARIANTKEY){k="";}}return k;};a.prototype.setCurrentVariantId=function(v,d){var i=this._determineVariantId(v);if(this._oPersoControl){if(!this._oStandardVariant){this._setSelectionByKey(i);}else{this._applyCurrentVariantId(i,d);}}};S.prototype._applyCurrentVariantId=function(v,d){var c;if(this._oPersoControl){c=this._getChangeContent(v);if(c){this._setSelectionByKey(v);if(!d){if(this.isPageVariant()){this._applyVariants(c,"SET_VM_ID");}else{this._applyVariant(this._oPersoControl,c,"SET_VM_ID");}}}}};S.prototype._determineVariantId=function(v){var i=v;if(!i){i=this.getStandardVariantKey();}else{if(!this.getItemByKey(i)){i=this.getStandardVariantKey();}}return i;};S.prototype.initialise=function(c,p){var o=null,d,t=this,k,f;var e={variantKeys:[]};try{if(p&&c){o=this._getControlWrapper(p);if(!o){q.sap.log.error("initialise on an unknown control.");return;}if(o.bInitialized){q.sap.log.error("initialise on "+p.getId()+" already executed");return;}o.fInitCallback=c;}else if(!this.isPageVariant()){o=this._getControlWrapper(this._oPersoControl);}if(this._oControlPromise&&this._oPersoControl&&o){this._oControlPromise.then(function(v){if(!t._bIsInitialized){t._bIsInitialized=true;e.variantKeys=t._createVariantEntries(v);f=t._getExecuteOnSelectOnStandardVariant();if(f!==null){t._executeOnSelectForStandardVariantByUser(f);}k=t._getDefaultVariantKey();if(k){d=t._getChangeContent(k);if(d){t.setDefaultVariantKey(k);t.setInitialSelectionKey(k);}}if(t._sAppStandardVariantKey){t._oAppStdContent=t._getChangeContent(t._sAppStandardVariantKey);}}t._initialize(e,o);},function(h){var E="'getChanges' failed:";if(h&&h.messages&&h.messages[0]){E+=(' '+h.messages[0]);}t._setErrorValueState(t.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),E);if(c&&p){c.call(p);}else{t.fireEvent("initialise",e);}});}else{this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),"'initialise' no personalizable component available");if(c&&p){c.call(p);}else{t.fireEvent("initialise",e);}}}catch(g){this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_READ_FAILED"),"'getChanges' throws an exception");if(c&&p){c.call(p);}else{t.fireEvent("initialise",e);}}};S.prototype._initialize=function(p,c){var k,o=null,i=this.isPageVariant();if(this._oAppStdContent){if((c.type==="table")||(c.type==="chart")){if(i){this._applyControlVariant(c.control,this._oAppStdContent,"STANDARD",true);}else{this._applyVariant(c.control,this._oAppStdContent,"STANDARD",true);}}}if(c.fInitCallback){c.fInitCallback.call(c.control);delete c.fInitCallback;c.bInitialized=true;}else{this.fireEvent("initialise",p);}c.loaded.resolve();k=this.getSelectionKey();if(k&&(k!==this.getStandardVariantKey())){o=this._getChangeContent(k);}else if(this._oAppStdContent){o=this._oAppStdContent;}if(this._sAppStandardVariantKey){this._updateStandardVariant(c,this._oAppStdContent);}else{this._setStandardVariant(c);}if(o){if(i){this._applyControlVariant(c.control,o,"INIT",true);}else{this._applyVariant(c.control,o,"INIT",true);}}if(c.control.variantsInitialized){c.control.variantsInitialized();}if(this.getStandardVariantKey()&&this.getExecuteOnSelectForStandardVariant()){if(c.control.search){c.control.search();}}};S.prototype._updateVariant=function(v){if(this._isIndustrySolutionModeAndVendorLayer()||(v.key!==this.getStandardVariantKey())){if(v){var c=this._getChange(v.key);if(c){try{if((v.lifecycleTransportId!==null)&&(v.lifecycleTransportId!==undefined)){c.setRequest(v.lifecycleTransportId);}var o=this._fetchContent();if(o){var i=this.getItemByKey(v.key);if(i){o.executeOnSelection=i.getExecuteOnSelection();}if(o.standardvariant!==undefined){delete o.standardvariant;}if(this._isIndustrySolutionModeAndVendorLayer()&&(v.key===this.getStandardVariantKey())){o.standardvariant=true;}c.setContent(o);}}catch(e){q.sap.log.error("'_updateVariant' throws an exception");}}}}};S.prototype._createChangeHeader=function(){if(this.isPageVariant()){return{type:"page",dataService:"n/a"};}var c=this._getAllPersonalizableControls();if(c&&c.length>0){return{type:c[0].type,dataService:c[0].dataSource};}};S.prototype._newVariant=function(v){var i,c,o;if(v&&this._oControlPersistence){var t=this._createChangeHeader();var u=!v.global;var p="";if((v.lifecyclePackage!==null)&&(v.lifecyclePackage!==undefined)){p=v.lifecyclePackage;}var T="";if((v.lifecycleTransportId!==null)&&(v.lifecycleTransportId!==undefined)){T=v.lifecycleTransportId;}c=this._fetchContent();if(c){if(v.exe){c.executeOnSelection=v.exe;}if(v.tile){c.tile=v.tile;}if(c.standardvariant!==undefined){delete c.standardvariant;}if(this._isIndustrySolutionModeAndVendorLayer()&&v.key===this.STANDARDVARIANTKEY){c.standardvariant=true;}}i=this._isVariantDownport()?v.key:null;var m={type:t.type,ODataService:t.dataSource,texts:{variantName:v.name},content:c,isVariant:true,packageName:p,isUserDependent:u,id:i};i=this._oControlPersistence.addChange(m);this.replaceKey(v.key,i);this.setInitialSelectionKey(i);if(this.getIndustrySolutionMode()&&v.key===this.STANDARDVARIANTKEY){this.setStandardVariantKey(i);}o=this._getChange(i);if(o){o.setRequest(T);var I=this.getItemByKey(i);if(I){I.setNamespace(o.getNamespace());}}if(v.def===true){this._setDefaultVariantKey(i);}}};S.prototype._fetchContent=function(){var c,p,o,d={};var e=this._getAllPersonalizableControls();for(var i=0;i<e.length;i++){c=e[i];if(c&&c.control&&c.control.fetchVariant){o=c.control.fetchVariant();if(o){if(o){o=q.extend(true,{},o);}if(this.isPageVariant()){p=this._getControlPersKey(c);if(p){d=this._assignContent(d,o,p);}else{q.sap.log.error("no persistancy key retrieved");}}else{d=o;break;}}}}return d;};S.prototype._getControlPersKey=function(c){var p=null;if(c.keyName){p=c.control.getProperty(c.keyName);}else{var o=this._getControlWrapper(c);if(o.keyName){p=c.getProperty(o.keyName);}}return p;};S.prototype._newVariantContent=function(c){var o=null,d,s,p;if(c&&c.control&&c.control.fetchVariant){d=c.control.fetchVariant();if(d){s=JSON.stringify(d);d=JSON.parse(s);if(this.isPageVariant()){p=this._getControlPersKey(c);if(p){o={};o=this._assignContent(o,d,p);}else{q.sap.log.error("no persistancy key retrieved");}}else{o=d;}}}return o;};S.prototype._appendLifecycleInformation=function(v,i){var t;var I=this.getItemByKey(i);if(I){t=I.getLifecycleTransportId();if(t===null||t===undefined){t="";}if(v){v.setRequest(t);}}};S.prototype._renameVariant=function(v){if(v.key!==this.getStandardVariantKey()){if(v){var c=this._getChange(v.key);if(c){c.setText("variantName",v.name);this._appendLifecycleInformation(c,v.key);}}}};S.prototype._deleteVariants=function(v){var i;if(v&&v.length){var s=this._getDefaultVariantKey();for(i=0;i<v.length;i++){if(v[i]===this.getStandardVariantKey()){continue;}var c=this._getChange(v[i]);if(c){c.markForDeletion();if(s&&s===v[i]){this._setDefaultVariantKey("");}this._appendLifecycleInformation(c,v[i]);}}}};S.prototype._getDefaultVariantKey=function(){var d="";if(this._oControlPersistence){d=this._oControlPersistence.getDefaultVariantIdSync();}return d;};S.prototype._setDefaultVariantKey=function(v){if(this._oControlPersistence){this._oControlPersistence.setDefaultVariantIdSync(v);}};S.prototype._getExecuteOnSelectOnStandardVariant=function(){var e=null;if(this._oControlPersistence){e=this._oControlPersistence.getExecuteOnSelectSync();}return e;};S.prototype._setExecuteOnSelectOnStandardVariant=function(f){if(this._oControlPersistence){this._oControlPersistence.setExecuteOnSelectSync(f);}};S.prototype._isVariantDownport=function(){var d=false;if(this._oControlPersistence){d=this._oControlPersistence.isVariantDownport();}return d;};S.prototype._getExecuteOnSelection=function(v){var c;if(v){c=v.getContent();if(c&&(c.executeOnSelection!==undefined)){return c.executeOnSelection;}}return false;};S.prototype._hasStoredStandardVariant=function(v){var c;if(v){c=v.getContent();if(c&&c.standardvariant){return c.standardvariant;}}return false;};S.prototype._isComponentTemplate=function(c){var i=false;var o=F.getComponentForControl(c);if(o&&o.getAppComponent){o=o.getAppComponent();if(o){i=true;}}return i;};S.prototype._isApplicationVariant=function(c){if(F.isApplicationVariant(c)){return true;}if(this._isComponentTemplate(c)){return true;}return false;};S.prototype._setExecuteOnSelections=function(v){var i;if(v&&v.length){for(i=0;i<v.length;i++){if(v[i].key===this.STANDARDVARIANTKEY){this._setExecuteOnSelectOnStandardVariant(v[i].exe);continue;}var c=this._getChange(v[i].key);if(c){var j=c.getContent();if(j){j.executeOnSelection=v[i].exe;c.setContent(j);}this._appendLifecycleInformation(c,v[i].key);}}}};S.prototype._save=function(n){var t=this;if(this._oControlPersistence){try{this._oControlPersistence.saveAll().then(function(){if(n){t._updateUser();}t.fireEvent("afterSave");},function(c){var E="'_save' failed:";if(c&&c[0]&&c[0].messages&&c[0].messages[0]){E+=(' '+c[0].messages[0]);}t._setErrorValueState(t.oResourceBundle.getText("VARIANT_MANAGEMENT_SAVE_FAILED"),E);});}catch(e){this._setErrorValueState(this.oResourceBundle.getText("VARIANT_MANAGEMENT_SAVE_FAILED"),"'_save' throws an exception");}}};S.prototype._updateUser=function(){var i=this.getInitialSelectionKey();var u=this._getUser(this._getChange(i));if(u){this._assignUser(i,u);}};S.prototype._getUser=function(c){var u=null;if(c&&c.getDefinition()&&c.getDefinition().support){u=c.getDefinition().support.user?c.getDefinition().support.user:"";}return u;};S.prototype.fireSave=function(v){var s=false;var n=true;if(v){if(v.overwrite){if(this._isIndustrySolutionModeAndVendorLayer()||(v.key!==this.getStandardVariantKey())){this.fireEvent("save");if(v.key===this.STANDARDVARIANTKEY){this._newVariant(v);}else{this._updateVariant(v);n=false;}s=true;}}else{this.fireEvent("save");this._newVariant(v);s=true;}if(s){this._save(n);}}};S.prototype.fireManage=function(v){var i;if(v){if(v.renamed){for(i=0;i<v.renamed.length;i++){this._renameVariant(v.renamed[i]);}}if(v.deleted){this._deleteVariants(v.deleted);}if(v.exe){this._setExecuteOnSelections(v.exe);}if(v.def){var d=this._getDefaultVariantKey();if(d!==v.def){this._setDefaultVariantKey(v.def);}}if((v.deleted&&v.deleted.length>0)||(v.renamed&&v.renamed.length>0)||(v.exe&&v.exe.length>0)||v.def){this._save();}this.fireEvent("manage",v);}};S.prototype.fireSelect=function(v,c){if(this._oPersoControl&&v&&v.key){this._triggerSelectVariant(v.key,c);}};S.prototype._selectVariant=function(v,c){this.fireSelect({key:v},c);};S.prototype._triggerSelectVariant=function(v,c){var o=this._getChangeContent(v);if(o){var s=JSON.stringify(o);o=JSON.parse(s);if((v===this.STANDARDVARIANTKEY)&&this.getExecuteOnSelectForStandardVariant()){o.executeOnSelection=this.getExecuteOnSelectForStandardVariant();}if(this.isPageVariant()){this._applyVariants(o,c);}else{this._applyVariant(this._oPersoControl,o,c);}}};S.prototype._applyControlWrapperVariants=function(c,o,s){var t=this;if(c){c.loaded.then(function(){t._applyControlVariant(c.control,o,s);});}};S.prototype._applyVariants=function(c,s){var i,d=this._getAllPersonalizableControls();for(i=0;i<d.length;i++){if(d[i]&&d[i].control&&d[i].loaded){this._applyControlWrapperVariants(d[i],c,s);}}};S.prototype._setStandardVariant=function(c){var o=c.control;if(o){if(o.fireBeforeVariantSave){o.fireBeforeVariantSave(a.STANDARD_NAME);}this._assignStandardVariant(c);}};S.prototype._retrieveContent=function(c,p){var r=c;if(this.isPageVariant()&&c){r=c[p];if(!r&&(p===this.getPersistencyKey())&&this._aPersonalizableControls&&this._aPersonalizableControls.length===1){r=c;}}return r;};S.prototype._assignContent=function(t,c,p){if(this.isPageVariant()){if(!((p===this.getPersistencyKey())&&this._aPersonalizableControls&&this._aPersonalizableControls.length===1)){t[p]=c;}else{t=c;}}else{t=c;}return t;};S.prototype._updateStandardVariant=function(c,o){if(c.control){var d=o;if(this.isPageVariant()){var p=this._getControlPersKey(c);if(p){d=this._retrieveContent(o,p);}}this._assignStandardVariantForControl(c,d);}};S.prototype._assignStandardVariant=function(c){var s=null;if(c.control){if(c.control.fetchVariant){s=c.control.fetchVariant();}this._assignStandardVariantForControl(c,s);}};S.prototype._assignStandardVariantForControl=function(c,s){var o=s;if(c){if(this.isPageVariant()){var p=this._getControlPersKey(c.control);if(p){if(!this._oStandardVariant){this._oStandardVariant={};}this._oStandardVariant=this._assignContent(this._oStandardVariant,o,p);}}else{this._oStandardVariant=o;}}};S.prototype.getStandardVariant=function(c){var p,o,d=null;if(this._oStandardVariant){if(!c){d=this._oStandardVariant;}else{if(this.isPageVariant()){o=this._getControlWrapper(c);if(o){p=this._getControlPersKey(c);if(p){d=this._retrieveContent(this._oStandardVariant,p);}}}else{if((c===this._oPersoControl)){d=this._oStandardVariant;}}}}return d;};S.prototype._applyVariant=function(c,o,s,i){if(c&&c.applyVariant){c.applyVariant(o,s,i);}};S.prototype._applyControlVariant=function(c,o,s,i){var d,p;p=this._getControlPersKey(c);if(p){d=this._retrieveContent(o,p);if(d){d.executeOnSelection=o.executeOnSelection;this._applyVariant(c,d,s,i);}}};S.prototype._setErrorValueState=function(t,L){this.setEnabled(false);if(L){q.sap.log.error(L);}};S.prototype.exit=function(){a.prototype.exit.apply(this,arguments);this._aPersonalizableControls=null;this._oControlPersistence=null;this._oControlPromise=null;this._oPersoControl=null;this._oAppStdContent=null;this._sAppStandardVariantKey=null;};return S;},true);
