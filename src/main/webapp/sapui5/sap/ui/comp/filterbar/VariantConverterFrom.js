/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library','sap/ui/comp/valuehelpdialog/ValueHelpDialog','sap/m/MultiComboBox','sap/m/MultiInput','sap/m/DatePicker','sap/m/DateRangeSelection'],function(q,l,V,M,a,D,b){"use strict";var c=function(){};c.prototype.convert=function(s,f){var C=null,r=null;var S;if(s){S=JSON.parse(s);if(f&&f.getFilterBarViewMetadata&&S&&(S.Parameters||S.SelectOptions)){C={};if(S.Parameters){this._addParameters(S.Parameters,f,C);}if(S.SelectOptions){this._addSelectOptions(S.SelectOptions,f,C);}r={payload:null,variantId:null};r.payload=JSON.stringify(C);if(S.SelectionVariantID){r.variantId=S.SelectionVariantID;}}}return r;};c.prototype.retrieveVariantId=function(s){var v=null;var S;if(s){S=JSON.parse(s);if(S&&S.SelectionVariantID){v=S.SelectionVariantID;}}return v;};c.prototype._getParameterMetaData=function(n,f){var i,j;var g;var F=f.getFilterBarViewMetadata();if(F){for(i=0;i<F.length;i++){g=F[i];for(j=0;j<g.fields.length;j++){if(n===g.fields[j].fieldName){return g.fields[j];}}}}if(f.getAnalyticalParameters){var A=f.getAnalyticalParameters();if(A){for(j=0;j<A.length;j++){if(n===A[j].fieldName){return A[j];}}}}return null;};c.prototype._addParameters=function(s,f,C){var i;var n,v;var F;for(i=0;i<s.length;i++){v=s[i].PropertyValue;n=s[i].PropertyName;F=this._getParameterMetaData(n,f);if(F){f.determineControlByName(n);this._addAccordingMetaData(C,F,v);}else{q.sap.log.error("neither metadata nor custom information for filter '"+n+"'");}}};c.prototype._addSelectOptions=function(s,f,C){var i;var n,r;var F,o;for(i=0;i<s.length;i++){n=s[i].PropertyName;r=s[i].Ranges;f.determineControlByName(n);F=this._getParameterMetaData(n,f);if(F){o=F.control;this._addRangesAccordingMetaData(C,F,r,o);}else{q.sap.log.error("neither metadata nor custom information for filter '"+name+"'");}}};c.prototype._addRangesAccordingMetaData=function(C,f,r,o,n){var i,O;var d=function(s,v){var I=s;if(s==="CP"){I=sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.Contains;if(v){var g=v.indexOf('*');var h=v.lastIndexOf('*');if((g===0)&&(h!==(v.length-1))){I=sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EndsWith;v=v.substring(1,v.length);}else if((g!==0)&&(h===(v.length-1))){I=sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.StartsWith;v=v.substring(0,v.length-1);}else{v=v.substring(1,v.length-1);}}}return{op:I,v:v};};var e=function(F,r){var i,I,O;if(!C[F]){C[F]={ranges:[],items:[],value:null};}for(i=0;i<r.length;i++){O=d(r[i].Option,r[i].Low);I={"exclude":(r[i].Sign==="E"),"operation":O.op,"keyField":F,"value1":O.v,"value2":r[i].High};C[F].ranges.push(I);}};if(r&&r.length>0){if(f.isCustomFilterField){if(!C._CUSTOM){C._CUSTOM={};}C._CUSTOM[f.fieldName]=r[0].Low;return;}if(f.conditionType){e(f.fieldName,r);return;}if(f.filterRestriction===sap.ui.comp.smartfilterbar.FilterType.single){if(!r[0].Low&&o&&(o instanceof D)){C[f.fieldName]=null;}else{C[f.fieldName]=r[0].Low;}}else if(f.filterRestriction===sap.ui.comp.smartfilterbar.FilterType.interval){if(o&&(o instanceof b)){if(r[0].Low&&r[0].High){C[f.fieldName]={low:r[0].Low,high:r[0].High};}else if(r[0].Low&&!r[0].High){C[f.fieldName]={low:r[0].Low,high:r[0].Low};}else if(!r[0].Low&&r[0].High){C[f.fieldName]={low:r[0].High,high:r[0].High};}else{C[f.fieldName]={low:null,high:null};}}else{C[f.fieldName]={low:r[0].Low===undefined?null:r[0].Low,high:r[0].High===undefined?null:r[0].High};}}else if(f.filterRestriction===sap.ui.comp.smartfilterbar.FilterType.multiple){C[f.fieldName]={ranges:[],items:[],value:null};if(o&&((o instanceof M)||(o instanceof a))){for(i=0;i<r.length;i++){O=d(r[i].Option,r[i].Low);if(O.op===sap.ui.comp.valuehelpdialog.ValueHelpRangeOperation.EQ){if(f.type==="Edm.DateTime"){C[f.fieldName].ranges.push({value1:O.v});}else{C[f.fieldName].items.push({key:O.v});}}}}else{e(f.fieldName,r);}}else{e(f.fieldName,r);}q.sap.log.warning("potential reduced information for filter '"+f.fieldName+"'");}else{q.sap.log.warning("no Ranges-section found for filter '"+f.fieldName+"'");}};c.prototype._addAccordingMetaData=function(C,f,v){var h=f.type==="Edm.DateTime"?"":v;var r=[{Sign:"I",Low:v,High:h,Option:"EQ"}];this._addRangesAccordingMetaData(C,f,r);};return c;},true);
