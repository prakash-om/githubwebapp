/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/m/VBoxRenderer','sap/m/Column','sap/m/Label','sap/m/MessageBox','sap/m/Table','sap/m/Text','sap/m/Title','sap/m/OverflowToolbar','sap/m/ToolbarDesign','sap/m/OverflowToolbarButton','sap/m/ToolbarSeparator','sap/m/VBox','sap/ui/comp/library','sap/ui/comp/providers/TableProvider','sap/ui/comp/smartfilterbar/FilterProvider','sap/ui/comp/smartvariants/SmartVariantManagement','sap/ui/model/FilterOperator','sap/ui/model/json/JSONModel','sap/ui/table/AnalyticalColumn','sap/ui/table/AnalyticalTable','sap/ui/table/Column','sap/ui/table/Table','sap/ui/table/TreeTable','sap/ui/comp/personalization/Util','sap/ui/comp/util/FormatUtil','sap/ui/comp/odata/ODataModelUtil'],function(q,V,C,L,M,R,T,a,O,b,c,d,f,l,g,F,S,h,J,A,j,k,m,n,P,o,p){"use strict";var r=f.extend("sap.ui.comp.smarttable.SmartTable",{metadata:{library:"sap.ui.comp",designTime:true,properties:{entitySet:{type:"string",group:"Misc",defaultValue:null},smartFilterId:{type:"string",group:"Misc",defaultValue:null},ignoredFields:{type:"string",group:"Misc",defaultValue:null},initiallyVisibleFields:{type:"string",group:"Misc",defaultValue:null},requestAtLeastFields:{type:"string",group:"Misc",defaultValue:null},ignoreFromPersonalisation:{type:"string",group:"Misc",defaultValue:null},tableType:{type:"sap.ui.comp.smarttable.TableType",group:"Misc",defaultValue:null},useVariantManagement:{type:"boolean",group:"Misc",defaultValue:true},showVariantManagement:{type:"boolean",group:"Misc",defaultValue:true},useExportToExcel:{type:"boolean",group:"Misc",defaultValue:true},useTablePersonalisation:{type:"boolean",group:"Misc",defaultValue:true},showTablePersonalisation:{type:"boolean",group:"Misc",defaultValue:true},showRowCount:{type:"boolean",group:"Misc",defaultValue:true},header:{type:"string",group:"Misc",defaultValue:null},toolbarStyleClass:{type:"string",group:"Misc",defaultValue:null},enableCustomFilter:{type:"boolean",group:"Misc",defaultValue:true},persistencyKey:{type:"string",group:"Misc",defaultValue:null},useOnlyOneSolidToolbar:{type:"boolean",group:"Misc",defaultValue:false},currentVariantId:{type:"string",group:"Misc",defaultValue:null},editable:{type:"boolean",group:"Misc",defaultValue:false},enableAutoBinding:{type:"boolean",group:"Misc",defaultValue:false},tableBindingPath:{type:"string",group:"Misc",defaultValue:null},editTogglable:{type:"boolean",group:"Misc",defaultValue:false},demandPopin:{type:"boolean",group:"Misc",defaultValue:false},showFullScreenButton:{type:"boolean",group:"Misc",defaultValue:false}},associations:{smartVariant:{type:"sap.ui.core.Control",multiple:false}},aggregations:{customToolbar:{type:"sap.m.Toolbar",multiple:false},semanticObjectController:{type:"sap.ui.comp.navpopover.SemanticObjectController",multiple:false},noData:{type:"sap.ui.core.Control",altTypes:["string"],multiple:false},semanticKeyAdditionalControl:{type:"sap.ui.core.Control",multiple:false}},events:{initialise:{},beforeRebindTable:{},editToggled:{},dataReceived:{},afterVariantInitialise:{},afterVariantSave:{},afterVariantApply:{},showOverlay:{},fieldChange:{}}},renderer:V.render,constructor:function(){f.apply(this,arguments);this._aExistingColumns=[];this._aAlwaysSelect=[];this._oTemplate=null;this._createToolbar();this._oP13nDialogSettings=this.data("p13nDialogSettings");if(typeof this._oP13nDialogSettings==="string"){try{this._oP13nDialogSettings=JSON.parse(this._oP13nDialogSettings);}catch(e){this._oP13nDialogSettings=null;}}this._bIsFilterPanelEnabled=(this._oP13nDialogSettings&&this._oP13nDialogSettings.filter)?this._oP13nDialogSettings.filter.visible!==false:true;this._createTable();}});r.prototype.init=function(){sap.m.FlexBox.prototype.init.call(this);this.addStyleClass("sapUiCompSmartTable");this.setFitContainer(true);this.setHeight("100%");this._aColumnKeys=[];this._mLazyColumnMap={};};r.prototype._getVariantManagementControl=function(s){var e=null;if(s){if(typeof s==='string'){e=sap.ui.getCore().byId(s);}else{e=s;}if(e){if(!(e instanceof S)){q.sap.log.error("Control with the id="+s.getId?s.getId():s+" not of expected type");return null;}}}return e;};r.prototype._createVariantManagementControl=function(){if(this._oVariantManagement||(!this.getUseVariantManagement()&&!this.getUseTablePersonalisation())||!this.getPersistencyKey()){return;}var e=new sap.ui.comp.smartvariants.PersonalizableInfo({type:"table",keyName:"persistencyKey",dataSource:"TODO"});e.setControl(this);var s=this.getSmartVariant();if(s){this._oVariantManagement=this._getVariantManagementControl(s);}else if(this._oSmartFilter&&this._oSmartFilter.data("pageVariantPersistencyKey")){s=this._oSmartFilter.getSmartVariant();if(s){this._oVariantManagement=this._getVariantManagementControl(s);}}else{this._oVariantManagement=new S(this.getId()+"-variant",{showShare:true});}if(this._oVariantManagement){this._oVariantManagement.addPersonalizableControl(e);this._oVariantManagement.attachAfterSave(this._variantAfterSave,this);this._oVariantManagement.initialise(this._variantInitialised,this);}};r.prototype._variantInitialised=function(){if(!this._oCurrentVariant){this._oCurrentVariant="STANDARD";}this.fireAfterVariantInitialise();if(this._oVariantManagement&&!this._oVariantManagement.getEnabled()){this._checkAndTriggerBinding();}};r.prototype._variantAfterSave=function(){this.fireAfterVariantSave({currentVariantId:this.getCurrentVariantId()});};r.prototype.setUseExportToExcel=function(u){if(u===this.getUseExportToExcel()){return;}this.setProperty("useExportToExcel",u,true);if(this.bIsInitialised&&this._oToolbar){this._createToolbarContent();}};r.prototype.setUseTablePersonalisation=function(u){this.setProperty("useTablePersonalisation",u,true);};r.prototype.setShowTablePersonalisation=function(s){this.setProperty("showTablePersonalisation",s,true);if(this._oTablePersonalisationButton){this._oTablePersonalisationButton.setVisible(s);}};r.prototype.setUseVariantManagement=function(u){this.setProperty("useVariantManagement",u,true);if(this._oPersController){this._oPersController.setResetToInitialTableState(!u);}};r.prototype.setShowVariantManagement=function(s){this.setProperty("showVariantManagement",s,true);if(this._oVariantManagement&&!this._oVariantManagement.isPageVariant()){this._oVariantManagement.setVisible(s);if(this._oSeparator){this._oSeparator.setVisible(s);}}};r.prototype.setToolbarStyleClass=function(s){this.setProperty("toolbarStyleClass",s,true);};r.prototype.setCustomToolbar=function(e){if(this._oCustomToolbar){this.removeItem(this._oCustomToolbar);}this._oCustomToolbar=e;};r.prototype.getCustomToolbar=function(){return this._oCustomToolbar;};r.prototype.setHeader=function(t){this.setProperty("header",t,true);this._refreshHeaderText();};r.prototype.setShowRowCount=function(s){this.setProperty("showRowCount",s,true);this._refreshHeaderText();};r.prototype.setShowFullScreenButton=function(s){this.setProperty("showFullScreenButton",s,true);if(this._oFullScreenButton){this._oFullScreenButton.setVisible(s);}};r.prototype.setEditTogglable=function(e){this.setProperty("editTogglable",e,true);if(this._oEditButton){this._oEditButton.setVisible(e);}};r.prototype.setEditable=function(e){this.setProperty("editable",e,true);if(this._oEditModel){this._oEditModel.setProperty("/editable",e);}if(this._oEditButton){this._oEditButton.setIcon(e?"sap-icon://display":"sap-icon://edit");}if(this._isMobileTable&&this._oTable.setKeyboardMode){this._oTable.setKeyboardMode(e?"Edit":"Navigation");}};r.prototype.setDemandPopin=function(D){var e=this.getDemandPopin();if(e===D){return;}this.setProperty("demandPopin",D,true);if(this.bIsInitialised){if(D){this._updateColumnsPopinFeature();}else{this._deactivateColumnsPopinFeature();}}};r.prototype._refreshHeaderText=function(){if(!this._headerText){return;}var t=this.getHeader();this._headerText.setVisible(!!t);if(this.getShowRowCount()){var i=parseInt(this._getRowCount(),10);q.sap.require("sap.ui.core.format.NumberFormat");var v=sap.ui.core.format.NumberFormat.getFloatInstance().format(i);t+=" ("+v+")";}this._headerText.setText(t);};r.prototype._addFullScreenButton=function(){if(this._oFullScreenButton){this._oToolbar.removeContent(this._oFullScreenButton);}if(this.getShowFullScreenButton()){if(!this._oFullScreenButton){this._oFullScreenButton=new c(this.getId()+"-btnFullScreen",{press:function(){this._toggleFullScreen(!this.bFullScreen);}.bind(this)});}this._toggleFullScreen(this.bFullScreen,true);this._oToolbar.addContent(this._oFullScreenButton);}};r.prototype._createToolbar=function(){var e=null;if(!this._oToolbar){e=this.getCustomToolbar();if(e){this._oToolbar=e;}else{this._oToolbar=new O({design:sap.m.ToolbarDesign.Transparent});this._oToolbar.addStyleClass("sapUiCompSmartTableToolbar");if(this.getToolbarStyleClass()){this._oToolbar.addStyleClass(this.getToolbarStyleClass());}}this._oToolbar.setLayoutData(new sap.m.FlexItemData({shrinkFactor:0}));this.insertItem(this._oToolbar,0);}};r.prototype._toggleFullScreen=function(v,e){var i=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp"),t;if(!this._oFullScreenButton||(v===this.bFullScreen&&!e)){return;}this.bFullScreen=v;if(!this._oFullScreenUtil){this._oFullScreenUtil=sap.ui.requireSync("sap/ui/comp/util/FullScreenUtil");}this._oFullScreenUtil.toggleFullScreen(this,this.bFullScreen,this._oFullScreenButton);t=this.bFullScreen?i.getText("CHART_MINIMIZEBTN_TOOLTIP"):i.getText("CHART_MAXIMIZEBTN_TOOLTIP");this._oFullScreenButton.setTooltip(t);this._oFullScreenButton.setText(t);this._oFullScreenButton.setIcon(this.bFullScreen?"sap-icon://exit-full-screen":"sap-icon://full-screen");};r.prototype._createToolbarContent=function(){if(!this._oToolbar){this._createToolbar();}this._addVariantManagementToToolbar();this._addSeparatorToToolbar();this._addHeaderToToolbar();this._addSpacerToToolbar();this._addEditTogglableToToolbar();this._addTablePersonalisationToToolbar();this._addExportToExcelToToolbar();this._addFullScreenButton();if(this._oToolbar&&(this._oToolbar.getContent().length===0||(this._oToolbar.getContent().length===1&&this._oToolbar.getContent()[0]instanceof sap.m.ToolbarSpacer))){this.removeItem(this._oToolbar);this._oToolbar.destroy();this._oToolbar=null;}};r.prototype._addEditTogglableToToolbar=function(){var B;if(this._oEditButton){this._oToolbar.removeContent(this._oEditButton);}if(this.getEditTogglable()){if(!this._oEditButton){B=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("TABLE_EDITTOGGLE_TOOLTIP");this._oEditButton=new sap.m.OverflowToolbarButton(this.getId()+"-btnEditToggle",{icon:this.getEditable()?"sap-icon://display":"sap-icon://edit",text:B,tooltip:B,press:function(){var e=this.getEditable();e=!e;this.setEditable(e,true);this.fireEditToggled({editable:e});}.bind(this)});}this._oToolbar.addContent(this._oEditButton);}};r.prototype._addHeaderToToolbar=function(){if(this._headerText){this._oToolbar.removeContent(this._headerText);}if(!this._headerText){this._headerText=new a(this.getId()+"-header");this._headerText.addStyleClass("sapMH4Style");this._headerText.addStyleClass("sapUiCompSmartTableHeader");}this._refreshHeaderText();this._oToolbar.insertContent(this._headerText,0);};r.prototype._addSeparatorToToolbar=function(){if(this._oSeparator){this._oToolbar.removeContent(this._oSeparator);}if(this.getHeader()&&this.getUseVariantManagement()&&this._oVariantManagement&&!this._oVariantManagement.isPageVariant()){if(!this._oSeparator){this._oSeparator=new d(this.getId()+"-toolbarSeperator");if(!this.getShowVariantManagement()){this._oSeparator.setVisible(false);}}this._oToolbar.insertContent(this._oSeparator,0);if(!this._oToolbar.getHeight()){this._oToolbar.addStyleClass("sapUiCompSmartTableToolbarHeight");}}};r.prototype._addVariantManagementToToolbar=function(){if(this._oVariantManagement&&!this._oVariantManagement.isPageVariant()){this._oToolbar.removeContent(this._oVariantManagement);if(this.getUseVariantManagement()){this._oToolbar.insertContent(this._oVariantManagement,0);if(!this._oVariantManagement.isPageVariant()){this._oVariantManagement.setVisible(this.getShowVariantManagement());}}}};r.prototype._addSpacerToToolbar=function(){var e=false,I=this._oToolbar.getContent(),i,s;if(I){s=I.length;i=0;for(i;i<s;i++){if(I[i]instanceof sap.m.ToolbarSpacer){e=true;break;}}}if(!e){this._oToolbar.addContent(new sap.m.ToolbarSpacer(this.getId()+"-toolbarSpacer"));}};r.prototype._addTablePersonalisationToToolbar=function(){var B;if(this._oTablePersonalisationButton){this._oToolbar.removeContent(this._oTablePersonalisationButton);}if(this.getUseTablePersonalisation()){if(!this._oTablePersonalisationButton){B=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("TABLE_PERSOBTN_TOOLTIP");this._oTablePersonalisationButton=new sap.m.OverflowToolbarButton(this.getId()+"-btnPersonalisation",{icon:"sap-icon://action-settings",text:B,tooltip:B,press:function(e){this._oPersController.openDialog();}.bind(this)});this._oTablePersonalisationButton.setVisible(this.getShowTablePersonalisation());}this._oToolbar.addContent(this._oTablePersonalisationButton);}};r.prototype._addExportToExcelToToolbar=function(){if(this._oUseExportToExcel){this._oToolbar.removeContent(this._oUseExportToExcel);}if(this.getUseExportToExcel()&&this._bTableSupportsExcelExport){var B;if(!this._oUseExportToExcel){B=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("TABLE_EXPORT_TEXT");this._oUseExportToExcel=new sap.m.OverflowToolbarButton(this.getId()+"-btnExcelExport",{icon:"sap-icon://excel-attachment",text:B,tooltip:B,press:function(e){var D=function(){var s=this._getRowBinding();var u=s.getDownloadUrl("xlsx");u=this._removeExpandParameter(u);if(u&&u.length>2048&&sap.ui.Device.browser.msie){M.error(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("DOWNLOAD_TOO_COMPLEX_TEXT"));return;}window.open(u);}.bind(this);var i=this._getRowCount();if(i>10000){M.confirm(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("DOWNLOAD_CONFIRMATION_TEXT",i),{actions:[M.Action.YES,M.Action.NO],onClose:function(s){if(s===M.Action.YES){D();}}});}else{D();}}.bind(this)});this._setExcelExportEnableState();}this._oToolbar.addContent(this._oUseExportToExcel);}};r.prototype._adjustUrlToVisibleColumns=function(u){var v=this._getVisibleColumnPaths().select;var s=u.replace(new RegExp("([\\?&]\\$select=)[^&]+"),function(e,i){if(v&&v.length){return i+q.sap.encodeURL(v.join(","));}else{return"";}});return s;};r.prototype._removeExpandParameter=function(u){var s=u.replace(new RegExp("([\\?&]\\$expand=[^&]+)(&?)"),function(e,i,t){return t?i.substring(0,1):"";});return s;};r.prototype._getRowCount=function(){var e=this._getRowBinding();if(!e){return 0;}var i=0;if(e.getTotalSize){i=e.getTotalSize();}else{i=e.getLength();}if(i<0||i==="0"){i=0;}return i;};r.prototype._setExcelExportEnableState=function(){if(this._oUseExportToExcel){var i=this._getRowCount();if(i>0){this._oUseExportToExcel.setEnabled(true);}else{var e;if(this._isMobileTable){e=this._oTable.getItems();}else{e=this._oTable.getRows();}var E=e!=null&&e.length>0&&e[0].getBindingContext()!=null;this._oUseExportToExcel.setEnabled(E);}}};r.prototype._createPersonalizationController=function(){if(this._oPersController||!this.getUseTablePersonalisation()){return;}var s=this._oP13nDialogSettings;s=this._setIgnoreFromPersonalisationToSettings(s);q.sap.require("sap.ui.comp.personalization.Controller");this._oPersController=new sap.ui.comp.personalization.Controller({table:this._oTable,columnKeys:this._aColumnKeys,setting:s,resetToInitialTableState:!this.getUseVariantManagement(),beforePotentialTableChange:this._beforePersonalisationModelDataChange.bind(this),afterPotentialTableChange:this._afterPersonalisationModelDataChange.bind(this),afterP13nModelDataChange:this._personalisationModelDataChange.bind(this),requestColumns:this._personalisationRequestColumns.bind(this)});};r.prototype._setIgnoreFromPersonalisationToSettings=function(s){var i=P.createArrayFromString(this.getIgnoreFromPersonalisation());if(i.length){if(!s){s={};}var e=function(t){if(!s[t]){s[t]={};}s[t].ignoreColumnKeys=i;};e("filter");e("sort");e("group");e("columns");}return s;};r.prototype._getRowBinding=function(){if(this._oTable){return this._oTable.getBinding(this._sAggregation);}};r.prototype.setEntitySet=function(e){this.setProperty("entitySet",e);this._initialiseMetadata();};r.prototype.propagateProperties=function(){f.prototype.propagateProperties.apply(this,arguments);this._initialiseMetadata();};r.prototype._initialiseMetadata=function(){if(!this.bIsInitialised){p.handleModelInit(this,this._onMetadataInitialised);}};r.prototype._onMetadataInitialised=function(){this._bMetaModelLoadAttached=false;if(!this.bIsInitialised){this._createTableProvider();if(this._oTableProvider){this._aTableViewMetadata=this._oTableProvider.getTableViewMetadata();if(this._aTableViewMetadata){if(!this._isMobileTable&&this.getDemandPopin()){this.setDemandPopin(false);q.sap.log.error("use SmartTable property 'demandPopin' only  with responsive table, property has been set to false");}this.bIsInitialised=true;this._bTableSupportsExcelExport=this._oTableProvider.getSupportsExcelExport();this._listenToSmartFilter();this._createVariantManagementControl();this._createToolbarContent();this._createContent();this._createPersonalizationController();this._oEditModel=new J({editable:this.getEditable()});this.setModel(this._oEditModel,"sm4rtM0d3l");this.fireInitialise();if(!this._oVariantManagement||(this._oVariantManagement&&this._bVariantInitialised)){this._checkAndTriggerBinding();}}}}};r.prototype._checkAndTriggerBinding=function(){if(!this._bAutoBindingTriggered){this._bAutoBindingTriggered=true;if(this.getEnableAutoBinding()){if(this._oSmartFilter){this._oSmartFilter.search();}else{this._reBindTable();}}}};r.prototype._createTableProvider=function(){var e,E,i;E=this.getEntitySet();i=this.getIgnoredFields();e=this.getModel();if(e&&E){if(this._aExistingColumns.length){if(i){i+=","+this._aExistingColumns.toString();}else{i=this._aExistingColumns.toString();}}this._oTableProvider=new sap.ui.comp.providers.TableProvider({entitySet:E,ignoredFields:i,initiallyVisibleFields:this.getInitiallyVisibleFields(),isEditableTable:this.getEditable(),isAnalyticalTable:!!this._isAnalyticalTable,isMobileTable:!!this._isMobileTable,dateFormatSettings:this.data("dateFormatSettings"),currencyFormatSettings:this.data("currencyFormatSettings"),defaultDropDownDisplayBehaviour:this.data("defaultDropDownDisplayBehaviour"),useSmartField:this.data("useSmartField"),useSmartToggle:this.data("useSmartToggle"),skipAnnotationParse:this.data("skipAnnotationParse"),lineItemQualifier:this.data("lineItemQualifier"),presentationVariantQualifier:this.data("presentationVariantQualifier"),enableInResultForLineItem:this.data("enableInResultForLineItem"),_semanticKeyAdditionalControl:this.getAggregation("semanticKeyAdditionalControl"),model:e,semanticObjectController:this.getSemanticObjectController()});}};r.prototype._listenToSmartFilter=function(){var s=null;s=this.getSmartFilterId();this._oSmartFilter=this._findControl(s);if(this._oSmartFilter){this._oSmartFilter.attachSearch(this._reBindTable,this);this._oSmartFilter.attachFilterChange(this._filterChangeEvent,this);this._oSmartFilter.attachCancel(this._cancelEvent,this);this._setNoDataText(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTTABLE_NO_DATA"));}};r.prototype._filterChangeEvent=function(){if(this._isTableBound()&&this._oSmartFilter&&!this._oSmartFilter.getLiveMode()){this._showOverlay(true);}};r.prototype._cancelEvent=function(){if(this._oSmartFilter&&!this._oSmartFilter.getLiveMode()){this._showOverlay(false);}};r.prototype._showOverlay=function(s){if(s){var e={show:true};this.fireShowOverlay({overlay:e});s=e.show;}this._oTable.setShowOverlay(s);};r.prototype._findControl=function(i){var e,v;if(i){e=sap.ui.getCore().byId(i);if(!e){v=this._getView();if(v){e=v.byId(i);}}}return e;};r.prototype._getView=function(){if(!this._oView){var e=this.getParent();while(e){if(e instanceof sap.ui.core.mvc.View){this._oView=e;break;}e=e.getParent();}}return this._oView;};r.prototype.rebindTable=function(e){this._reBindTable(null,e);};r.prototype._reBindTable=function(e,s){var t,u,v,i,w,x,y=[],z,E,B,D,G,H,I,K,N={},Q={preventTableBind:false};v=this._getTablePersonalisationData()||{};z=v.filters;E=v.excludeFilters;K=v.sorters;if(this._oSmartFilter){x=this._oSmartFilter.getFilters();N=this._oSmartFilter.getParameters()||{};}if(x&&x.length){if(E){y=[new sap.ui.model.Filter([x[0],E],true)];}else{y=x;}}else if(E){y=[E];}if(z){z=y.concat(z);}else{z=y;}B=this.getRequestAtLeastFields();if(B){D=B.split(",");}else{D=[];}D=D.concat(this._aAlwaysSelect);H=this._getVisibleColumnPaths();G=H["select"];if(!G||!G.length){G=D;}else{w=D.length;for(i=0;i<w;i++){if(G.indexOf(D[i])<0){G.push(D[i]);}}}if(this._sSelectForGroup&&G.indexOf(this._sSelectForGroup)<0){G.push(this._sSelectForGroup);}if(G.length){N["select"]=G.toString();I=H["expand"];if(I.length){N["expand"]=I.join(",");}}N["useBatchRequests"]=true;if(!K){K=[];}Q.filters=z;Q.sorter=K;Q.parameters=N;Q.length=undefined;Q.startIndex=undefined;this.fireBeforeRebindTable({bindingParams:Q});if(!Q.preventTableBind){K=Q.sorter;z=Q.filters;N=Q.parameters;G=Q.parameters["select"];if(!G||!G.length){M.error(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTTABLE_NO_COLS"),{styleClass:(this.$()&&this.$().closest(".sapUiSizeCompact").length)?"sapUiSizeCompact":""});return;}u=this.getTableBindingPath()||("/"+this.getEntitySet());this._oTable.setEnableBusyIndicator(false);this._oTable.setBusy(true);if(this._oTable.resumeUpdateAnalyticalInfo){this._oTable.resumeUpdateAnalyticalInfo(true,false);}this._bDataLoadPending=true;if(this._bForceTableUpdate){s=true;this._bForceTableUpdate=false;}if(!s){t=this._oTable.getBinding(this._sAggregation);if(t&&t.mParameters){s=!(q.sap.equal(N,t.mParameters,true)&&q.sap.equal(N.custom,t.mParameters.custom)&&!Q.length&&!Q.startIndex&&u===t.getPath());}}if(!t||!this._bIsTableBound||s){this._oTable.bindRows({path:u,filters:z,sorter:K,parameters:N,length:Q.length,startIndex:Q.startIndex,template:this._oTemplate,events:{dataRequested:function(){this._bIgnoreChange=true;}.bind(this),dataReceived:function(e){if(e&&e.getParameter&&!e.getParameter("data")){return;}this._bIgnoreChange=false;this._onDataLoadComplete(e,true);this.fireDataReceived(e);}.bind(this),change:function(e){if(this._bIgnoreChange){return;}var U,W=false;U=(e&&e.getParameter)?e.getParameter("reason"):undefined;if(!U||U==="filter"||U==="context"){W=true;}if(U==="change"||W){this._onDataLoadComplete(e,W);}}.bind(this)}});this._bIsTableBound=true;}else{if(Object.keys(z).length===0){z=[];}t.sort(K);t.filter(z,"Application");}this._showOverlay(false);}};r.prototype._onDataLoadComplete=function(e,i){if(this._bDataLoadPending||i){if(this._bDataLoadPending){this._oTable.setBusy(false);this._oTable.setEnableBusyIndicator(true);}this._bDataLoadPending=false;if(!this._bNoDataUpdated&&!this._getRowCount()){this._bNoDataUpdated=true;this._setNoDataText();}this.updateTableHeaderState();}};r.prototype._isTableBound=function(){if(this._bIsTableBound){return true;}if(this._oTable){return this._oTable.isBound(this._sAggregation);}return false;};r.prototype.setNoData=function(N){this._oNoData=N;};r.prototype.getNoData=function(){return this._oNoData;};r.prototype._setNoDataText=function(s){var e=this._oTable.setNoData;if(!e){e=this._oTable.setNoDataText;}if(!e){return;}var N=s;if(!N){N=this.getNoData();}if(!N){N=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTTABLE_NO_RESULTS");}e.call(this._oTable,N,true);};r.prototype.updateTableHeaderState=function(){this._refreshHeaderText();this._setExcelExportEnableState();};r.prototype._createContent=function(){var i,e=0,s,I,t;if(this._aExistingColumns&&this._aExistingColumns.length){this._aColumnKeys=this._aExistingColumns.reverse();}I=this._parseIndexedColumns();e=this._aTableViewMetadata.length;for(i=0;i<e;i++){s=this._aTableViewMetadata[i];if(s.inResult){this._aAlwaysSelect.push(s.name);}this._aColumnKeys.push(s.name);if(!(s.isInitiallyVisible||s.inResult)){this._mLazyColumnMap[s.name]=s;}else{t=this._createColumnForField(s);this._oTable.addColumn(t);}}this._insertIndexedColumns(I);this._updateColumnsPopinFeature();this._storeInitialColumnSettings();};r.prototype._createColumnForField=function(e){var i,I;I=this.getId()+"-"+e.name.replace(/[^A-Za-z0-9_.:-]+/g,"_");i=this._createColumn(e,I);e.isColumnCreated=true;i.data("p13nData",{columnKey:e.name,leadingProperty:e.name,additionalProperty:e.additionalProperty,navigationProperty:e.navigationProperty,sortProperty:e.sortable?e.name:undefined,filterProperty:e.filterable?e.name:undefined,fullName:e.hasValueListAnnotation?e.fullName:null,type:e.filterType,maxLength:e.maxLength,precision:e.precision,scale:e.scale,aggregationRole:e.aggregationRole});if(e.filterable&&i.setFilterProperty){i.setFilterProperty(e.name);}if(e.sortable&&i.setSortProperty){i.setSortProperty(e.name);}this._registerContentTemplateEvents(e.template);return i;};r.prototype._parseIndexedColumns=function(){var i,e,s,I,t,u,v,w,x;var y=this._oTable.getColumns();var z=null;if(this._oTemplate&&this._oTemplate.getCells){z=this._oTemplate.getCells();}if(!y){return null;}I=[];e=y.length;for(i=0;i<e;i++){s=y[i];t=s.data("p13nData");u=null;v=null;if(t){u=t.columnIndex;v=t.columnKey;}w=-1;if(u!==null&&u!==undefined){w=parseInt(u,10);}if(!isNaN(w)&&w>-1){if(z){x=z[i];this._oTemplate.removeCell(x);}else{x=null;}this._aColumnKeys.splice(i-I.length,1);I.push({index:w,columnKey:v,column:s,template:x});this._oTable.removeColumn(s);}}I.sort(function(B,D){return B.index-D.index;});return I;};r.prototype._insertIndexedColumns=function(I){var i,e,s;if(!I){return;}e=I.length;for(i=0;i<e;i++){s=I[i];this._aColumnKeys.splice(s.index,0,s.columnKey);this._oTable.insertColumn(s.column,s.index);if(s.template){this._oTemplate.insertCell(s.template,s.index);}}};r.prototype._updateColumnsPopinFeature=function(){if(!this._isMobileTable||!this.getDemandPopin()){return;}var e=this._oTable.getColumns();if(!e){return;}e=e.filter(function(u){return u.getVisible();});e.sort(function(u,v){return u.getOrder()-v.getOrder();});var s,t=e.length;for(var i=0;i<t;i++){s=e[i];if(i<2){s.setDemandPopin(false);s.setMinScreenWidth("1px");}else{s.setDemandPopin(true);s.setPopinDisplay(sap.m.PopinDisplay.Inline);s.setMinScreenWidth((i+1)*10+"rem");}}};r.prototype._storeInitialColumnSettings=function(){this._aInitialSorters=[];P.createSort2Json(this._oTable,this._aInitialSorters,P.createArrayFromString(this.getIgnoreFromPersonalisation()));};r.prototype._deactivateColumnsPopinFeature=function(){if(!this._isMobileTable){return;}var e=this._oTable.getColumns();if(!e){return;}var s,t=e.length;for(var i=0;i<t;i++){s=e[i];s.setDemandPopin(false);s.setMinScreenWidth("1px");}};r.prototype._registerContentTemplateEvents=function(t){if(t&&t.attachChange){t.attachChange(function(e){this.fireFieldChange({changeEvent:e});}.bind(this));}};r.prototype._updateInitialColumns=function(){var i=this._oTable.getColumns(),s=i?i.length:0,t,u,v;while(s--){v=null;t=i[s];if(t){u=t.data("p13nData");if(typeof u==="string"){try{u=JSON.parse(u);}catch(e){}if(u){t.data("p13nData",u);}}if(u){v=u["columnKey"];}if(v){this._aExistingColumns.push(v);}}}};r.prototype._getVisibleColumnPaths=function(){var e={},s=[],E=[],t=this._oTable.getColumns(),i,u=t?t.length:0,v,w,x,y,z;var B=function(x,D){var G,H;if(x){H=x.split(",");G=H.length;while(G--){x=H[G];if(x&&D.indexOf(x)<0){D.push(x);}}}};for(i=0;i<u;i++){v=t[i];x=null;if(v.getVisible()){if(v.getLeadingProperty){x=v.getLeadingProperty();}w=v.data("p13nData");if(w){if(!x){x=w["leadingProperty"];}y=w["additionalProperty"];z=w["navigationProperty"];}if(x&&s.indexOf(x)<0){s.push(x);}B(y,s);B(z,E);}}e["select"]=s;e["expand"]=E;return e;};r.prototype._createTable=function(){var e=this.getItems(),i=e?e.length:0,t,I;this._sAggregation="rows";while(i--){t=e[i];if(t instanceof m||t instanceof R){break;}t=null;}if(t){this._oTable=t;if(t instanceof j){this._isAnalyticalTable=true;}else if(t instanceof R){this._isMobileTable=true;this._oTemplate=(t.getItems()&&t.getItems().length>0)?t.getItems()[0]:new sap.m.ColumnListItem();t.removeAllItems();}else if(t instanceof n){this._isTreeTable=true;}this._updateInitialColumns();}else{I=this.getId()+"-ui5table";if(this.getTableType()==="AnalyticalTable"){this._isAnalyticalTable=true;this._oTable=new j(I,{enableCustomFilter:true});}else if(this.getTableType()==="ResponsiveTable"){this._isMobileTable=true;this._oTable=new R(I,{growing:true});this._oTemplate=new sap.m.ColumnListItem();}else if(this.getTableType()==="TreeTable"){this._isTreeTable=true;this._oTable=new n(I,{selectionMode:sap.ui.table.SelectionMode.MultiToggle});}else{this._oTable=new m(I,{selectionMode:sap.ui.table.SelectionMode.MultiToggle});}if(this._oTable.setVisibleRowCountMode){this._oTable.setVisibleRowCountMode(sap.ui.table.VisibleRowCountMode.Auto);}this.insertItem(this._oTable,2);}if(!this._oTable.getLayoutData()){if(this._oTable instanceof sap.m.Table||(this._oTable.getVisibleRowCountMode&&this._oTable.getVisibleRowCountMode()!==sap.ui.table.VisibleRowCountMode.Auto)){this._oTable.setLayoutData(new sap.m.FlexItemData({growFactor:1,baseSize:"auto"}));}else{this._oTable.setLayoutData(new sap.m.FlexItemData({growFactor:1,baseSize:"0%"}));}}if(this._oTable.addAriaLabelledBy){this._oTable.addAriaLabelledBy(this.getId()+"-header");}this._oTable.addStyleClass("sapUiCompSmartTableInnerTable");this._oTable.setEnableBusyIndicator(true);this._oTable.setBusyIndicatorDelay(100);if(this._oTable.setEnableCustomFilter){this._oTable.setEnableCustomFilter(this.getEnableCustomFilter());}if(this._oTable.setShowColumnVisibilityMenu){this._oTable.setShowColumnVisibilityMenu(false);}if(this._oTable.getEnableCustomFilter&&this._oTable.getEnableCustomFilter()&&this._bIsFilterPanelEnabled){if(this._oTable.setEnableCellFilter){this._oTable.setEnableCellFilter(false);}if(this._oTable.attachCustomFilter){this._oTable.attachCustomFilter(this._showTableFilterDialog.bind(this));}}if(this._isAnalyticalTable){this._createColumn=this._createAnalyticalColumn;}else if(this._isMobileTable){this._sAggregation="items";this._createColumn=this._createMobileColumn;this._oTable.bindRows=this._oTable.bindItems;}if(!this._isMobileTable){this._oTable.attachEvent("_rowsUpdated",function(){this._setExcelExportEnableState();},this);}if(this._oTable._setLargeDataScrolling){this._oTable._setLargeDataScrolling(true);}};r.prototype.getTable=function(){return this._oTable;};r.prototype._showTableFilterDialog=function(e){if(this._oPersController){this._oPersController.openDialog({filter:{visible:true,payload:{column:e.getParameter("column")}}});}};r.prototype._createColumn=function(e,i){var s;s=new k(i,{autoResizable:true,hAlign:e.align,width:e.width,visible:e.isInitiallyVisible,label:new L(i+"-header",{textAlign:e.align,text:e.label}),sorted:e.sorted,sortOrder:e.sortOrder,tooltip:e.quickInfo,showSortMenuEntry:e.sortable,showFilterMenuEntry:e.filterable&&this._bIsFilterPanelEnabled,name:e.fieldName,template:e.template});return s;};r.prototype._createAnalyticalColumn=function(e,i){var s;if(e.isCurrencyField&&e.template.addStyleClass){e.template.addStyleClass("sapUiCompCurrencyBold");}s=new A(i,{autoResizable:true,hAlign:e.align,width:e.width,visible:e.isInitiallyVisible,inResult:e.inResult,label:new L(i+"-header",{textAlign:e.align,text:e.label}),tooltip:e.quickInfo,sorted:e.sorted,sortOrder:e.sortOrder,grouped:e.grouped,showIfGrouped:e.grouped,showSortMenuEntry:e.sortable,showFilterMenuEntry:e.filterable&&this._bIsFilterPanelEnabled,summed:e.summed,leadingProperty:e.name,template:e.template});return s;};r.prototype._createMobileColumn=function(e,i){var s;s=new C(i,{hAlign:e.align,visible:e.isInitiallyVisible,header:new T(i+"-header",{textAlign:e.align,text:e.label,tooltip:e.quickInfo}),tooltip:e.quickInfo,width:e.isImageURL?"3em":undefined});if(this._oTemplate){this._oTemplate.addCell(e.template);}return s;};r.prototype.fetchVariant=function(){if(this._oCurrentVariant==="STANDARD"||this._oCurrentVariant===null){return{};}return this._oCurrentVariant;};r.prototype.applyVariant=function(v,s){this._oCurrentVariant=v;if(this._oCurrentVariant==="STANDARD"){this._oCurrentVariant=null;}P.recoverPersonalisationDateData(this._oCurrentVariant,this._oTable);if(s==="STANDARD"){this._oApplicationDefaultVariant=this._oCurrentVariant;}if(this._oApplicationDefaultVariant&&!s){this._oCurrentVariant=q.extend(true,{},this._oApplicationDefaultVariant,v);}this._bApplyingVariant=true;if(this._oTable._setSuppressRefresh){this._oTable._setSuppressRefresh(true);}if(this._oPersController){if(this._oCurrentVariant===null||q.isEmptyObject(this._oCurrentVariant)){this._oPersController.resetPersonalization(sap.ui.comp.personalization.ResetType.ResetFull);}else{this._oPersController.setPersonalizationData(this._oCurrentVariant);}}this._bApplyingVariant=false;this.fireAfterVariantApply({currentVariantId:this.getCurrentVariantId()});};r.prototype.variantsInitialized=function(){this._bVariantInitialised=true;this._checkAndTriggerBinding();};r.prototype._personalisationRequestColumns=function(e){var s=e.getParameter("columnKeys"),t,i,u,v,w,x={};u=s.length;for(i=0;i<u;i++){t=s[i];v=this._mLazyColumnMap[t];if(v){w=this._createColumnForField(v);if(this._isMobileTable){this._oTable.addColumn(w);}x[v.name]=w;}}this._oPersController.addColumns(x);};r.prototype._beforePersonalisationModelDataChange=function(e){if(this._oTable.suspendUpdateAnalyticalInfo){this._oTable.suspendUpdateAnalyticalInfo();}};r.prototype._afterPersonalisationModelDataChange=function(e){this._updateColumnsPopinFeature();};r.prototype._personalisationModelDataChange=function(e){this._oCurrentVariant=e.getParameter("persistentData");var i=e.getParameter("changeType");var s=this._getChangeStatus(i);if(s===sap.ui.comp.personalization.ChangeType.Unchanged){return;}if(!this._bApplyingVariant){if(!this.getUseVariantManagement()){this._persistPersonalisation();}else if(this._oVariantManagement){this._oVariantManagement.currentVariantSetModified(true);}}if(s===sap.ui.comp.personalization.ChangeType.ModelChanged&&this._isTableBound()){if(i&&i.columns===sap.ui.comp.personalization.ChangeType.ModelChanged){this._bForceTableUpdate=true;}if(this._oSmartFilter){this._oSmartFilter.search();}else{this._reBindTable(null);}}};r.prototype._getChangeStatus=function(e){if(!e){return sap.ui.comp.personalization.ChangeType.ModelChanged;}if(e.sort===sap.ui.comp.personalization.ChangeType.ModelChanged||e.filter===sap.ui.comp.personalization.ChangeType.ModelChanged||e.columns===sap.ui.comp.personalization.ChangeType.ModelChanged||e.group===sap.ui.comp.personalization.ChangeType.ModelChanged){return sap.ui.comp.personalization.ChangeType.ModelChanged;}if(e.sort===sap.ui.comp.personalization.ChangeType.TableChanged||e.filter===sap.ui.comp.personalization.ChangeType.TableChanged||e.columns===sap.ui.comp.personalization.ChangeType.TableChanged||e.group===sap.ui.comp.personalization.ChangeType.TableChanged){return sap.ui.comp.personalization.ChangeType.TableChanged;}return sap.ui.comp.personalization.ChangeType.Unchanged;};r.prototype._getTablePersonalisationData=function(){if(!this._oCurrentVariant){return null;}var s=[],e=[],E=[],i,G,t,u,v,w,x,y,z="",I;this._sSelectForGroup=null;if(this._isMobileTable&&this._oCurrentVariant.group&&this._oCurrentVariant.group.groupItems){G=this._oCurrentVariant.group.groupItems[0];v=this._getColumnByKey(G.columnKey);if(v){z=v.getHeader().getText();}y=this._getPathFromColumnKeyAndProperty(G.columnKey,"sortProperty");x=y;t=new sap.ui.model.Sorter(x,G.operation==="GroupDescending",function(B){var K=B.getProperty(x);return{key:K,text:z?z+" : "+K:K};});this._sSelectForGroup=x;s.push(t);}if(this._oCurrentVariant.sort){u=this._oCurrentVariant.sort.sortItems;}else{u=this._aInitialSorters;}if(u){u.forEach(function(B){var D=B.operation==="Descending";y=this._getPathFromColumnKeyAndProperty(B.columnKey,"sortProperty");if(t&&t.sPath===y){t.bDescending=D;}else{s.push(new sap.ui.model.Sorter(y,D));}},this);}if(this._oCurrentVariant.filter){this._oCurrentVariant.filter.filterItems.forEach(function(B){var D=B.value1,H=B.value2;y=null;I=false;v=this._getColumnByKey(B.columnKey);if(v){if(v.getFilterProperty){y=v.getFilterProperty();}w=v.data("p13nData");if(w){I=w.type==="time";if(!y){y=w["filterProperty"];}}}if(I){if(D instanceof Date){D=o.getEdmTimeFromDate(D);}if(H instanceof Date){H=o.getEdmTimeFromDate(H);}}else if(D instanceof Date&&this._oTableProvider&&this._oTableProvider.getIsUTCDateHandlingEnabled()){D=F.getDateInUTCOffset(D);H=H?F.getDateInUTCOffset(H):H;}if(B.exclude){E.push(new sap.ui.model.Filter(y,h.NE,D));}else{e.push(new sap.ui.model.Filter(y,B.operation,D,H));}},this);if(E.length){i=new sap.ui.model.Filter(E,true);}}return{filters:e,excludeFilters:i,sorters:s};};r.prototype._getColumnByKey=function(s){var e,t,u,i,v;if(this._oTable){e=this._oTable.getColumns();u=e.length;for(i=0;i<u;i++){t=e[i];v=t.data("p13nData");if(v&&v.columnKey===s){return t;}}}return null;};r.prototype._getPathFromColumnKeyAndProperty=function(s,e){var i=null,t,u;t=this._getColumnByKey(s);if(t){if(e=="sortProperty"&&t.getSortProperty){i=t.getSortProperty();}else if(e=="filterProperty"&&t.getFilterProperty){i=t.getFilterProperty();}else if(e=="leadingProperty"&&t.getLeadingProperty){i=t.getLeadingProperty();}if(!i){u=t.data("p13nData");if(u){i=u[e];}}}return i;};r.prototype._persistPersonalisation=function(){if(this._oVariantManagement&&!this._oVariantManagement.isPageVariant()){this._oVariantManagement.getVariantsInfo(function(v){var e,s=null;if(v&&v.length>0){s=v[0].key;}e=s!==null;this._oVariantManagement.fireSave({name:"Personalisation",global:false,overwrite:e,key:s,def:true});}.bind(this));}};r.prototype.getCurrentVariantId=function(){var K="";if(this._oVariantManagement){K=this._oVariantManagement.getCurrentVariantId();}return K;};r.prototype.setCurrentVariantId=function(v){if(this._oVariantManagement&&!this._oVariantManagement.isPageVariant()){this._oVariantManagement.setCurrentVariantId(v);}else{q.sap.log.error("sap.ui.comp.smarttable.SmartTable.prototype.setCurrentVariantId: VariantManagement does not exist, or is a page variant");}};r.prototype.isInitialised=function(){return!!this.bIsInitialised;};r.prototype.exit=function(){var i,e;if(this._oSmartFilter){this._oSmartFilter.detachSearch(this._reBindTable,this);this._oSmartFilter.detachFilterChange(this._filterChangeEvent,this);this._oSmartFilter.detachCancel(this._cancelEvent,this);this._oSmartFilter=null;}if(this._oTableProvider&&this._oTableProvider.destroy){this._oTableProvider.destroy();}this._oTableProvider=null;if(this._oPersController&&this._oPersController.destroy){this._oPersController.destroy();}this._oPersController=null;if(this._oVariantManagement){this._oVariantManagement.detachAfterSave(this._variantAfterSave,this);if(!this._oVariantManagement.isPageVariant()&&this._oVariantManagement.destroy){this._oVariantManagement.destroy();}}if(this._oFullScreenUtil){this._oFullScreenUtil.cleanUpFullScreen(this);this._oFullScreenUtil=null;}if(this._oEditModel){this._oEditModel.destroy();}if(this._oNoData&&this._oNoData.destroy){this._oNoData.destroy();}this.oNoData=null;if(this._aTableViewMetadata){i=this._aTableViewMetadata.length;while(i--){e=this._aTableViewMetadata[i];if(e&&!e.isColumnCreated&&e.template){e.template.destroy();}}}this._aTableViewMetadata=null;this._oEditModel=null;this._oVariantManagement=null;this._oCurrentVariant=null;this._oApplicationDefaultVariant=null;this._aExistingColumns=null;this._mLazyColumnMap=null;this._aColumnKeys=null;this._aAlwaysSelect=null;this._oCustomToolbar=null;this._oToolbar=null;if(this._oUseExportToExcel&&!this.getUseExportToExcel()){this._oUseExportToExcel.destroy();}this._oUseExportToExcel=null;this._oTablePersonalisationButton=null;this._oP13nDialogSettings=null;if(!this._bIsTableBound&&this._oTemplate){this._oTemplate.destroy();}this._oTemplate=null;this._oView=null;this._oTable=null;};return r;},true);
