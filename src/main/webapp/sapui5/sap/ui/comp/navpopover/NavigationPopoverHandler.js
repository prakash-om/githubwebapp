/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/comp/library',"sap/ui/base/ManagedObject",'./SemanticObjectController','sap/ui/model/json/JSONModel','sap/ui/core/Control','./Factory','./NavigationPopover','./Util','sap/m/VBox','./LinkData','sap/m/MessageBox','sap/ui/comp/navpopover/SelectionController'],function(q,C,M,S,J,a,F,N,U,V,L,b,c){"use strict";var d=M.extend("sap.ui.comp.navpopover.NavigationPopoverHandler",{metadata:{library:"sap.ui.comp",properties:{semanticObject:{type:"string",defaultValue:null},additionalSemanticObjects:{type:"string[]",defaultValue:[]},semanticObjectController:{type:"any",defaultValue:null},fieldName:{type:"string",defaultValue:null},semanticObjectLabel:{type:"string",defaultValue:null},mapFieldToSemanticObject:{type:"boolean",defaultValue:true},semanticAttributes:{type:"object",visibility:"hidden",defaultValue:null},contactAnnotationPath:{type:"string",defaultValue:undefined},enableAvailableActionsPersonalization:{type:"boolean",defaultValue:true}},associations:{control:{type:"sap.ui.core.Control",multiple:false}},events:{beforePopoverOpens:{parameters:{semanticObject:{type:"string"},semanticAttributes:{type:"object"},semanticAttributesOfSemanticObjects:{type:"object"},setSemanticAttributes:{type:"function"},setAppStateKey:{type:"function"},originalId:{type:"string"},open:{type:"function"}}},navigationTargetsObtained:{parameters:{mainNavigation:{type:"sap.ui.comp.navpopover.LinkData"},actions:{type:"sap.ui.comp.navpopover.LinkData[]"},ownNavigation:{type:"sap.ui.comp.navpopover.LinkData"},popoverForms:{type:"sap.ui.layout.form.SimpleForm[]"},semanticObject:{type:"string"},semanticAttributes:{type:"object"},originalId:{type:"string"},show:{type:"function"}}},innerNavigate:{parameters:{text:{type:"string"},href:{type:"string"},semanticObject:{type:"string"},semanticAttributes:{type:"object"},originalId:{type:"string"}}}}}});d.prototype.init=function(){this._oPopover=null;var m=new J({semanticObject:undefined,semanticObjectLabel:undefined,semanticAttributes:undefined,appStateKey:undefined,mainNavigationId:undefined,contact:{exists:false,bindingPath:undefined,expand:undefined,select:undefined},navigationTarget:{mainNavigation:undefined,availableActionsPersonalizationText:undefined,extraContent:undefined},availableActions:[]});m.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);m.setSizeLimit(1000);this.setModel(m,"$sapuicompNavigationPopoverHandler");};d.prototype.applySettings=function(s){M.prototype.applySettings.apply(this,arguments);this.setSemanticAttributes(this._calculateSemanticAttributes());};d.prototype.openPopover=function(){var t=this;return new Promise(function(r){t._getPopover().then(function(p){if(!p.hasContent()){t._showErrorDialog(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_DETAILS_NAV_NOT_POSSIBLE"),sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_MSG_NAV_NOT_POSSIBLE"),p);t._destroyPopover();return r();}var l=p.getDirectLink();if(l){t._fireInnerNavigate({text:l.getText(),href:l.getHref()});window.location.href=l.getHref();return r();}q.sap.delayedCall(0,this,function(){p.show();return r();});});});};d.prototype.getSemanticObjectValue=function(){var s=this.getSemanticAttributes();if(s){return s[this.getSemanticObject()][this.getSemanticObject()];}return undefined;};d.prototype.getNavigationPopoverStableId=function(){var A=this._getAppComponent();var s=this.getModel("$sapuicompNavigationPopoverHandler").getProperty("/semanticObject");if(!A||!s){return undefined;}var e=[s].concat(this.getAdditionalSemanticObjects());U.sortArrayAlphabetical(e);var f=e.join("--");return"sapuicompnavpopoverNavigationPopover---"+A.getId()+"---"+f;};d.prototype.updateBindingContext=function(){a.prototype.updateBindingContext.apply(this,arguments);this.setSemanticAttributes(this._calculateSemanticAttributes());this._destroyPopover();};d.prototype.setSemanticObjectLabel=function(l){this.setProperty("semanticObjectLabel",l);var m=this.getModel("$sapuicompNavigationPopoverHandler");m.setProperty("/semanticObjectLabel",l);return this;};d.prototype.setSemanticObject=function(s){this._destroyPopover();this.setProperty("semanticObject",s);var m=this.getModel("$sapuicompNavigationPopoverHandler");m.setProperty("/semanticObject",s);this.setSemanticAttributes(this._calculateSemanticAttributes());return this;};d.prototype.setSemanticAttributes=function(s){this.setProperty("semanticAttributes",s);var m=this.getModel("$sapuicompNavigationPopoverHandler");m.setProperty("/semanticAttributes",s);return this;};d.prototype.setFieldName=function(f){this.setProperty("fieldName",f);this.setSemanticAttributes(this._calculateSemanticAttributes());return this;};d.prototype.setControl=function(o){this.setAssociation("control",o);this.setModel(o.getModel());this._destroyPopover();this._updateSemanticObjectController();this.setSemanticAttributes(this._calculateSemanticAttributes());return this;};d.prototype.setMapFieldToSemanticObject=function(m){this.setProperty("mapFieldToSemanticObject",m);this.setSemanticAttributes(this._calculateSemanticAttributes());return this;};d.prototype.setSemanticObjectController=function(s){this._updateSemanticObjectController(s);this.setSemanticAttributes(this._calculateSemanticAttributes());return this;};d.prototype.exit=function(){this._destroyPopover();if(this.getSemanticObjectController()){this.getSemanticObjectController().unregisterControl(this);}if(this.getModel("$sapuicompNavigationPopoverHandler")){this.getModel("$sapuicompNavigationPopoverHandler").destroy();}};d.prototype._initModel=function(){var t=this;this.setSemanticAttributes(this._calculateSemanticAttributes());var s=this.getSemanticAttributes();var e=this.getSemanticObject();var A=this.getAdditionalSemanticObjects();var f=this.getContactAnnotationPath();if(f===undefined&&this.getSemanticObjectController()&&this.getSemanticObjectController().getContactAnnotationPaths()&&this.getSemanticObjectController().getContactAnnotationPaths()[this.getFieldName()]!==undefined){f=this.getSemanticObjectController().getContactAnnotationPaths()[this.getFieldName()];}var o=sap.ui.getCore().byId(this.getControl());var B=o&&o.getBindingContext()?o.getBindingContext().getPath():null;var O=this.getModel();var g=this._getComponent();var i=o&&o.getId();var m,h;var E=this.getEnableAvailableActionsPersonalization();if(this.getSemanticObjectController()&&this.getSemanticObjectController().getEnableAvailableActionsPersonalization()&&this.getSemanticObjectController().getEnableAvailableActionsPersonalization()[this.getFieldName()]!==undefined){E=this.getSemanticObjectController().getEnableAvailableActionsPersonalization()[this.getFieldName()];}return new Promise(function(r){t._fireBeforePopoverOpens(s,e,i).then(function(R){t.setSemanticAttributes(R.semanticAttributes);m=h=t.getSemanticObjectValue();t.getModel("$sapuicompNavigationPopoverHandler").setProperty("/appStateKey",R.appStateKey);t._prepareFormsAndTargets(e,A,R.appStateKey,g,R.semanticAttributes,m,O,B,f,h).then(function(j){t._fireNavigationTargetsObtained(m,e,R.semanticAttributes,i,j[0].forms,j[1]).then(function(k){var l=t.getModel("$sapuicompNavigationPopoverHandler");l.setProperty("/mainNavigationId",k.mainNavigationId);l.setProperty("/navigationTarget/mainNavigation",k.mainNavigation);l.setProperty("/navigationTarget/extraContent",k.extraContent);l.setProperty("/contact/exists",!!j[0].forms.length);l.setProperty("/contact/bindingPath",j[0].bindingPath);l.setProperty("/contact/expand",j[0].expand);l.setProperty("/contact/select",j[0].select);var n=t._updateVisibilityOfAvailableActions(L.convert2Json(k.availableActions));l.setProperty("/availableActions",n);l.setProperty("/navigationTarget/availableActionsPersonalizationText",E?sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_DEFINE_LINKS"):undefined);return r();});});});});};d.prototype._initPopover=function(){var t=this;return new Promise(function(r){t._initModel().then(function(){var m=t.getModel("$sapuicompNavigationPopoverHandler");var p=t._createPopover();if(m.getProperty("/contact/exists")){var o=sap.ui.getCore().byId(t.getControl());var B=o&&o.getBindingContext()?o.getBindingContext().getPath():null;if(m.getProperty("/contact/bindingPath")){p.bindContext({path:m.getProperty("/contact/bindingPath"),events:{change:function(){p.invalidate();}}});}else if(B){p.bindContext({path:B,parameters:{expand:m.getProperty("/contact/expand"),select:m.getProperty("/contact/select")},events:{change:function(){p.invalidate();}}});}}return r(p);});});};d.prototype._getPopover=function(){var t=this;return new Promise(function(r){if(!t._oPopover){t._initPopover().then(function(p){return r(p);});}else{return r(t._oPopover);}});};d.prototype._destroyPopover=function(){if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}};d.prototype._createPopover=function(){if(this._oPopover){return this._oPopover;}var m=this.getModel("$sapuicompNavigationPopoverHandler");this._oPopover=new N(this.getNavigationPopoverStableId(),{title:"{$sapuicompNavigationPopoverHandler>/semanticObjectLabel}",mainNavigationId:"{$sapuicompNavigationPopoverHandler>/mainNavigationId}",semanticObjectName:"{$sapuicompNavigationPopoverHandler>/semanticObject}",semanticAttributes:"{$sapuicompNavigationPopoverHandler>/semanticAttributes}",appStateKey:"{$sapuicompNavigationPopoverHandler>/appStateKey}",mainNavigation:m.getProperty("/navigationTarget/mainNavigation"),availableActions:{path:'$sapuicompNavigationPopoverHandler>/availableActions',templateShareable:false,template:new L({key:"{$sapuicompNavigationPopoverHandler>key}",href:"{$sapuicompNavigationPopoverHandler>href}",text:"{$sapuicompNavigationPopoverHandler>text}",target:"{$sapuicompNavigationPopoverHandler>target}",description:"{$sapuicompNavigationPopoverHandler>description}",visible:"{$sapuicompNavigationPopoverHandler>visible}"})},extraContent:m.getProperty("/navigationTarget/extraContent")?m.getProperty("/navigationTarget/extraContent").getId():undefined,availableActionsPersonalizationText:m.getProperty("/navigationTarget/availableActionsPersonalizationText"),source:this.getControl(),component:this._getComponent(),navigate:q.proxy(this._onNavigate,this),availableActionsPersonalizationPress:q.proxy(this._onAvailableActionsPersonalizationPress,this),afterClose:q.proxy(this._destroyPopover,this)});this._oPopover.setModel(m,"$sapuicompNavigationPopoverHandler");var o=sap.ui.getCore().byId(this.getControl());if(o){o.addDependent(this._oPopover);}return this._oPopover;};d.prototype._prepareFormsAndTargets=function(s,A,e,o,f,m,O,B,g,h){var p=new Promise(function(r){U.retrieveContactAnnotationData(O,B,g).then(function(i){var j=U.parseContactAnnotation(i);return r({bindingPath:i.entitySet?"/"+i.entitySet+"('"+h+"')":undefined,expand:j.expand,select:j.select,forms:U.createContactDetailForms(j.groups)});});});var P=new Promise(function(r){U.retrieveNavigationTargets(s,A,e,o,f,m).then(function(n){return r(n);});});return Promise.all([p,P]);};d.prototype._fireBeforePopoverOpens=function(s,e,i){var t=this;return new Promise(function(r){var R={semanticAttributes:s,appStateKey:undefined};if(!t.hasListeners("beforePopoverOpens")){return r(R);}t.fireBeforePopoverOpens({originalId:i,semanticObject:e,semanticAttributes:s?s[e]:s,semanticAttributesOfSemanticObjects:s,setSemanticAttributes:function(f,g){g=g||e;R.semanticAttributes=R.semanticAttributes||{};R.semanticAttributes[g]=f;},setAppStateKey:function(A){R.appStateKey=A;},open:function(){return r(R);}});});};d.prototype._fireNavigationTargetsObtained=function(m,s,o,i,f,n){var t=this;return new Promise(function(r){var R={mainNavigationId:m,mainNavigation:n.mainNavigation,availableActions:n.availableActions,ownNavigation:n.ownNavigation,extraContent:f.length?new V({items:f}):undefined};if(!t.hasListeners("navigationTargetsObtained")){return r(R);}t.fireNavigationTargetsObtained({mainNavigation:n.mainNavigation,actions:n.availableActions,ownNavigation:n.ownNavigation,popoverForms:f,semanticObject:s,semanticAttributes:o?o[s]:o,originalId:i,show:function(m,e,A,g){if(!(typeof m==="string"||e instanceof sap.ui.comp.navpopover.LinkData||q.isArray(A))&&g===undefined){g=A;A=e;e=m;m=undefined;}if(m!==undefined&&m!==null){R.mainNavigationId=m;}if(e!==undefined){R.mainNavigation=e;}if(A){R.availableActions=A;}if(g){R.extraContent=g;}return r(R);}});});};d.prototype._onNavigate=function(e){var p=e.getParameters();this._fireInnerNavigate({text:p.text,href:p.href});};d.prototype._onAvailableActionsPersonalizationPress=function(e){var t=this;var n=e.getSource();var v=n.getAvailableActions().map(function(A){return{availableAction:A,visible:A.getVisible()};});var m=U.availableAction2MItems(n);var f=U.availableAction2MColumnsItems(n);this._oPopover.setModal(true);new c().openSelectionDialog(m,f,n).then(function(o){t._oPopover.setModal(false);F.getService("FlexConnector").createAndSaveChangesForControl(o,n).then(function(){})['catch'](function(E){v.forEach(function(O){O.availableAction.setVisible(O.visible);n._syncAvailableAction(O.availableAction);});q.sap.log.error("Changes could not be saved in LRep: "+E);});})['catch'](function(){t._oPopover.setModal(false);});};d.prototype._fireInnerNavigate=function(p){var o=sap.ui.getCore().byId(this.getControl());var s=this.getSemanticObject();var e=this.getSemanticAttributes();this.fireInnerNavigate({text:p.text,href:p.href,originalId:o?o.getId():undefined,semanticObject:s,semanticAttributes:e?e[s]:e});};d.prototype._getComponent=function(){var o=sap.ui.getCore().byId(this.getControl());if(!o){return null;}var p=o.getParent();while(p){if(p instanceof sap.ui.core.Component){if(p&&p.getAppComponent){p=p.getAppComponent();}return p;}p=p.getParent();}return null;};d.prototype._getAppComponent=function(){return F.getService("FlexConnector").getAppComponentForControl(sap.ui.getCore().byId(this.getControl()));};d.prototype._calculateSemanticAttributes=function(){var o=sap.ui.getCore().byId(this.getControl());var B=this.getBindingContext()||(o&&o.getBindingContext());if(!B){return null;}var r={};var s=this.getFieldName();var e=B.getObject(B.getPath());for(var A in e){if(A==="__metadata"){continue;}if(!e[A]){continue;}var f=A;if(this.getMapFieldToSemanticObject()){f=this._mapFieldToSemanticObject(A);}var g=e[A];if(r[f]){if(e[s]){g=e[s];}}r[f]=g;}var R={};["",this.getSemanticObject()].concat(this.getAdditionalSemanticObjects()).forEach(function(h){R[h]=r;});return R;};d.prototype._mapFieldToSemanticObject=function(f){if(this.getFieldName()===f&&this.getSemanticObject()){return this.getSemanticObject();}var s=this.getSemanticObjectController();if(!s){return f;}var m=s.getFieldSemanticObjectMap();if(!m){return f;}return m[f]||f;};d.prototype._updateSemanticObjectController=function(o){var e=this.getProperty("semanticObjectController");var f=sap.ui.getCore().byId(this.getControl());o=o||this.getSemanticObjectController()||this._getSemanticObjectControllerOfControl(f);if(o&&f&&o.isControlRegistered(f)){o.unregisterControl(this);}if(o!==e&&e){e.unregisterControl(this);}this.setProperty("semanticObjectController",o);if(o&&!o.isControlRegistered(f)){o.registerControl(this);}};d.prototype._getSemanticObjectControllerOfControl=function(o){if(!o){return undefined;}var s;var p=o.getParent();while(p){if(p.getSemanticObjectController){s=p.getSemanticObjectController();if(s){this.setSemanticObjectController(s);break;}}p=p.getParent();}return s;};d.prototype._updateVisibilityOfAvailableActions=function(A){if(A.length>10){A.forEach(function(o){o.visible=false;});}return A;};d.prototype._showErrorDialog=function(t,T,o){b.show(t,{icon:b.Icon.ERROR,title:T,actions:[sap.m.MessageBox.Action.CLOSE],styleClass:(o.$()&&o.$().closest(".sapUiSizeCompact").length)?"sapUiSizeCompact navigationPopoverErrorDialog":"navigationPopoverErrorDialog"});};return d;},true);
