/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/ManagedObject','sap/m/P13nDialog','sap/m/P13nSelectionPanel','sap/m/P13nItem','sap/m/P13nColumnsItem','sap/ui/comp/personalization/Util'],function(q,M,P,a,b,c,d){"use strict";var S=M.extend("sap.ui.comp.navpopover.SelectionController",{metadata:{library:"sap.ui.comp"}});S.prototype.openSelectionDialog=function(m,e,C){var f=S._applyNewItems(m,e);return new Promise(function(r){var D=new P({stretch:sap.ui.Device.system.phone,showReset:false,contentWidth:"25rem",contentHeight:"35rem",panels:[new a({titleLarge:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("POPOVER_SELECTION_TITLE"),items:m.filter(function(o){return o.key!==undefined;}).map(function(o){return new b({columnKey:o.key,text:o.text});}),columnsItems:e.filter(function(o){return o.key!==undefined;}).map(function(o){return new c({columnKey:o.key,visible:o.visible,index:o.index});})})],ok:function(E){if(!E.getParameter("payload")||!E.getParameter("payload").selection||!E.getParameter("payload").selection.columnsItems){this.close();this.destroy();return r(null);}var o=S.getDiff(f,S._columnsItems2MColumnsItems(E.getParameter("payload").selection.columnsItems));if(!o){this.close();this.destroy();return r(null);}this.close();this.destroy();return r(o);},cancel:function(){this.close();this.destroy();return r(null);}});D.toggleStyleClass("sapUiSizeCompact",!!q(C.getDomRef()).closest(".sapUiSizeCompact").length);D.open();});};S._applyNewItems=function(i,n){return i.map(function(I){var N=d.getArrayElementByKey("key",I.key,n);return{key:I.key,visible:N?N.visible:I.visible};});};S._columnsItems2MColumnsItems=function(C){return C.map(function(o){return{key:o.getColumnKey(),visible:o.getVisible()};});};S.getDiff=function(o,n){if(o.length<n.length){return null;}var D={addedLinks:[],removedLinks:[]};o.forEach(function(O){var N=d.getArrayElementByKey("key",O.key,n);if(!N){return;}if(N.visible!==O.visible&&N.visible===true){D.addedLinks.push(N);}if(N.visible!==O.visible&&N.visible===false){D.removedLinks.push(N);}});return(D.addedLinks.length||D.removedLinks.length)?D:null;};S.getUnion=function(o,n){var u=[];o.forEach(function(O){var U=q.extend(true,{},O);var N=d.getArrayElementByKey("key",O.key,n);if(N){U.visible=N.visible;U.index=N.index;}u.push(U);});n.forEach(function(N){var U=d.getArrayElementByKey("key",N.key,u);if(!U){u.push(N);}});return u;};return S;},true);
