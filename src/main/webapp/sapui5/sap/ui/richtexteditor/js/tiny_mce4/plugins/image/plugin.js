tinymce.PluginManager.add('image',function(a){function g(u,d){var i=document.createElement('img');function e(w,h){if(i.parentNode){i.parentNode.removeChild(i);}d({width:w,height:h});}i.onload=function(){e(Math.max(i.width,i.clientWidth),Math.max(i.height,i.clientHeight));};i.onerror=function(){e();};var f=i.style;f.visibility='hidden';f.position='fixed';f.bottom=f.left=0;f.width=f.height='auto';document.body.appendChild(i);i.src=u;}function b(i,d,e){function f(v,o){o=o||[];tinymce.each(v,function(h){var m={text:h.text||h.title};if(h.menu){m.menu=f(h.menu);}else{m.value=h.value;d(m);}o.push(m);});return o;}return f(i,e||[]);}function c(d){return function(){var i=a.settings.image_list;if(typeof i=="string"){tinymce.util.XHR.send({url:i,success:function(t){d(tinymce.util.JSON.parse(t));}});}else if(typeof i=="function"){i(d);}else{d(i);}};}function s(i){var w,d={},f=a.dom,h,j;var k,l,m,n,o=a.settings.image_dimensions!==false;function r(){var e,z,A,B;e=w.find('#width')[0];z=w.find('#height')[0];if(!e||!z){return;}A=e.value();B=z.value();if(w.find('#constrain')[0].checked()&&k&&l&&A&&B){if(k!=A){B=Math.round((A/k)*B);if(!isNaN(B)){z.value(B);}}else{A=Math.round((B/l)*A);if(!isNaN(A)){e.value(A);}}}k=A;l=B;}function p(){var j,e;function z(h){function A(){h.onload=h.onerror=null;if(a.selection){a.selection.select(h);a.nodeChanged();}}h.onload=function(){if(!d.width&&!d.height&&o){f.setAttribs(h,{width:h.clientWidth,height:h.clientHeight});}A();};h.onerror=A;}x();r();d=tinymce.extend(d,w.toJSON());if(!d.alt){d.alt='';}if(!d.title){d.title='';}if(d.width===''){d.width=null;}if(d.height===''){d.height=null;}if(!d.style){d.style=null;}d={src:d.src,alt:d.alt,title:d.title,width:d.width,height:d.height,style:d.style,caption:d.caption,"class":d["class"]};a.undoManager.transact(function(){if(!d.src){if(h){f.remove(h);a.focus();a.nodeChanged();}return;}if(d.title===""){d.title=null;}if(!h){d.id='__mcenew';a.focus();a.selection.setContent(f.createHTML('img',d));h=f.get('__mcenew');f.setAttrib(h,'id',null);}else{f.setAttribs(h,d);}a.editorUpload.uploadImagesAuto();if(d.caption===false){if(f.is(h.parentNode,'figure.image')){j=h.parentNode;f.insertAfter(h,j);f.remove(j);}}function A(C){return a.schema.getTextBlockElements()[C.nodeName];}if(d.caption===true){if(!f.is(h.parentNode,'figure.image')){e=h;h=h.cloneNode(true);j=f.create('figure',{'class':'image'});j.appendChild(h);j.appendChild(f.create('figcaption',{contentEditable:true},'Caption'));j.contentEditable=false;var B=f.getParent(e,A);if(B){f.split(B,e,j);}else{f.replace(j,e);}a.selection.select(j);}return;}z(h);});}function q(e){if(e){e=e.replace(/px$/,'');}return e;}function t(e){var z,A,B,C=e.meta||{};if(m){m.value(a.convertURL(this.value(),'src'));}tinymce.each(C,function(D,E){w.find('#'+E).value(D);});if(!C.width&&!C.height){z=a.convertURL(this.value(),'src');A=a.settings.image_prepend_url;B=new RegExp('^(?:[a-z]+:)?//','i');if(A&&!B.test(z)&&z.substring(0,A.length)!==A){z=A+z;}this.value(z);g(a.documentBaseURI.toAbsolute(this.value()),function(d){if(d.width&&d.height&&o){k=d.width;l=d.height;w.find('#width').value(k);w.find('#height').value(l);}});}}h=a.selection.getNode();j=f.getParent(h,'figure.image');if(j){h=f.select('img',j)[0];}if(h&&(h.nodeName!='IMG'||h.getAttribute('data-mce-object')||h.getAttribute('data-mce-placeholder'))){h=null;}if(h){k=f.getAttrib(h,'width');l=f.getAttrib(h,'height');d={src:f.getAttrib(h,'src'),alt:f.getAttrib(h,'alt'),title:f.getAttrib(h,'title'),"class":f.getAttrib(h,'class'),width:k,height:l,caption:!!j};}if(i){m={type:'listbox',label:'Image list',values:b(i,function(e){e.value=a.convertURL(e.value||e.url,'src');},[{text:'None',value:''}]),value:d.src&&a.convertURL(d.src,'src'),onselect:function(e){var z=w.find('#alt');if(!z.value()||(e.lastControl&&z.value()==e.lastControl.text())){z.value(e.control.text());}w.find('#src').value(e.control.value()).fire('change');},onPostRender:function(){m=this;}};}if(a.settings.image_class_list){n={name:'class',type:'listbox',label:'Class',values:b(a.settings.image_class_list,function(e){if(e.value){e.textStyle=function(){return a.formatter.getCssText({inline:'img',classes:[e.value]});};}})};}var u=[{name:'src',type:'filepicker',filetype:'image',label:'Source',autofocus:true,onchange:t},m];if(a.settings.image_description!==false){u.push({name:'alt',type:'textbox',label:'Image description'});}if(a.settings.image_title){u.push({name:'title',type:'textbox',label:'Image Title'});}if(o){u.push({type:'container',label:'Dimensions',layout:'flex',direction:'row',align:'center',spacing:5,items:[{name:'width',type:'textbox',maxLength:5,size:3,onchange:r,ariaLabel:'Width'},{type:'label',text:'x'},{name:'height',type:'textbox',maxLength:5,size:3,onchange:r,ariaLabel:'Height'},{name:'constrain',type:'checkbox',checked:true,text:'Constrain proportions'}]});}u.push(n);if(a.settings.image_caption&&tinymce.Env.ceFalse){u.push({name:'caption',type:'checkbox',label:'Caption'});}function v(e){if(e.margin){var z=e.margin.split(" ");switch(z.length){case 1:e['margin-top']=e['margin-top']||z[0];e['margin-right']=e['margin-right']||z[0];e['margin-bottom']=e['margin-bottom']||z[0];e['margin-left']=e['margin-left']||z[0];break;case 2:e['margin-top']=e['margin-top']||z[0];e['margin-right']=e['margin-right']||z[1];e['margin-bottom']=e['margin-bottom']||z[0];e['margin-left']=e['margin-left']||z[1];break;case 3:e['margin-top']=e['margin-top']||z[0];e['margin-right']=e['margin-right']||z[1];e['margin-bottom']=e['margin-bottom']||z[2];e['margin-left']=e['margin-left']||z[1];break;case 4:e['margin-top']=e['margin-top']||z[0];e['margin-right']=e['margin-right']||z[1];e['margin-bottom']=e['margin-bottom']||z[2];e['margin-left']=e['margin-left']||z[3];}delete e.margin;}return e;}function x(){function e(A){if(A.length>0&&/^[0-9]+$/.test(A)){A+='px';}return A;}if(!a.settings.image_advtab){return;}var d=w.toJSON(),z=f.parseStyle(d.style);z=v(z);if(d.vspace){z['margin-top']=z['margin-bottom']=e(d.vspace);}if(d.hspace){z['margin-left']=z['margin-right']=e(d.hspace);}if(d.border){z['border-width']=e(d.border);}w.find('#style').value(f.serializeStyle(f.parseStyle(f.serializeStyle(z))));}function y(){if(!a.settings.image_advtab){return;}var d=w.toJSON(),e=f.parseStyle(d.style);w.find('#vspace').value("");w.find('#hspace').value("");e=v(e);if((e['margin-top']&&e['margin-bottom'])||(e['margin-right']&&e['margin-left'])){if(e['margin-top']===e['margin-bottom']){w.find('#vspace').value(q(e['margin-top']));}else{w.find('#vspace').value('');}if(e['margin-right']===e['margin-left']){w.find('#hspace').value(q(e['margin-right']));}else{w.find('#hspace').value('');}}if(e['border-width']){w.find('#border').value(q(e['border-width']));}w.find('#style').value(f.serializeStyle(f.parseStyle(f.serializeStyle(e))));}if(a.settings.image_advtab){if(h){if(h.style.marginLeft&&h.style.marginRight&&h.style.marginLeft===h.style.marginRight){d.hspace=q(h.style.marginLeft);}if(h.style.marginTop&&h.style.marginBottom&&h.style.marginTop===h.style.marginBottom){d.vspace=q(h.style.marginTop);}if(h.style.borderWidth){d.border=q(h.style.borderWidth);}d.style=a.dom.serializeStyle(a.dom.parseStyle(a.dom.getAttrib(h,'style')));}w=a.windowManager.open({title:'Insert/edit image',data:d,bodyType:'tabpanel',body:[{title:'General',type:'form',items:u},{title:'Advanced',type:'form',pack:'start',items:[{label:'Style',name:'style',type:'textbox',onchange:y},{type:'form',layout:'grid',packV:'start',columns:2,padding:0,alignH:['left','right'],defaults:{type:'textbox',maxWidth:50,onchange:x},items:[{label:'Vertical space',name:'vspace'},{label:'Horizontal space',name:'hspace'},{label:'Border',name:'border'}]}]}],onSubmit:p});}else{w=a.windowManager.open({title:'Insert/edit image',data:d,body:u,onSubmit:p});}}a.on('preInit',function(){function h(n){var d=n.attr('class');return d&&/\bimage\b/.test(d);}function t(d){return function(n){var i=n.length,e;function f(e){e.attr('contenteditable',d?'true':null);}while(i--){e=n[i];if(h(e)){e.attr('contenteditable',d?'false':null);tinymce.each(e.getAll('figcaption'),f);}}};}a.parser.addNodeFilter('figure',t(true));a.serializer.addNodeFilter('figure',t(false));});a.addButton('image',{icon:'image',tooltip:'Insert/edit image',onclick:c(s),stateSelector:'img:not([data-mce-object],[data-mce-placeholder]),figure.image'});a.addMenuItem('image',{icon:'image',text:'Insert/edit image',onclick:c(s),context:'insert',prependToContext:true});a.addCommand('mceImage',c(s));});
