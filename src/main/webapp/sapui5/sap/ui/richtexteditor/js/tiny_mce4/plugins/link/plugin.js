tinymce.PluginManager.add('link',function(a){function c(d){return function(){var l=a.settings.link_list;if(typeof l=="string"){tinymce.util.XHR.send({url:l,success:function(t){d(tinymce.util.JSON.parse(t));}});}else if(typeof l=="function"){l(d);}else{d(l);}};}function b(i,d,e){function f(v,o){o=o||[];tinymce.each(v,function(g){var m={text:g.text||g.title};if(g.menu){m.menu=f(g.menu);}else{m.value=g.value;if(d){d(m);}}o.push(m);});return o;}return f(i,e||[]);}function s(l){var d={},f=a.selection,g=a.dom,h,j,k;var w,o,t,m,r,n,p,q,v;function u(e){var i=w.find('#text');if(!i.value()||(e.lastControl&&i.value()==e.lastControl.text())){i.value(e.control.text());}w.find('#href').value(e.control.value());}function x(e){var i=[];tinymce.each(a.dom.select('a:not([href])'),function(B){var C=B.name||B.id;if(C){i.push({text:C,value:'#'+C,selected:e.indexOf('#'+C)!=-1});}});if(i.length){i.unshift({text:'None',value:''});return{name:'anchor',type:'listbox',label:'Anchors',values:i,onselect:u};}}function y(){if(!k&&d.text.length===0&&o){this.parent().parent().find('#text')[0].value(this.value());}}function z(e){var i=e.meta||{};if(m){m.value(a.convertURL(this.value(),'href'));}tinymce.each(e.meta,function(v,B){w.find('#'+B).value(v);});if(!i.text){y.call(this);}}function A(j){var e=f.getContent();if(/</.test(e)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(e)||e.indexOf('href=')==-1)){return false;}if(j){var B=j.childNodes,i;if(B.length===0){return false;}for(i=B.length-1;i>=0;i--){if(B[i].nodeType!=3){return false;}}}return true;}h=f.getNode();j=g.getParent(h,'a[href]');o=A();d.text=k=j?(j.innerText||j.textContent):f.getContent({format:'text'});d.href=j?g.getAttrib(j,'href'):'';if(j){d.target=g.getAttrib(j,'target');}else if(a.settings.default_link_target){d.target=a.settings.default_link_target;}if((v=g.getAttrib(j,'rel'))){d.rel=v;}if((v=g.getAttrib(j,'class'))){d['class']=v;}if((v=g.getAttrib(j,'title'))){d.title=v;}if(o){t={name:'text',type:'textbox',size:40,label:'Text to display',onchange:function(){d.text=this.value();}};}if(l){m={type:'listbox',label:'Link list',values:b(l,function(i){i.value=a.convertURL(i.value||i.url,'href');},[{text:'None',value:''}]),onselect:u,value:a.convertURL(d.href,'href'),onPostRender:function(){m=this;}};}if(a.settings.target_list!==false){if(!a.settings.target_list){a.settings.target_list=[{text:'None',value:''},{text:'New window',value:'_blank'}];}n={name:'target',type:'listbox',label:'Target',values:b(a.settings.target_list)};}if(a.settings.rel_list){r={name:'rel',type:'listbox',label:'Rel',values:b(a.settings.rel_list)};}if(a.settings.link_class_list){p={name:'class',type:'listbox',label:'Class',values:b(a.settings.link_class_list,function(i){if(i.value){i.textStyle=function(){return a.formatter.getCssText({inline:'a',classes:[i.value]});};}})};}if(a.settings.link_title!==false){q={name:'title',type:'textbox',label:'Title',value:d.title};}w=a.windowManager.open({title:'Insert link',data:d,body:[{name:'href',type:'filepicker',filetype:'file',size:40,autofocus:true,label:'Url',onchange:z,onkeyup:y},t,q,x(d.href),m,r,n,p],onSubmit:function(e){var i;d=tinymce.extend(d,e.data);i=d.href;function B(D,E){var F=a.selection.getRng();tinymce.util.Delay.setEditorTimeout(a,function(){a.windowManager.confirm(D,function(G){a.selection.setRng(F);E(G);});});}function C(){var D={href:i,target:d.target?d.target:null,rel:d.rel?d.rel:null,"class":d["class"]?d["class"]:null,title:d.title?d.title:null};if(j){a.focus();if(o&&d.text!=k){if("innerText"in j){j.innerText=d.text;}else{j.textContent=d.text;}}g.setAttribs(j,D);f.select(j);a.undoManager.add();}else{if(o){a.insertContent(g.createHTML('a',D,g.encode(d.text)));}else{a.execCommand('mceInsertLink',false,D);}}}if(!i){a.execCommand('unlink');return;}if(i.indexOf('@')>0&&i.indexOf('//')==-1&&i.indexOf('mailto:')==-1){B('The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?',function(D){if(D){i='mailto:'+i;}C();});return;}if((a.settings.link_assume_external_targets&&!/^\w+:/i.test(i))||(!a.settings.link_assume_external_targets&&/^\s*www[\.|\d\.]/i.test(i))){B('The URL you entered seems to be an external link. Do you want to add the required http:// prefix?',function(D){if(D){i='http://'+i;}C();});return;}C();}});}a.addButton('link',{icon:'link',tooltip:'Insert/edit link',shortcut:'Meta+K',onclick:c(s),stateSelector:'a[href]'});a.addButton('unlink',{icon:'unlink',tooltip:'Remove link',cmd:'unlink',stateSelector:'a[href]'});a.addShortcut('Meta+K','',c(s));a.addCommand('mceLink',c(s));this.showDialog=s;a.addMenuItem('link',{icon:'link',text:'Insert/edit link',shortcut:'Meta+K',onclick:c(s),stateSelector:'a[href]',context:'insert',prependToContext:true});});
