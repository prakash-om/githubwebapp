/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./library','sap/ui/core/Control'],function(q,l,C){"use strict";var I=C.extend("sap.suite.ui.microchart.InteractiveBarChart",{metadata:{library:"sap.suite.ui.microchart",properties:{maxDisplayedBars:{type:"int",group:"Appearance",defaultValue:3},selectionEnabled:{type:"boolean",group:"Behavior",defaultValue:true},min:{type:"float",group:"Appearance"},max:{type:"float",group:"Appearance"}},defaultAggregation:"bars",aggregations:{bars:{type:"sap.suite.ui.microchart.InteractiveBarChartBar",multiple:true,bindable:"bindable"}},events:{selectionChanged:{parameters:{selectedBars:{type:"sap.suite.ui.microchart.InteractiveBarChartBar[]"},bar:{type:"sap.suite.ui.microchart.InteractiveBarChartBar"},selected:{type:"boolean"}}}},associations:{}}});I.MIN_BARS_TO_DISPLAY=3;I.BAR_AREA_WIDTH=60;I.BAR_PADDING_RIGHT_IN_PX=8;I.MIN_BAR_WIDTH_IN_PX=1;I.LABEL_PADDING_IN_PX=8;I.LABEL_AREA_WIDTH=40;I.BAR_VALUE_PADDING_LEFT_IN_PX=4;I.BAR_VALUE_PADDING_RIGHT_IN_PX=4;I.SELECTION_AREA_PADDING_BOTTOM_IN_PX=4;I.prototype.init=function(){this._iVisibleBars=0;this._bMinMaxValid=null;this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.microchart");this._bThemeApplied=true;if(!sap.ui.getCore().isInitialized()){this._bThemeApplied=false;sap.ui.getCore().attachInit(this._handleCoreInitialized.bind(this));}else{this._handleCoreInitialized();}};I.prototype._handleCoreInitialized=function(){this._bThemeApplied=sap.ui.getCore().isThemeApplied();if(!this._bThemeApplied){sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this);}};I.prototype._handleThemeApplied=function(){this._bThemeApplied=true;this.invalidate();sap.ui.getCore().detachThemeChanged(this._handleThemeApplied,this);};I.prototype.onBeforeRendering=function(){this._bMinMaxValid=this._checkIfMinMaxValid();if(this.getAggregation("bars")&&this.getProperty("maxDisplayedBars")){this._iVisibleBars=Math.min(this.getAggregation("bars").length,this.getProperty("maxDisplayedBars"));}if(!this.data("_parentRenderingContext")&&q.isFunction(this.getParent)){this.data("_parentRenderingContext",this.getParent());}this._deregisterResizeHandler();};I.prototype.onAfterRendering=function(){var c=this.$();this._sResizeHandlerId=sap.ui.core.ResizeHandler.register(this,this._onResize.bind(this));this._adjustToParent(c);this._calcBarsWidth();this._onResize();};I.prototype.exit=function(){this._deregisterResizeHandler();};I.prototype.onclick=function(e){var i=e.target.id,f=this.$().find(".sapSuiteIBCBarInteractionArea"),a,h;if(i){a=i.substring(i.lastIndexOf("-")+1);if(isNaN(a)){return;}else{a=parseInt(a,10);}this._toggleSelected(a);h=f.index(this.$().find(".sapSuiteIBCBarInteractionArea[tabindex='0']"));this._switchTabindex(h,a,f);}};I.prototype.onsapenter=function(e){var i=this.$().find(".sapSuiteIBCBarInteractionArea").index(e.target);if(i!==-1){this._toggleSelected(i);}e.preventDefault();e.stopImmediatePropagation();};I.prototype.onsapspace=I.prototype.onsapenter;I.prototype.onsapup=function(e){var f=this.$().find(".sapSuiteIBCBarInteractionArea");var i=f.index(e.target);if(f.length>0){this._switchTabindex(i,i-1,f);}e.preventDefault();e.stopImmediatePropagation();};I.prototype.onsapdown=function(e){var f=this.$().find(".sapSuiteIBCBarInteractionArea");var i=f.index(e.target);if(f.length>0){this._switchTabindex(i,i+1,f);}e.preventDefault();e.stopImmediatePropagation();};I.prototype.onsaphome=function(e){var f=this.$().find(".sapSuiteIBCBarInteractionArea");var i=f.index(e.target);if(i!==0&&f.length>0){this._switchTabindex(i,0,f);}e.preventDefault();e.stopImmediatePropagation();};I.prototype.onsapend=function(e){var f=this.$().find(".sapSuiteIBCBarInteractionArea"),i=f.index(e.target),L=f.length;if(i!==L-1&&L>0){this._switchTabindex(i,L-1,f);}e.preventDefault();e.stopImmediatePropagation();};I.prototype.onsapleft=I.prototype.onsapup;I.prototype.onsapright=I.prototype.onsapdown;I.prototype.getSelectedBars=function(){var b=this.getAggregation("bars"),s=[],i;for(i=0;i<b.length;i++){if(b[i].getSelected()){s.push(b[i]);}}return s;};I.prototype.setSelectedBars=function(s){var b=this.getAggregation("bars"),i,a;this._deselectAllSelectedBars();if(!s){return this;}if(s instanceof l.InteractiveBarChartBar){s=[s];}if(q.isArray(s)){for(i=0;i<s.length;i++){a=this.indexOfAggregation("bars",s[i]);if(a>=0){b[a].setProperty("selected",true,true);}else{q.sap.log.warning("setSelectedBars method called with invalid InteractiveBarChartBar element");}}}this.invalidate();return this;};I.prototype._adjustToParent=function(c){if(this.data("_parentRenderingContext")&&this.data("_parentRenderingContext")instanceof sap.m.FlexBox){var p=this.data("_parentRenderingContext").$();var P=p.width()-2;var i=p.height()-2;c.outerWidth(P);c.outerHeight(i);}};I.prototype._calcBarsWidth=function(){var m=this.getProperty("min"),M=this.getProperty("max"),c=this.$().width(),d,r,b,B,L,f,v;if(!this._bMinMaxValid){return this;}d=M-m;r=I.BAR_PADDING_RIGHT_IN_PX/c*100;b=I.BAR_AREA_WIDTH-r;B=b/100*c;L=I.LABEL_PADDING_IN_PX/c*100;f=(I.LABEL_AREA_WIDTH-2*L).toFixed(2);function a(v){var R=v-m,e=(R/d*b).toFixed(2);if(R>0&&(e/100*B)<1){return I.MIN_BAR_WIDTH_IN_PX+"px";}return e+"%";}for(var i=0;i<this._iVisibleBars;i++){this.$("label-"+i).css("width",f+"%");v=this.getBars()[i].getValue();if(this.getBars()[i]._bNullValue){this.$("bar-"+i).css("width","0%");}else{v=Math.min(v,M);this.$("bar-"+i).css("width",a(Math.abs(v)));}}return this;};I.prototype._deselectAllSelectedBars=function(){var b=this.getAggregation("bars"),B=b.length,i;for(i=0;i<B;i++){b[i].setProperty("selected",false,true);}};I.prototype._toggleSelected=function(i){var b=this.getAggregation("bars"),B=b[i];if(i<0||i>=b.length){return;}var $=this.$("interactionArea-"+i);if(B.getSelected()){$.removeClass("sapSuiteIBCBarSelected");B.setProperty("selected",false,true);}else{$.addClass("sapSuiteIBCBarSelected");B.setProperty("selected",true,true);}this.fireSelectionChanged({selectedBars:this.getSelectedBars(),bar:B,selected:B.getSelected()});};I.prototype._showValueOutsideBar=function(){var b,B,v,i,c=this.$();b=c.find(".sapSuiteIBCBar");B=c.find(".sapSuiteIBCBarValue");if(b.length===0||B.length===0){return;}for(i=0;i<this._iVisibleBars;i++){if((q(B[i]).width()+2*I.BAR_VALUE_PADDING_LEFT_IN_PX)>q(b[i]).width()){v=q(b[i]).width()+I.BAR_VALUE_PADDING_LEFT_IN_PX;q(B[i]).css({"right":"auto"});q(B[i]).css({"left":v});q(B[i]).addClass("sapSuiteIBCBarValueOutside");}else{q(B[i]).css({"left":""});q(B[i]).css({"right":I.BAR_VALUE_PADDING_RIGHT_IN_PX});q(B[i]).removeClass("sapSuiteIBCBarValueOutside");}}};I.prototype._checkIfMinMaxValid=function(){var m=this.getMin(),M=this.getMax();if(isNaN(m)||isNaN(M)){q.sap.log.warning("Min or Max value for InteractiveBarChart is not provided.");return false;}if(m>M){q.sap.log.warning("Min value for InteractiveBarChart is larger than Max value.");return false;}if(m<0||M<0){q.sap.log.warning("Min or Max value for InteractiveBarChart are negative.");return false;}return true;};I.prototype._switchTabindex=function(o,n,f){if(o>=0&&o<f.length&&n>=0&&n<f.length){f.eq(o).removeAttr("tabindex");f.eq(n).attr("tabindex","0");f.eq(n).focus();}};I.prototype._resizeVertically=function(){var i,c,$=this.$(),s=$.find(".sapSuiteIBCBarInteractionArea"),a=$.height();for(i=0;i<this._iVisibleBars;i++){c=(s.height()+I.SELECTION_AREA_PADDING_BOTTOM_IN_PX)*(i+1);if(c>a){q(s[i]).hide();}else{q(s[i]).show();}}};I.prototype._onResize=function(){this._showValueOutsideBar();this._resizeVertically();};I.prototype._deregisterResizeHandler=function(){if(this._sResizeHandlerId){sap.ui.core.ResizeHandler.deregister(this._sResizeHandlerId);this._sResizeHandlerId=null;}};return I;});
