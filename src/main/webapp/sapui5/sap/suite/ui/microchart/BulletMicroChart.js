/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./library','sap/ui/core/Control','sap/m/Size'],function(q,l,C,S){"use strict";var B=C.extend("sap.suite.ui.microchart.BulletMicroChart",{metadata:{library:"sap.suite.ui.microchart",properties:{size:{type:"sap.m.Size",group:"Misc",defaultValue:"Auto"},mode:{type:"sap.suite.ui.microchart.BulletMicroChartModeType",group:"Misc",defaultValue:"Actual"},scale:{type:"string",group:"Misc",defaultValue:""},forecastValue:{type:"float",group:"Misc",defaultValue:null},targetValue:{type:"float",group:"Misc",defaultValue:null},minValue:{type:"float",group:"Misc",defaultValue:null},maxValue:{type:"float",group:"Misc",defaultValue:null},showActualValue:{type:"boolean",group:"Misc",defaultValue:"true"},showDeltaValue:{type:"boolean",group:"Misc",defaultValue:"true"},showTargetValue:{type:"boolean",group:"Misc",defaultValue:"true"},showValueMarker:{type:"boolean",group:"Misc",defaultValue:"false"},actualValueLabel:{type:"string",group:"Misc",defaultValue:""},deltaValueLabel:{type:"string",group:"Misc",defaultValue:""},targetValueLabel:{type:"string",group:"Misc",defaultValue:""},width:{type:"sap.ui.core.CSSSize",group:"Misc"},scaleColor:{type:"sap.suite.ui.microchart.CommonBackgroundType",group:"Misc",defaultValue:"MediumLight"},isResponsive:{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"actual",aggregations:{actual:{type:"sap.suite.ui.microchart.BulletMicroChartData",multiple:false,bindable:"bindable"},thresholds:{type:"sap.suite.ui.microchart.BulletMicroChartData",multiple:true,singularName:"threshold",bindable:"bindable"}},events:{press:{}}}});B.EDGE_CASE_WIDTH_RESIZEFONT=168;B.prototype.init=function(){this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.microchart");this.setAggregation("tooltip","{AltText}",true);this._bThemeApplied=true;if(!sap.ui.getCore().isInitialized()){this._bThemeApplied=false;sap.ui.getCore().attachInit(this._handleCoreInitialized.bind(this));}else{this._handleCoreInitialized();}};B.prototype._handleCoreInitialized=function(){this._bThemeApplied=sap.ui.getCore().isThemeApplied();if(!this._bThemeApplied){sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this);}};B.prototype._handleThemeApplied=function(){this._bThemeApplied=true;this.invalidate();sap.ui.getCore().detachThemeChanged(this._handleThemeApplied,this);};B.prototype._calculateChartData=function(){var s=98;var d=this.getThresholds();var t=[];var T=this.getTargetValue();var f=this.getForecastValue();var a=this.getActual()&&this.getActual().getValue()?this.getActual().getValue():0;var v=[];var L=0;var h=0;if(this.getActual()&&this.getActual()._isValueSet){v.push(a);}if(this._isForecastValueSet){v.push(f);}if(this._isTargetValueSet){v.push(T);}if(this._isMinValueSet){v.push(this.getMinValue());}if(this._isMaxValueSet){v.push(this.getMaxValue());}for(var D=0;D<d.length;D++){v.push(d[D].getValue());}var b=0;if(v.length>0){L=h=v[0];for(var j=0;j<v.length;j++){if(v[j]<L){L=v[j];}if(v[j]>h){h=v[j];}}h=(h<0&&h<3*(L-h))?0:h;L=(L>0&&L>3*(h-L))?0:L;b=h-L;for(var i=0;i<d.length;i++){t[i]={color:d[i].getColor(),valuePct:(!d[i]._isValueSet||b==0)?0:((d[i].getValue()-L)*s/b).toFixed(2)};}}return{actualValuePct:(!this.getActual()||!this.getActual()._isValueSet||b==0)?0:(0.05+(a-L)*s/b).toFixed(2),targetValuePct:(!this._isTargetValueSet||b==0)?0:((T-L)*s/b).toFixed(2),forecastValuePct:(!this._isForecastValueSet||b==0)?0:((f-L)*s/b).toFixed(2),thresholdsPct:t,fScaleWidthPct:s};};B.prototype._digitsAfterDecimalPoint=function(v){var a=(""+v).match(/[.,](\d+)/g);return(a)?(""+a).length-1:0;};B.prototype._calculateDeltaValue=function(){if(!this.getActual()._isValueSet||!this._isTargetValueSet){return 0;}else{var a=this.getActual().getValue();var t=this.getTargetValue();return Math.abs(a-t).toFixed(Math.max(this._digitsAfterDecimalPoint(a),this._digitsAfterDecimalPoint(t)));}};B.prototype.setMinValue=function(m,s){this._isMinValueSet=this._fnIsNumber(m);return this.setProperty("minValue",this._isMinValueSet?m:NaN,s);};B.prototype.setMaxValue=function(m,s){this._isMaxValueSet=this._fnIsNumber(m);return this.setProperty("maxValue",this._isMaxValueSet?m:NaN,s);};B.prototype.setTargetValue=function(t,s){this._isTargetValueSet=this._fnIsNumber(t);return this.setProperty("targetValue",this._isTargetValueSet?t:NaN,s);};B.prototype.setForecastValue=function(f,s){this._isForecastValueSet=this._fnIsNumber(f);return this.setProperty("forecastValue",this._isForecastValueSet?f:NaN,s);};B.prototype.setSize=function(s){if(s===S.Responsive){this.setIsResponsive(true);}else{this.setIsResponsive(false);}return this.setProperty("size",s,true);};B.prototype.ontap=function(e){if(sap.ui.Device.browser.internet_explorer){this.$().focus();}this.firePress();};B.prototype.onkeydown=function(e){if(e.which==q.sap.KeyCodes.SPACE){e.preventDefault();}};B.prototype.onkeyup=function(e){if(e.which==q.sap.KeyCodes.ENTER||e.which==q.sap.KeyCodes.SPACE){this.firePress();e.preventDefault();}};B.prototype._fnIsNumber=function(n){return typeof n=='number'&&!isNaN(n)&&isFinite(n);};B.prototype.attachEvent=function(e,d,f,L){sap.ui.core.Control.prototype.attachEvent.call(this,e,d,f,L);if(this.hasListeners("press")){this.$().attr("tabindex",0).addClass("sapSuiteUiMicroChartPointer");}return this;};B.prototype.detachEvent=function(e,f,L){sap.ui.core.Control.prototype.detachEvent.call(this,e,f,L);if(!this.hasListeners("press")){this.$().removeAttr("tabindex").removeClass("sapSuiteUiMicroChartPointer");}return this;};B.prototype.onBeforeRendering=function(){if(l._isInGenericTile(this)){this.setIsResponsive(true);l._removeStandardMargins(this);}if(this._sChartResizeHandlerId){sap.ui.core.ResizeHandler.deregister(this._sChartResizeHandlerId);}if(this.getIsResponsive()&&!this.data("_parentRenderingContext")&&q.isFunction(this.getParent)){this.data("_parentRenderingContext",this.getParent());}};B.prototype.onAfterRendering=function(){if(this.getShowValueMarker()){this._adjustValueToMarker();}this._onResize();this._sChartResizeHandlerId=sap.ui.core.ResizeHandler.register(this.$(),q.proxy(this._onResize,this));};B.prototype._onResize=function(){if(this.getIsResponsive()){var c=this.$();c.removeClass("sapSuiteBMCSmallFont sapSuiteBMCNoLabels");this._adjustToParent(c);this._adjustLabelsPos();this._resizeHorizontally(c);this._resizeVertically(c);}else{this._adjustLabelsPos();}};B.prototype._adjustToParent=function(c){if(this.data("_parentRenderingContext")&&this.data("_parentRenderingContext")instanceof sap.m.FlexBox){var p=this.data("_parentRenderingContext").$();var P=parseInt(p.height(),10);var s=parseInt(p.width(),10);c.outerHeight(P-parseInt(c.css("margin-top"),10)-parseInt(c.css("margin-bottom"),10));c.outerWidth(s-parseInt(c.css("margin-left"),10)-parseInt(c.css("margin-right"),10));}};B.prototype._resizeVertically=function(c){var o=c.find(".sapSuiteBMCVerticalAlignmentContainer.sapSuiteBMCWholeControl");var $=c.find(".sapSuiteBMCChartCanvas");var m=parseInt(o.css("max-height"),10);var M=parseInt(o.css("min-height"),10);var i=parseInt($.css("min-height"),10);var a=parseInt(c.css("height"),10);if(a<m){c.addClass("sapSuiteBMCSmallFont");}if(a<i){c.hide();}else if(a<M){c.addClass("sapSuiteBMCNoLabels");}};B.prototype._resizeHorizontally=function(c){var o=c.find(".sapSuiteBMCVerticalAlignmentContainer.sapSuiteBMCWholeControl");var m=parseInt(o.css("min-width"),10);var i=parseInt(c.css("width"),10);if(i<=m){c.hide();return;}if(i<B.EDGE_CASE_WIDTH_RESIZEFONT||this._isTruncatedLabel(c)){c.addClass("sapSuiteBMCSmallFont");}if(this._isTruncatedLabel(c)){c.hide();}};B.prototype._isTruncatedLabel=function(c){var L=c.find(".sapSuiteBMCItemValue, .sapSuiteBMCTargetBarValue");for(var i=0;i<L.length;i++){if(L[i].scrollWidth>L[i].offsetWidth){return true;}}return false;};B.prototype.exit=function(){sap.ui.core.ResizeHandler.deregister(this._sChartResizeHandlerId);};B.prototype._adjustLabelsPos=function(){var r=sap.ui.getCore().getConfiguration().getRTL();var t=q.sap.byId(this.getId()+"-bc-target-bar-value");var c=q.sap.byId(this.getId()+"-chart-bar");var f=c.width();if(f){var T=0;if(t&&t.offset()){T=t.offset().left-c.offset().left;if(r){T=f-T;}this._adjustLabelPos(q.sap.byId(this.getId()+"-bc-target-value"),f,T,r);}var v=q.sap.byId(this.getId()+"-bc-bar-value-marker");if(v&&v.offset()){var a=v.offset().left-c.offset().left;if(r){a=f-a;}if((sap.suite.ui.microchart.BulletMicroChartModeType.Delta==this.getMode())){a=(a+T)/2;}this._adjustLabelPos(q.sap.byId(this.getId()+"-bc-item-value"),f,a,r);}}};B.prototype._adjustLabelPos=function(L,f,o,r){var O=r?"right":"left";var a=L.width();if(a>f){L.css("width",""+f+"px");L.css(O,"0");}else{var b=o-0.5*a;if(b<0){b=0;}if(b+a>f){b=f-a;}L.css(O,b);L.css("width",""+(parseInt(a,10)+1)+"px");}};B.prototype._adjustValueToMarker=function(){var v=q.sap.byId(this.getId()+"-bc-bar-value");var m=q.sap.byId(this.getId()+"-bc-bar-value-marker");if(v.offset()&&m.offset()){var V=v.width();var f=v.offset().left;var M=m.width();var a=m.offset().left;if(sap.ui.getCore().getConfiguration().getRTL()){if(a<f){m.css("right","");m.offset({left:f});}if(a+M>f+V){m.css("right","");m.offset({left:f+V-M});}}else{if(a<f){m.offset({left:f});}if(a+M>f+V){v.width(a+M-f);}}}};B.prototype._getLocalizedColorMeaning=function(c){return this._oRb.getText(("SEMANTIC_COLOR_"+c).toUpperCase());};B.prototype.getAltText=function(){var I=this.getActual()&&this.getActual()._isValueSet;var s=this.getScale();var t=this.getTargetValueLabel();var m=!this.getActual()||!this.getActual().getColor()?"":this._getLocalizedColorMeaning(this.getActual().getColor());var a="";if(I){var A=this.getActualValueLabel();var b=(A)?A:""+this.getActual().getValue();a+=this._oRb.getText("BULLETMICROCHART_ACTUAL_TOOLTIP",[b+s,m]);}if(this.getMode()=="Delta"){if(this._isTargetValueSet&&I){var d=this.getDeltaValueLabel();var D=(d)?d:""+this._calculateDeltaValue();a+="\n"+this._oRb.getText("BULLETMICROCHART_DELTA_TOOLTIP",[D+s,m]);}}else{if(this._isForecastValueSet){a+=(this._isForecastValueSet)?"\n"+this._oRb.getText("BULLETMICROCHART_FORECAST_TOOLTIP",[this.getForecastValue()+s,m]):"";}}if(this._isTargetValueSet){var T=(t)?t:""+this.getTargetValue();a+="\n"+this._oRb.getText("BULLETMICROCHART_TARGET_TOOLTIP",[T+s]);}var c=this.getThresholds().sort(function(f,e){return f.getValue()-e.getValue();});for(var i=0;i<c.length;i++){var o=c[i];a+="\n"+this._oRb.getText("BULLETMICROCHART_THRESHOLD_TOOLTIP",[o.getValue()+this.getScale(),this._getLocalizedColorMeaning(o.getColor())]);}return a;};B.prototype.getTooltip_AsString=function(){var t=this.getTooltip();var T=this.getAltText();if(typeof t==="string"||t instanceof String){T=t.split("{AltText}").join(T).split("((AltText))").join(T);return T;}else if(this.isBound("tooltip")&&!t){return T;}return t?t:"";};B.prototype.clone=function(i,L,o){var c=sap.ui.core.Control.prototype.clone.apply(this,arguments);c._isMinValueSet=this._isMinValueSet;c._isMaxValueSet=this._isMaxValueSet;c._isForecastValueSet=this._isForecastValueSet;c._isTargetValueSet=this._isTargetValueSet;return c;};return B;});
