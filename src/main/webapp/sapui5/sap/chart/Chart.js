/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2016 SAP SE. All rights reserved
 */
sap.ui.define(['sap/chart/library','sap/viz/ui5/controls/VizFrame','sap/viz/ui5/controls/common/BaseControl','sap/viz/ui5/data/Dataset','sap/viz/ui5/data/FlattenedDataset','sap/viz/ui5/data/DimensionDefinition','sap/viz/ui5/data/MeasureDefinition','sap/chart/data/Dimension','sap/chart/data/TimeDimension','sap/chart/data/Measure','sap/ui/model/analytics/ODataModelAdapter','sap/chart/utils/RoleFitter','sap/chart/utils/ChartUtils','sap/chart/utils/SeriesColorTracker','sap/chart/utils/ChartTypeAdapterUtils','sap/chart/utils/DateFormatUtil','sap/chart/utils/DataSourceUtils','sap/viz/ui5/controls/common/feeds/FeedItem','sap/ui/model/Filter','sap/ui/model/FilterOperator','sap/ui/model/analytics/odata4analytics','sap/ui/model/Sorter','sap/chart/TimeUnitType'],function(l,V,B,D,F,a,M,b,T,c,O,R,C,S,f,g,h,q,r,t,u,w,x){"use strict";var y=sap.chart.SelectionMode;var z=B.extend("sap.chart.Chart",{metadata:{library:"sap.chart",properties:{chartType:{type:"string",defaultValue:"bar"},uiConfig:{type:"object",group:"Misc"},visibleDimensions:{type:"string[]",defaultValue:[]},inResultDimensions:{type:"string[]",defaultValue:[]},visibleMeasures:{type:"string[]",defaultValue:[]},vizProperties:{type:"object",group:"Misc"},vizScales:{type:"object[]",group:"Misc"},isAnalytical:{type:"boolean"},selectionBehavior:{type:"string",defaultValue:"DATAPOINT"},selectionMode:{type:"string",defaultValue:sap.chart.SelectionMode.Multi},enablePagination:{type:"boolean",defaultValue:false}},aggregations:{data:{type:"sap.ui.core.Element",multiple:true,bindable:"bindable"},_vizFrame:{type:"sap.viz.ui5.controls.VizFrame",multiple:false,visibility:"hidden"},dimensions:{type:"sap.chart.data.Dimension",multiple:true},measures:{type:"sap.chart.data.Measure",multiple:true}},events:{drilledDown:{parameters:{dimensions:{type:"string[]"}}},drilledUp:{parameters:{dimensions:{type:"string[]"}}},renderComplete:{},selectData:{},deselectData:{}}},renderer:function(o,d){o.write("<div");o.writeControlData(d);o.addStyle("width",d.getWidth());o.addStyle("height",d.getHeight());o.writeStyles();o.write(">");o.renderControl(d.getAggregation("_vizFrame"));o.write("</div>");}});z.getMetadata().getAggregation("data")._doesNotRequireFactory=true;function A(v){return v.indexOf("%")!==-1?"100%":v;}z.prototype.setHeight=function(v){this.setProperty("height",v);var o=this._getVizFrame();if(o){o.setHeight(A(this.getProperty("height")));}return this;};z.prototype.setWidth=function(v){this.setProperty("width",v);var o=this._getVizFrame();if(o){o.setWidth(A(this.getProperty("width")));}return this;};z.prototype.setChartType=function(s,d){this.setProperty("chartType",s,d);this._bIsPagingChartType=C.CONFIG.pagingChartTypes.indexOf(s)>-1;if(this._isEnablePaging()){this._initPagination(true);}else{var o=this._getDataset();if(o){o.setPagingOption(null);}}this._invalidateBy({source:this,keys:{vizFrame:true}});this._bNeedToApplyDefaultProperties=true;return this;};z.prototype.removeDimension=function(d){if(this.getIsAnalytical()===false&&d&&d.getName()){var v=this._getVisibleDimensions()||[],i=v.indexOf(d.getName());if(i!==-1){jQuery.sap.log.error('Data source does not support aggregation. The method "removeDimension" therefore cannot be used!');return;}}var o=this.removeAggregation("dimensions",d);if(o){var v=this._getVisibleDimensions()||[],i=v.indexOf(o.getName());if(i!==-1){v.splice(i,1);this.setVisibleDimensions(v);}var e=this._getInResultFields()||[];i=e.indexOf(o.getName());if(i!==-1){e.splice(i,1);this.setInResultDimensions(e);}}return o;};z.prototype.removeAllDimensions=function(){var o;if(this.getIsAnalytical()===false){jQuery.sap.log.error('Data source does not support aggregation. The method "removeAllDimensions" therefore cannot be used!');}else{o=this.removeAllAggregation("dimensions");this.setVisibleDimensions([]);this.setInResultDimensions([]);}return o;};z.prototype.destroyDimensions=function(){var o;if(this.getIsAnalytical()===false){jQuery.sap.log.error('Data source does not support aggregation. The method "destroyDimensions" therefore cannot be used!');}else{o=this.destroyAggregation("dimensions");this.setVisibleDimensions([]);this.setInResultDimensions([]);}return o;};z.prototype.removeMeasure=function(m){var o=this.removeAggregation("measures",m);if(o){var v=this._getVisibleMeasures()||[],i=v.indexOf(o.getName());if(i!==-1){v.splice(i,1);this.setVisibleMeasures(v);}}return o;};z.prototype.removeAllMeasures=function(){var o=this.removeAllAggregation("measures");this.setVisibleMeasures([]);return o;};z.prototype.destroyMeasures=function(){var o=this.destroyAggregation("measures");this.setVisibleMeasures([]);return o;};z.prototype._getVisibleDimensions=function(n){var s=this._getDrillStateTop();var d=s?s.dimensions:this.getProperty("visibleDimensions");return n?this._normalizeDorM(d,true):d;};z.prototype.getVisibleDimensions=function(){var v=this._getVisibleDimensions();return this._aFeeds?v.filter(function(d){return this._aFeeds._unused.indexOf(d)===-1;},this):v;};z.prototype._getVisibleMeasures=function(n){var s=this._getDrillStateTop();var m=s?s.measures:this.getProperty("visibleMeasures");return n?this._normalizeDorM(m):m;};z.prototype.getVisibleMeasures=function(){var v=this._getVisibleMeasures();return this._aFeeds?v.filter(function(d){return this._aFeeds._unused.indexOf(d)===-1;},this):v;};z.prototype.setVisibleDimensions=function(v,s){var m=this._dimensionSanityCheck({visible:v});this.setProperty("visibleDimensions",v,s);this.setProperty("inResultDimensions",m.inResult,s);this._createDrillStack();this._invalidateBy({source:this,keys:{binding:true,dataSet:true,vizFrame:true}});return this;};z.prototype.setInResultDimensions=function(i,s){var m=this._dimensionSanityCheck({inResult:i});this.setProperty("inResultDimensions",i,s);this.setProperty("visibleDimensions",m.visible,s);this._createDrillStack();this._invalidateBy({source:this,keys:{binding:true,dataSet:true,vizFrame:true}});};z.prototype.setVisibleMeasures=function(m,s){this.setProperty("visibleMeasures",m,s);this._createDrillStack();this._invalidateBy({source:this,keys:{binding:true,dataSet:true,vizFrame:true}});return this;};z.prototype.setEnablePagination=function(e,s){if(!this._bIsInitialized){this.setProperty("enablePagination",e,s);this._invalidateBy({source:this,keys:{binding:true,dataSet:true,vizFrame:true,drillStack:true}});}};z.prototype._dimensionSanityCheck=function(d){var v=d.visible||this.getVisibleDimensions()||[],i=d.inResult||this.getInResultDimensions()||[];var s=[].concat(v).concat(i).reduce(function(m,e){var j=v.indexOf(e)!==-1,k=i.indexOf(e)!==-1;if(j&&k){m.common[e]=true;}else if(j){m.visible[e]=true;}else if(k){m.inResult[e]=true;}return m;},{visible:{},inResult:{},common:{}});s.visible=Object.keys(s.visible);s.inResult=Object.keys(s.inResult);s.common=Object.keys(s.common);return s;};z.prototype._getInResultFields=function(){var d=this,i=this.getInResultDimensions(),m=this._normalizeDorM(this._getVisibleMeasures(),false),U=m.reduce(function(U,o){var e=o.getUnitBinding();if(e&&U.indexOf(e)===-1&&d.getDimensionByName(e)&&i.indexOf(e)===-1){return U.concat(e);}else{return U;}},[]);return i.concat(U);};z.prototype._prepareFeeds=function(){if(!this._aFeeds){var d=this._normalizeDorM(this._getVisibleDimensions(),true),m=this._normalizeDorM(this._getVisibleMeasures(),false),i=this._normalizeDorM(this._getInResultFields(),true);this._sAdapteredChartType=this.getEnablePagination()?this.getChartType():f.adaptChartType(this.getChartType(),d);this._aFeeds=R.fit(this._sAdapteredChartType,d,m,i,"color",this._mDataTypes);if((!this._aFeeds._valid||this._aFeeds._unused.length)&&this._sAdapteredChartType!==this.getChartType()){this._sAdapteredChartType=this.getChartType();this._aFeeds=R.fit(this._sAdapteredChartType,d,m,i,"color",this._mDataTypes);}if(this._sAdapteredChartType!==this.getChartType()){this._bNeedToApplyDefaultProperties=true;}}return this._aFeeds;};z.prototype._normalizeDorM=function(m,i){var d=i?this.getDimensions():this.getMeasures(),e=d.reduce(function(k,p){k[p.getName()]=p;return k;},{}),j=i?b:c;var o=m.reduce(function(o,N){var s;if(typeof N==="string"){s=N;}else if(N instanceof j){s=N.getName();}else{o.errors.push(N);}if(e[s]){o.normalized.push(e[s]);}else{o.errors.push(N);}return o;},{normalized:[],errors:[]});var n=o.normalized;if(o.errors.length>0){n.errors=o.errors;}return n;};z.prototype._redundantsFromSelection=function(){var s=this._getVizFrame().vizSelection();if(!s||s.length===0){return{measureNames:{}};}var m=s.reduce(function(e,o){jQuery.each(o.data,function(k,v){if(!e[k]){e[k]=[];}if(e[k].indexOf(v)===-1){e[k].push(v);}});return e;},{});var d=this._getVisibleDimensions().reduce(function(e,i){var v=m[i];if(v.length===1){e[i]=v[0];}return e;},{});d.measureNames=this._getVisibleMeasures().reduce(function(e,i){if(!m[i]){e[i]=true;}return e;},{});return d;};z.prototype._deriveFilterFromSelection=function(){var v=this._getVisibleDimensions();var d=this;var e=this._getVizFrame().vizSelection().map(function(s){var o=v.reduce(function(j,k){var m=d.getDimensionByName(k);var n;n=s.data[k];if(C.CONFIG.timeChartTypes.indexOf(d._sAdapteredChartType)>-1&&m instanceof T){var p=g.getInstance(m.getTimeUnit());if(p){var N=p.format.bind(p);n=N(new Date(s.data[k]));}}j.filters.push(new r({path:k,operator:t.EQ,value1:n}));j.signature.push(k+"="+s.data[k]);return j;},{filters:[],signature:[]});o.signature=o.signature.join(";");return o;});var U=e.reduce(function(m,o){if(!m[o.signature]&&o.filters.length>0){m[o.signature]=new r(o.filters,true);}return m;},{});var i=Object.keys(U).map(function(k){return U[k];});if(i.length>1){return new sap.ui.model.Filter(i,false);}else if(i.length===1){return i[0];}else{return null;}};z.prototype._checkDrilldownValid=function(i){var v=this._getVisibleDimensions().concat(this._getInResultFields()).reduce(function(e,j){e[j]=true;return e;},{});if(i.some(function(o){return v[o.getName()];})){jQuery.sap.log.error("Drill down not possible, because one of the given dimensions is already drilled down!");return false;}var m=i.reduce(function(o,e){o[e.getName()]=e;return o;},{});function d(o){if(jQuery.isArray(o.aFilters)){return o.aFilters.some(d);}else{return!!m[o.sPath];}}var s=this._getDrillStateTop();if(s&&s.filter&&d(s.filter)){jQuery.sap.log.error("Drill down not possible, because one of the given dimensions is already filtered!");return false;}return true;};z.prototype._createDrillStack=function(){var v=this.getProperty("visibleDimensions")||[],d=this.getProperty("visibleMeasures")||[],s=[{dimensions:[],measures:d,filter:undefined}],e=[];for(var i=0;i<v.length;i++){e.push(v[i]);s.push({dimensions:e.slice(),measures:d,filter:undefined});}this._drillStateStack=s;};z.prototype._invalidateBy=function(o){var s=o.source;if(s===this){jQuery.each(o.keys||{},function(k,v){this._markForUpdate(k,v);}.bind(this));}else if(s instanceof c&&this._getVisibleMeasures().indexOf(s.getName())!==-1){this._markForUpdate("dataSet",true);this._markForUpdate("vizFrame",true);if(o.property==="unitBinding"){this._markForUpdate("binding",true);}}else if(s instanceof b&&this._getVisibleDimensions().indexOf(s.getName())!==-1){this._markForUpdate("dataSet",true);this._markForUpdate("vizFrame",true);if(s.getDisplayText()&&(o.property==="textProperty"||o.property==="displayText")){this._markForUpdate("binding",true);}}this.invalidate(o);};z.prototype._markForUpdate=function(k,n){if(!this._mNeedToUpdate){this._mNeedToUpdate={};}this._mNeedToUpdate[k]=n;var o=this._updaters.onInvalidate[k];if(o){o.call(this);}};z.prototype._updaters=(function(){return{onInvalidate:{vizFrame:function(){this._aFeeds=null;}},drillStack:function(){this._createDrillStack();},dataSet:function(){var d=this._getDataset();d.updateData.apply(d,arguments);},binding:function(){var o=this._getDataset().getBinding("data"),i=this._getInResultFields();if(!o){return;}if(this.getIsAnalytical()===false){var d=this;var v=this._getVisibleDimensions(),e=this._getVisibleMeasures(),j=this.getDimensions().map(function(N){return N.getName();});var k=[];e.forEach(function(N){if(d.getMeasureByName(N)){var P=d.getMeasureByName(N).getUnitBinding();if(P){k.push(P);}}});j.forEach(function(N){if(d.getDimensionByName(N)){var P=d.getDimensionByName(N).getTextProperty();if(P){k.push(P);}}});var m=v.concat(j.filter(function(N){return(v.indexOf(N)<0)&&(k.indexOf(N)<0)&&(i.indexOf(N)<0);}));this.setProperty("visibleDimensions",m);this._createDrillStack();}var n=this._getVisibleDimensions(true).concat(this._normalizeDorM(i,true));var p=this._getVisibleMeasures(true);h.updateModel(this.getIsAnalytical())(this,n,p);var s=this._getDrillStateTop();if(n.length>0||p.length>0){this._getVizFrame()._pendingDataRequest(true);this.setBusy(true);}o.filter((s&&s.filter)?s.filter:undefined);this._resetPagingOptions();},vizFrame:function(){var d=this,o=this._getDataset(),v=this._getVizFrame(),m=this._mMeasureRange||{};o.removeAllAggregation("dimensions",true);o.removeAllAggregation("measures",true);v.removeAllAggregation("feeds",true);var e=this._prepareFeeds();e._def.dim.forEach(function(i){o.addAggregation("dimensions",i,true);},this);e._def.msr.forEach(function(i){var j=m[i.getIdentity()];if(j){i.setRange([j.min,j.max]);}if(!d.getDimensionByName(i.getUnit())){i.setUnit(null);}o.addAggregation("measures",i,true);},this);e.forEach(function(i){v.addFeed(i);});o.setContext((e._context||[]).map(function(i){return{id:i,showInTooltip:true};}));v.invalidate();o.invalidate();v.setVizType(this._sAdapteredChartType);v.setVizProperties(this._getEffectiveProperties());}};})();z.prototype._getDrillStateTop=function(){return this._drillStateStack?this._drillStateStack[this._drillStateStack.length-1]:null;};z.prototype._getVizFrame=function(){return this.getAggregation("_vizFrame");};z.prototype._getDataset=function(){var v=this._getVizFrame();return v?v.getDataset():null;};z.prototype._bindingChangeListener=function(){var v=this._getVizFrame();v.invalidate();v.setVizProperties(this._getEffectiveProperties());this.setBusy(false);if(this._isEnablePaging()){if(this._bNeedTotal){this._initPagination();this._bNeedTotal=false;}else if(this._bNeedPaging){var d=v._states().plot.transform.translate.position;this._updatePage(d);}}else{this._mMeasureRange={};v._pendingDataRequest(false);v.invalidate();}};z.prototype._initPagination=function(n){var o=this.getBinding("data"),p;if(!o){return;}var i=o instanceof sap.ui.model.analytics.AnalyticalBinding?o.getTotalSize():o.getLength();if(i>=0){this._iTotalSize=i;if(this._iTotalSize>this._iPageSize*2){this._iMaxPageNo=Math.floor(this._iTotalSize/this._iPageSize)-1;this._iRemainingRecords=this._iTotalSize%this._iPageSize;this._bNeedPaging=true;this._iOffset=null;var d=this._iPageSize/this._iTotalSize;p={bEnabled:true,iStartIndex:0,iLength:this._iPageSize,sMode:"reset",thumbRatio:d,iPageNo:0};if(n){this._getVizFrame()._pendingDataRequest(false);}else{this._getVizFrame()._pendingDataRequest(true);this._queryMinMax(this._measureRangeReceivedHandler.bind(this));}}else{this._mMeasureRange={};this._bNeedPaging=false;p={bEnabled:false,iStartIndex:0,iLength:this._iTotalSize};this._getVizFrame()._pendingDataRequest(false);}this._getDataset().setPagingOption(p);}};z.prototype._resetPagingOptions=function(){var d=this;var o=this.getBinding("data");var e=this._getDataset();if(!e||!o){return;}if(this._isEnablePaging()){var i=this._prepareFeeds();i._order=i._order.filter(function(j){return j!=="MND"&&d.getDimensions().map(function(v){return v.getName();}).indexOf(j)>-1;});if(i._order.length){var s=this._aFeeds._order.map(function(P){return new w(P);});o.sort(s);}this._bNeedTotal=true;var p={bEnabled:false,iStartIndex:0,iLength:this._iPageSize*2,iPageNo:0};e.setPagingOption(p);this._oColorTracker.clear();this._getVizFrame()._runtimeScales(this._oColorTracker.get(),true);}else{e.setPagingOption(null);}this._mMeasureRange={};};z.prototype.addData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "addData" therefore cannot be used programmatically!');};z.prototype.destroyData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "destroyData" therefore cannot be used programmatically!');};z.prototype.getData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "getData" therefore cannot be used programmatically!');};z.prototype.indexOfData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "indexOfData" therefore cannot be used programmatically!');};z.prototype.insertData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "insertData" therefore cannot be used programmatically!');};z.prototype.removeData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "removeData" therefore cannot be used programmatically!');};z.prototype.removeAllData=function(){jQuery.sap.log.error('Chart manages the "data" aggregation only via data binding. The method "removeAllData" therefore cannot be used programmatically!');};z.prototype._createOData4SAPAnalyticsModel=function(m){var o=null;try{o=new u.Model(new u.Model.ReferenceByModel(m));}catch(e){return undefined;}return o;};z.prototype.getIsAnalytical=function(){return this.getProperty("isAnalytical");};z.prototype.setIsAnalytical=function(v,s){if(this._bIsInitialized){jQuery.sap.log.error('The proeprty isAnalytical will programmatically set according to data source. The method "setIsAnalytical" therefore cannot be used!');}else{this.setProperty("isAnalytical",v,s);}};z.prototype._setIsAnalyticalProperty=function(o,d){var v=o.findQueryResultByName(h.getEntitySet(this.getIsAnalytical())(d))!==undefined;if(this.getIsAnalytical()!==v){this.setProperty("isAnalytical",v);}};z.prototype.bindAggregation=function(n,o){if(n==="data"){var m=this.getModel(o.model);if(m){if(m instanceof sap.ui.model.json.JSONModel){if(this.getIsAnalytical()!==false){this.setProperty("isAnalytical",false);}else if(this.getEnablePagination()!==false){this.setProperty("enablePagination",false);}}else{var d=this._createOData4SAPAnalyticsModel(m);this._setIsAnalyticalProperty(d,o);}if(this.getIsAnalytical()){if(o){o.parameters=jQuery.extend(true,{},{analyticalInfo:[{name:""}],useBatchRequests:true,provideGrandTotals:false,provideTotalsResultSize:false,autoexpand:false,reloadSingleUnitMeasures:true,noPaging:true},o.parameters);if(this._isEnablePaging()){var p={noPaging:false};o.parameters=jQuery.extend(true,o.parameters,p);}}O.apply(m);if(d){m.setAnalyticalExtensions(d);}}}}return B.prototype.bindAggregation.apply(this,arguments);};z.prototype._bindAggregation=function(n,o){if(n==="data"){var m=this.getModel(o.model);if(m){if(m instanceof sap.ui.model.json.JSONModel){if(this.getIsAnalytical()!==false){this.setProperty("isAnalytical",false);}else if(this.getEnablePagination()!==false){this.setProperty("enablePagination",false);}}else{var d=this._createOData4SAPAnalyticsModel(m);this._setIsAnalyticalProperty(d,o);}if(this.getIsAnalytical()){if(o){o.parameters=jQuery.extend(true,{},{analyticalInfo:[{name:""}],useBatchRequests:true,provideGrandTotals:false,provideTotalsResultSize:false,autoexpand:false,reloadSingleUnitMeasures:true,noPaging:true},o.parameters);if(this._isEnablePaging()){var p={noPaging:false};o.parameters=jQuery.extend(true,o.parameters,p);}}O.apply(m);if(d){m.setAnalyticalExtensions(d);}}this._deriveColumns(m,o);}var e=this._getDataset(),i=e.getBinding("data");if(i){i.detachChange(this._bindingChangeListener,this);}e.bindAggregation("data",o);var N=e.getBinding("data");if(N){e.getBinding("data").attachChange(this._bindingChangeListener,this);}this._invalidateBy({source:this,keys:{binding:true,vizFrame:true}});}else{B.prototype._bindAggregation.apply(this,arguments);}};z.prototype.unbindAggregation=function(n,s){if(n==="data"){var d=this._getDataset();if(d){d.unbindAggregation.apply(d,arguments);}s=true;}return B.prototype.unbindAggregation.apply(this,[n,s]);};z.prototype.unbindData=function(){if(!this.getIsAnalytical()){this.removeAllAggregation("dimensions");this.removeAllAggregation("measures");this.setProperty("visibleDimensions",[]);this.setProperty("inResultDimensions",[]);this.setProperty("visibleMeasures",[]);this._createDrillStack();}this.unbindAggregation("data");};z.prototype._deriveColumns=function(m,o){var d=this.getAggregation("dimensions");var e=this.getAggregation("measures");if((d===null||d.length===0)&&(e===null||e.length===0)){var i=h.deriveColumns(this.getIsAnalytical())(m,o);i.dimensions.forEach(this.addDimension.bind(this));i.measures.forEach(this.addMeasure.bind(this));}};z.prototype.onBeforeRendering=function(){B.prototype.onBeforeRendering.apply(this,arguments);jQuery.each(this._updaters,function(k,d){if(this._mNeedToUpdate[k]){d.call(this);this._mNeedToUpdate[k]=false;}}.bind(this));};z.prototype.onAfterRendering=function(){this._showLoading(this._bLoading);};z.prototype.exit=function(){this._getDataset().unbindAggregation('data',true);B.prototype.exit.apply(this,arguments);var v=this._getVizFrame();if(this._delegateEventHandlers){this._delegateEventHandlers.forEach(function(o){v["detach"+o.name](o.handler,this);delete o.handler;},this);delete this._delegateEventHandlers;}v.detachRenderComplete(this._vizFrameRenderCompleteHandler,this);};z.prototype.applySettings=function(){sap.ui.core.Control.prototype.applySettings.apply(this,arguments);var d=new F();var e=jQuery.extend(true,{},{'applicationSet':'fiori'},this.getUiConfig());this.setUiConfig(e);this._bNeedToApplyDefaultProperties=true;var v=new V({width:A(this.getWidth()),height:A(this.getHeight()),vizType:this.getChartType(),uiConfig:this.getUiConfig(),vizProperties:jQuery.extend(true,{'title':{'visible':false}},this._getEffectiveProperties())});v.setDataset(d);v.attachRenderComplete(null,this._updateLoadingIndicator.bind(this));this._rendered=false;v.attachEventOnce("renderComplete",function(){this._rendered=true;},this);v._pendingDataRequest(true);this.setAggregation("_vizFrame",v);this._delegateEvents();this._bNeedTotal=true;this._bNeedPaging=false;this._iPageSize=500;this._oColorTracker=new S();this._sAdapteredChartType=this.getChartType();this._bIsInitialized=true;};z.prototype.resetLayout=function(){this._invalidateBy({source:this,keys:{binding:true,vizFrame:true,drillStack:true,dataSet:true}});return this;};var _=(function(){function m(k){return k.reduce(function(o,s){o[s]=true;return o;},{});}function d(v,k){var o=m(v);function p(s){return k.reduce(function(P,N){if(s.hasOwnProperty(N)){P[N]=s[N];}return P;},{});}return function(s,N){return s.filter(function(P){return o[P];}).map(function(P){var Q=p(N);Q[P]="*";return{data:Q};});};}function e(v,k){var o=m(v);return function(p){return{index:p._context_row_number,measures:Object.keys(p).filter(function(s){return o[s];})};};}function i(o){var p={data:{}},s=o.measures,N=o.dimensions;if(s){p.data.measureNames=(s instanceof Array)?{"in":s}:s;}jQuery.each(N||{},function(k,v){p.data[k]=(v instanceof Array)?{"in":v}:v;});return p;}function j(o){var p=o.data;return Object.keys(p).reduce(function(s,k){var v=p[k];if(v.in&&v.in instanceof Array){v=v.in;}if(k==="measureNames"){s.measures=v;}else if(!s.dimensions){s.dimensions={};s.dimensions[k]=v;}else{s.dimensions[k]=v;}return s;},{});}function n(v,k,o,p){var s=d(v,k);return p.reduce(function(N,P){var Q=o.getContexts(P.index,1);if(Q.length>0){N=N.concat(s(P.measures,Q[0].getObject()));}return N;},[]);}return{makeLookUp:m,toVizCtx:d,fromVizCtx:e,toVizCSCtx:i,fromVizCSCtx:j,buildSelectionVizCtx:n,match:function(o,v,p){return Object.keys(o).every(function(k){if(p.indexOf(k)!==-1){return v.hasOwnProperty(k);}else{return o[k]===v[k];}});}};})();z.prototype.setSelectedDataPoints=function(d){if(this.getSelectionMode()!==y.None){var o=this.getBinding("data"),v=this._getVizFrame();if(!o||!v||this.getSelectionBehavior().toUpperCase()!=="DATAPOINT"){return this;}v.vizSelection([],{clearSelection:true});var m=this._getVisibleMeasures(),e=this._getVisibleDimensions().concat(this._getInResultFields());v.vizSelection(_.buildSelectionVizCtx(m,e,o,d),{selectionMode:this.getSelectionMode()});}return this;};z.prototype.addSelectedDataPoints=function(d){if(this.getSelectionMode()!==y.None){var o=this.getBinding("data"),v=this._getVizFrame();if(!o||!v||this.getSelectionBehavior().toUpperCase()!=="DATAPOINT"){return this;}v.vizSelection(_.buildSelectionVizCtx(this._getVisibleMeasures(),this._getVisibleDimensions(),o,d),{selectionMode:y.Multi});}return this;};z.prototype.getSelectedDataPoints=function(){var v=this._getVizFrame();if(!v||this.getSelectionBehavior().toUpperCase()!=="DATAPOINT"){return{count:0,dataPoints:[]};}var d=_.fromVizCtx(this._getVisibleMeasures(),this._getVisibleDimensions());var s=v.vizSelection(),m=s.map(function(n){return n.data;}).map(d).reduce(function(e,i){var j=i.index;e[j]=jQuery.extend(true,e[j]||{},_.makeLookUp(i.measures));return e;},{});var o=this._getDataset();return{count:s.length,dataPoints:Object.keys(m).map(function(i){var e=parseInt(i,10);return{index:e,measures:Object.keys(m[i]),context:o.findContext({"_context_row_number":e})};})};};z.prototype.removeSelectedDataPoints=function(d){if(this.getSelectionMode()!==y.None){var o=this.getBinding("data"),v=this._getVizFrame();if(!v||this.getSelectionBehavior().toUpperCase()!=="DATAPOINT"){return this;}var e=this._getVisibleMeasures();var i=this._getVisibleDimensions();var j=_.buildSelectionVizCtx(e,i,o,d);v.vizSelection(j,{deselection:true});}return this;};z.prototype.setSelectedCategories=function(d){if(this.getSelectionMode()!==y.None){var v=this._getVizFrame(),s=this.getSelectionBehavior().toUpperCase();if(!v||s!=="CATEGORY"){return this;}v.vizSelection([],{clearSelection:true});v.vizSelection(d.map(_.toVizCSCtx),{selectionMode:this.getSelectionMode()});}return this;};z.prototype.addSelectedCategories=function(d){if(this.getSelectionMode()!==y.None){var v=this._getVizFrame(),s=this.getSelectionBehavior().toUpperCase();if(!v||s!=="CATEGORY"){return this;}v.vizSelection(d.map(_.toVizCSCtx),{selectionMode:y.Multi});}return this;};z.prototype.removeSelectedCategories=function(d){if(this.getSelectionMode()!==y.None){var v=this._getVizFrame(),s=this.getSelectionBehavior().toUpperCase();if(!v||s!=="CATEGORY"){return this;}v.vizSelection(d.map(_.toVizCSCtx),{deselection:true});}return this;};z.prototype.getSelectedCategories=function(){var v=this._getVizFrame(),s=this.getSelectionBehavior().toUpperCase();if(!v||s!=="CATEGORY"){return{count:0,categories:[]};}else{var d=v.vizSelection();return{count:d.length,categories:(d.category||[]).map(_.fromVizCSCtx)};}};z.prototype.setSelectedSeries=function(s){if(this.getSelectionMode()!==y.None){var v=this._getVizFrame(),d=this.getSelectionBehavior().toUpperCase();if(!v||d!=="SERIES"){return this;}v.vizSelection([],{clearSelection:true});v.vizSelection(s.map(_.toVizCSCtx),{selectionMode:this.getSelectionMode()});}return this;};z.prototype.addSelectedSeries=function(s){if(this.getSelectionMode()!==y.None){var v=this._getVizFrame(),d=this.getSelectionBehavior().toUpperCase();if(!v||d!=="SERIES"){return this;}v.vizSelection(s.map(_.toVizCSCtx),{selectionMode:y.Multi});}return this;};z.prototype.removeSelectedSeries=function(s){if(this.getSelectionMode()!==y.None){var v=this._getVizFrame(),d=this.getSelectionBehavior().toUpperCase();if(!v||d!=="SERIES"){return this;}v.vizSelection(s.map(_.toVizCSCtx),{deselection:true});}return this;};z.prototype.getSelectedSeries=function(){var v=this._getVizFrame(),s=this.getSelectionBehavior().toUpperCase();if(!v||s!=="SERIES"){return{count:0,series:[]};}else{var d=v.vizSelection();return{count:d.length,series:(d.series||[]).map(_.fromVizCSCtx)};}};z.prototype.drillDown=function(d){if(this.getIsAnalytical()===false){jQuery.sap.log.error('Data source does not support drillDown/drillUp. The method "drillDown" therefore cannot be used!');return;}if(d&&!(d instanceof Array)){d=[d];}var e=this._normalizeDorM(d,true);if(e.length===0){return;}if(!this._checkDrilldownValid(e)){jQuery.sap.log.warning("Drill down not possible for "+e+". Already drilled down.");return;}var s=this._getDrillStateTop(),m=this._redundantsFromSelection(),o=this._deriveFilterFromSelection();var n;if(o){n=!(s&&s.filter)?o:new r([o,s.filter],true);}this._drillStateStack.push({dimensions:s.dimensions.slice().concat(e.map(function(j){return j.getName();})).filter(function(j){return!m[j];}),measures:s.measures.filter(function(j){return!m.measureNames[j];}),filter:n,redundant:m});var i=e.map(function(j){return j.getName();});this.fireDrilledDown({dimensions:i});this._invalidateBy({source:this,keys:{binding:true,vizFrame:true}});};z.prototype.drillUp=function(i){if(this.getIsAnalytical()===false){jQuery.sap.log.error('Data source does not support drillDown/drillUp. The method "drillUp" therefore cannot be used!');return;}if(arguments.length===0){i=this._drillStateStack.length-2;}var n=this._drillStateStack[i];if(n&&i!=this._drillStateStack.length-1){var p=this._drillStateStack.pop();this._drillStateStack.splice(i+1);this.fireDrilledUp({dimensions:p.dimensions.filter(function(d){return n.dimensions.indexOf(d)===-1;})});this._invalidateBy({source:this,keys:{binding:true,vizFrame:true}});}};z.prototype.getDrillStack=function(){if(this.getIsAnalytical()===false){jQuery.sap.log.error('Data source does not support drillDown/drillUp. The method "getDrillStack" therefore cannot be used!');return;}return jQuery.map(this._drillStateStack||[],function(s,i){return{dimension:s.dimensions.slice(),measure:s.measures.slice(),filter:s.filter};});};z.prototype.setUiConfig=function(U){this.setProperty("uiConfig",U);if(this._getVizFrame()){this._getVizFrame().setUiConfig(U);}};var E=(function(){var d=["interaction.selectability.mode","interaction.selectability.behavior"];function e(o,p){var i=o,v;v=p.reduce(function(k,m){if(i.hasOwnProperty(m)){k.push({parent:i,val:i[m],key:m});i=i[m];}return k;},[]);if(v.length!==p.length){return;}var j=v.pop();delete j.parent[j.key];while(v.length>0){j=v.pop();if(Object.keys(j.val).length>0){return;}else{delete j.parent[j.key];}}}function s(v,i){var o=jQuery.extend(true,{},v);d.forEach(function(p){delete o[p];e(o,p.split("."));});return o;}return{sanitize:s,modify:function(p,k,i){var P=k.split("."),n=p;while(P.length>1&&n.hasOwnProperty(P[0])){n=n[P.shift()];}var j=P[0];if(P.length===1&&n.hasOwnProperty(j)){n[j]=i(n[j]);}}};})();z.prototype.setVizProperties=function(v){v=E.sanitize(v);this.setProperty("vizProperties",v);if(this._getVizFrame()){this._getVizFrame().setVizProperties(this._getEffectiveProperties());}};z.prototype.getVizProperties=function(){var o=this._getVizFrame();var d=E.sanitize(o?o.getVizProperties():this.getProperty("vizProperties"));function s(e){var i=sap.viz.api.env.Format.numericFormatter();if(!i||jQuery.type(i.stripUnit)!=="function"){return e;}if(jQuery.type(e)==="string"){return i.stripUnit(e);}else if(jQuery.type(e)==="object"){jQuery.each(e,function(k,v){e[k]=i.stripUnit(v);});return e;}else{return e;}}E.modify(d,"plotArea.dataLabel.formatString",s);E.modify(d,"tooltip.formatString",s);return d;};z.prototype.setVizScales=function(v){this.setProperty("vizScales",v);if(this._getVizFrame()){this._getVizFrame().setVizScales(v);}};z.prototype.getVizScales=function(){var v=this._getVizFrame();return v?v.getVizScales():this.getProperty("vizScales");};z.prototype.getVizUid=function(){return this._getVizFrame().getVizUid();};z.prototype.zoom=function(o){this._getVizFrame().zoom(o);};var G=["selectData","deselectData"];z.prototype._delegateEvents=function(){if(this._delegateEventHandlers){return;}var v=this._getVizFrame();this._delegateEventHandlers=G.map(function(e){var n=e.charAt(0).toUpperCase()+e.slice(1);var d=function(o){var p=o.getParameters();delete p.id;this.fireEvent(e,p);};d=d.bind(this);v["attach"+n](null,d);return{name:n,handler:d};},this);this._vizFrameRenderCompleteHandler=L.bind(this);v.attachRenderComplete(null,this._vizFrameRenderCompleteHandler);v.attachEvent("_scroll",K.bind(this));};z.getChartTypes=sap.chart.api.getChartTypes;z.prototype.getAvailableChartTypes=function(){var d=this._getVisibleDimensions(true),m=this._getVisibleMeasures(true);return C.CONFIG.chartTypes.reduce(function(o,s){var e=R.compatible(s,d,m);if(e.compatible){o.available.push({chart:s});}else{var i={};if(e.error.missing.dim){i.Dimension=e.error.missing.dim;}if(e.error.missing.time){i.DateTimeDimension=e.error.missing.time;}if(e.error.missing.msr){i.Measure=e.error.missing.msr;}o.unavailable.push({chart:s,error:i});}return o;},{available:[],unavailable:[]});};z.prototype._getEffectiveProperties=function(){var d=this.getBinding("data");var v={};if(this._bNeedToApplyDefaultProperties){v=jQuery.extend(true,v,this._getDefaultVizProperties());this._bNeedToApplyDefaultProperties=false;}v=jQuery.extend(true,v,this.getProperty("vizProperties"),this._getHostedVizProperties(),this._getPagingVizProperties());var e=function(o){if((typeof(o)==='undefined')||(o===null)){return false;}return true;};if((d!==undefined)&&v.plotArea&&v.plotArea.dataPointStyle&&v.plotArea.dataPointStyle.rules){var k=d instanceof sap.ui.model.analytics.AnalyticalBinding?d.getTotalSize():d.getLength();var m=d.getContexts(0,k);if(k>0&&!m.hasOwnProperty("dataRequested")){var n=this.getVisibleDimensions(),p=v.plotArea.dataPointStyle.rules;for(var i=0;i<p.length;i++){var s=p[i].dataContext;if(s&&s.length!==0){var N=Object.keys(s);if(!e(p[i].displayName)&&N.length===1){var P=N[0];if(s[P].hasOwnProperty("equal")&&n.indexOf(P)!==-1){var Q=this.getDimensionByName(P).getTextProperty();for(var j=0;j<k;j++){if(m[j].getProperty(P)===s[P].equal){var U=m[j].getProperty(Q);if(!e(Q)||!e(U)||typeof(U)==="object"||this.getDimensionByName(P).getDisplayText()===false){p[i].displayName=s[P].equal;break;}else{p[i].displayName=U;break;}}}}}}}}}return v;};z.prototype._hostedVizProperties={selectionMode:{prop:"interaction.selectability.mode"},selectionBehavior:{prop:"interaction.selectability.behavior"}};z.prototype._getHostedVizProperties=function(){return Object.keys(this._hostedVizProperties).reduce(function(o,p){var s=this._hostedVizProperties[p].prop.split(".").reverse().reduce(function(o,d){var e={};e[d]=o;return e;},this.getProperty(p));return jQuery.extend(true,o,s);}.bind(this),{});};var H="__UI5__ShortIntegerMaxFraction10";var I="__UI5__FloatMaxFraction2";var J="__UI5__ShortIntegerMaxFraction2";z.prototype._getDefaultVizProperties=function(){var d='info/'+(this._sAdapteredChartType||this.getChartType());var i=(d.indexOf("info/100_")===0);var j=(d==="info/pie"||d==="info/donut");var o={interaction:{extraEventInfo:true}};return jQuery.extend(true,o,m({},d,["valueAxis.label.formatString","valueAxis2.label.formatString"],i?'':H),m({},d,["legend.formatString","sizeLegend.formatString"],J),m({},d,["plotArea.dataLabel.formatString"],j?'':J),m({},d,["tooltip.formatString"],i?'':I));function s(e,n,v){if(n.length===0){return v;}e=e||{};var p=e[n[0]];e[n[0]]=s(p,n.slice(1),v);return e;}function k(p,n){if(p==null||n.legnth===0){return p;}var e=p[n[0]];if(e&&e.children){return k(e.children,n.slice(1));}return e;}function m(e,n,v,N){var P=sap.viz.api.metadata.Viz.get(n);if(P){var Q=P.properties;v.forEach(function(U){U=U.split(".");var p=k(Q,U);if(p&&p.hasOwnProperty("defaultValue")){s(e,U,N);}});}return e;}};z.prototype._getPagingVizProperties=function(){if(this._isEnablePaging()){var p={interaction:{zoom:{enablement:false},selectability:{mode:"NONE"}},plotArea:{isFixedDataPointSize:true}};return p;}else{return{};}};z.prototype.setSelectionMode=C.hostVizPropertySetter("selectionMode","interaction.selectability.mode",{convert:function(s){return s?s.toUpperCase():s;},validate:function(s){return[y.Multi,y.Single,y.None].indexOf(s)!==-1&&!this.getEnablePagination();}});z.prototype.getSelectionMode=C.hostVizPropertyGetter("selectionMode","interaction.selectability.mode");z.prototype.setSelectionBehavior=C.hostVizPropertySetter("selectionBehavior","interaction.selectability.behavior",{convert:function(s){return s?s.toUpperCase():s;},validate:function(s){return["DATAPOINT","CATEGORY","SERIES"].indexOf(s)!==-1;}});z.prototype.getSelectionBehavior=C.hostVizPropertyGetter("selectionBehavior","interaction.selectability.behavior");z.prototype.getDimensionByName=function(n){return this.getDimensions().filter(function(d){return d.getName()===n;})[0];};z.prototype.getMeasureByName=function(n){return this.getMeasures().filter(function(m){return m.getName()===n;})[0];};z.prototype.getTimeDimensions=function(){return this.getDimensions().filter(function(d){return d instanceof T;});};function K(e){if(this._isEnablePaging()&&this._bNeedPaging){var d=e.getParameters().position;this._updatePage(d);}}z.prototype._isEnablePaging=function(){this._bMobile=sap.ui.Device.system.tablet||sap.ui.Device.system.phone;var d=this.getEnablePagination()&&this._bIsPagingChartType&&!this._bMobile;return d;};z.prototype._updatePage=function(d){var v=this._getVizFrame();var i=Math.floor(this._iTotalSize*d/this._iPageSize);i=Math.min(i,this._iMaxPageNo);this._iOffset=null;var s=Math.max((i-1)*this._iPageSize,0);var e,j;if(i===0){e=this._iPageSize;j=this._iPageSize;}else if(i===this._iMaxPageNo){e=this._iPageSize*2+this._iRemainingRecords;j=this._iPageSize+this._iRemainingRecords;}else{e=this._iPageSize*2;j=this._iPageSize;}this._iOffset=(this._iTotalSize*d-i*this._iPageSize)/j;var o=this._getDataset();if(o.getRenderedPageNo()===i){var k={plot:{transform:{translate:{translateByPage:{context:this._middleCtx,offset:this._iOffset}}}}};v._states(k);this._showLoading(false);}else{if(this._pagingTimer){jQuery.sap.clearDelayedCall(this._pagingTimer);}this._pagingTimer=jQuery.sap.delayedCall(50,this,function(){var m=this.getBinding("data").getContexts(s,e),n;if(m.dataRequested){n=true;}else{n=m.some(function(N){return N===undefined;});}if(n){o.suppressInvalidate();}else{var p={bEnabled:true,iStartIndex:s,iLength:e,sMode:"update",thumbRatio:null,iPageNo:i};o.setPagingOption(p);o.updateData();v.invalidate();this._oColorTracker.add(this._getVizFrame()._runtimeScales());this._getVizFrame()._runtimeScales(this._oColorTracker.get(),true);}});this._sLoadingTimer=this._sLoadingTimer||jQuery.sap.delayedCall(200,this,function(){this._showLoading(true);});}};function L(e){var p=e.getParameters();delete p.id;if(this._isEnablePaging()&&this._bNeedPaging){if(this._sLoadingTimer){jQuery.sap.clearDelayedCall(this._sLoadingTimer);this._sLoadingTimer=null;}var v=this._getVizFrame();var o=this.getBinding("data");var d=this._getDataset();var i=d.getRenderedPageNo();if(i!==0){var m=i*this._iPageSize-1;this._middleCtx=o.getContexts(m,1)[0].getObject();}else{this._middleCtx=null;}if(this._middleCtx||this._iOffset){var j={plot:{transform:{translate:{translateByPage:{context:this._middleCtx,offset:this._iOffset}}}}};v._states(j);}this._showLoading(false);}this.fireEvent("renderComplete",p);}z.prototype._showLoading=function(d){var $=this.$();if(!$){return;}if(!d){if(this._$loadingIndicator){this._$loadingIndicator.remove();}}else{if(!this._$loadingIndicator){this._$loadingIndicator=this._createLoadingIndicator();}this._updateLoadingIndicator();$.append(this._$loadingIndicator);}this._bLoading=d;};z.prototype._createLoadingIndicator=function(){var $=jQuery(sap.ui.core.BusyIndicatorUtils.getElement());var d=jQuery("<p>").attr("class","loading-text").text("Loading");d.css({"position":"absolute","transform":"translateY(-3em)","width":"100%","text-align":"center"});d.insertBefore($.children()[0]);$.css({opacity:1});return $;};z.prototype._updateLoadingIndicator=function(){var $=this.$();if(!$||!this._$loadingIndicator){return;}var s=this._sAdapteredChartType,d=s==="bar"||s.indexOf("horizontal")!==-1;var e=$.find(".v-plot-bound"),o=$.offset(),p={top:o.top,left:o.left,width:$.width(),height:$.height()};if(e.length){var P=e.offset(),i=e[0].getBoundingClientRect();p.top=P.top-1;p.left=P.left;p.width=i.width+1;if(d){p.height=Math.ceil(i.height+1);}else{p.height=Math.floor(i.height+1);}}this._$loadingIndicator.css(p);var j=this._$loadingIndicator.find(".loading-text");j.css({"top":p.height/2,"font-weight":sap.ui.core.theming.Parameters.get("sapUiChartTitleFontWeight"),"font-size":sap.ui.core.theming.Parameters.get("sapUiChartMainTitleFontSize"),"color":sap.ui.core.theming.Parameters.get("sapUiChartMainTitleFontSize")});this._$loadingIndicator.css({"background-color":sap.ui.core.theming.Parameters.get("sapUiExtraLightBG")});};z.prototype._getRequiredDimensions=function(){var v=this._getVisibleDimensions(),i=this._getInResultFields();return this._normalizeDorM(v.concat(i),true);};z.prototype._getRequiredMeasures=function(){return this._getVisibleMeasures(true);};z.prototype._queryMinMax=function(d){var e=this._getRequiredDimensions().map(function(v){return v.getName();}),m=this._getRequiredMeasures().map(function(v){return v.getName();});var o=m.reduce(function(o,v){o[v]={min:{},max:{}};return o;},{});function i(){var v=m.every(function(N){return o[N].min.requested&&o[N].max.requested;});if(v){d(o);}}function j(v,N,P){o[v][N].requested=true;o[v][N].value=parseFloat(P&&P.results[0][v]);i();}function k(v,N,P){o[v][N].requested=true;o[v][N].error=P;i();}var Q=m.reduce(function(Q,v){return Q.concat({urlParameters:{"$select":e.concat(v).join(","),"$top":1,"$orderby":v+" asc"},success:j.bind(null,v,"min"),error:k.bind(null,v,"min")},{urlParameters:{"$select":e.concat(v).join(","),"$top":1,"$orderby":v+" desc"},success:j.bind(null,v,"max"),error:k.bind(null,v,"max")});},[]);var n=this.getBinding("data"),p=n.getPath(),s=n.getModel();Q.forEach(function(v){s.read(p,v);});return Q;};z.prototype._measureRangeReceivedHandler=function(Q){var m={};jQuery.each(Q,function(s,o){m[s]={min:o.min.value,max:o.max.value};});this._mMeasureRange=m;var v=this._getVizFrame();v._pendingDataRequest(false);this._invalidateBy({source:this,keys:{vizFrame:true}});this.setBusy(false);};z.prototype.exportToSVGString=function(o){var s="<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"100%\" height=\"100%\"/>",v=this._getVizFrame();if(v){s=v.exportToSVGString(o);}return s;};return z;});
